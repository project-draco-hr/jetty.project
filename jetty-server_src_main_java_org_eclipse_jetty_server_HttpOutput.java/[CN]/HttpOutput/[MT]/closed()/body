{
  loop:   while (true) {
    OutputState state=_state.get();
switch (state) {
case CLOSED:
      break loop;
case UNREADY:
    throw new WritePendingException();
default :
  if (_state.compareAndSet(state,OutputState.CLOSED)) {
    try {
      _channel.getResponse().closeOutput();
    }
 catch (    IOException e) {
      LOG.debug(e);
      _channel.failed();
    }
    releaseBuffer();
    return;
  }
}
}
}
