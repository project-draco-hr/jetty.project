{
  loop:   while (true) {
    OutputState state=_state.get();
    if (_onError != null) {
switch (state) {
case CLOSED:
case ERROR:
        _onError=null;
      break loop;
default :
    if (_state.compareAndSet(state,OutputState.ERROR)) {
      Throwable th=_onError;
      _onError=null;
      LOG.debug("onError",th);
      _writeListener.onError(th);
      close();
      break loop;
    }
}
continue loop;
}
switch (_state.get()) {
case READY:
case CLOSED:
try {
  _writeListener.onWritePossible();
  break loop;
}
 catch (Throwable e) {
  _onError=e;
}
break;
default :
}
}
}
