{
  OutputState state=_state.get();
  while (state != OutputState.CLOSED) {
    if (_state.compareAndSet(state,OutputState.CLOSED)) {
      try {
        if (BufferUtil.hasContent(_aggregate))         _channel.write(_aggregate,!_channel.getResponse().isIncluding());
 else         _channel.write(BufferUtil.EMPTY_BUFFER,!_channel.getResponse().isIncluding());
      }
 catch (      IOException e) {
        LOG.debug(e);
        _channel.failed();
      }
      releaseBuffer();
      return;
    }
    state=_state.get();
  }
}
