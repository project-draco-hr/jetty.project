{
  if (_closed)   throw new EOFException();
  if (_aggregate == null) {
    int size=getBufferSize();
    if (len > size / 2) {
      _channel.write(ByteBuffer.wrap(b,off,len),false);
      _written+=len;
      return;
    }
    _aggregate=_channel.getByteBufferPool().acquire(size,false);
  }
  int space=BufferUtil.space(_aggregate);
  if (len > space) {
    if (BufferUtil.hasContent(_aggregate)) {
      _channel.write(_aggregate,false);
      space=BufferUtil.space(_aggregate);
    }
  }
  if (len > space) {
    _channel.write(ByteBuffer.wrap(b,off,len),false);
    _written+=len;
    return;
  }
  BufferUtil.append(_aggregate,b,off,len);
  _written+=len;
  if (!checkAllWritten() && BufferUtil.isFull(_aggregate)) {
    _channel.write(_aggregate,false);
  }
}
