{
  if (isClosed())   throw new EOFException("Closed:" + System.identityHashCode(this));
  _written+=len;
  boolean complete=_channel.getResponse().isAllContentWritten(_written);
  int capacity=getBufferSize();
  if (!complete && len <= capacity / 4) {
    if (_aggregate == null)     _aggregate=_channel.getByteBufferPool().acquire(capacity,false);
    int filled=BufferUtil.fill(_aggregate,b,off,len);
    if (!complete && filled == len && !BufferUtil.isFull(_aggregate))     return;
    off+=filled;
    len-=filled;
  }
  if (BufferUtil.hasContent(_aggregate)) {
    _channel.write(_aggregate,complete && len == 0);
    if (len > 0 && !complete && len <= _aggregate.capacity() / 4) {
      BufferUtil.append(_aggregate,b,off,len);
      return;
    }
  }
  if (len > 0)   _channel.write(ByteBuffer.wrap(b,off,len),complete);
 else   if (complete)   _channel.write(BufferUtil.EMPTY_BUFFER,complete);
  if (complete)   closed();
}
