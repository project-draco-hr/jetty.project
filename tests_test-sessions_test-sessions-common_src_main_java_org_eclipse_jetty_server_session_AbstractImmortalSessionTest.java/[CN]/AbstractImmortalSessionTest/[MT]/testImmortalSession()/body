{
  String contextPath="";
  String servletMapping="/server";
  int scavengePeriod=2;
  AbstractTestServer server=createServer(0,-1,scavengePeriod);
  server.addContext(contextPath).addServlet(TestServlet.class,servletMapping);
  server.start();
  int port=server.getPort();
  try {
    HttpClient client=new HttpClient();
    client.start();
    try {
      int value=42;
      Future<ContentResponse> future=client.GET("http://localhost:" + port + contextPath+ servletMapping+ "?action=set&value="+ value);
      ContentResponse response=future.get();
      assertEquals(HttpServletResponse.SC_OK,response.getStatus());
      String sessionCookie=response.getHeaders().getStringField("Set-Cookie");
      assertTrue(sessionCookie != null);
      sessionCookie=sessionCookie.replaceFirst("(\\W)(P|p)ath=","$1\\$Path=");
      String resp=response.getContentAsString();
      assertEquals(resp.trim(),String.valueOf(value));
      Thread.sleep(scavengePeriod * 2500L);
      Request request=client.newRequest("http://localhost:" + port + contextPath+ servletMapping+ "?action=get");
      request.header("Cookie",sessionCookie);
      future=request.send();
      response=future.get();
      assertEquals(HttpServletResponse.SC_OK,response.getStatus());
      resp=response.getContentAsString();
      assertEquals(String.valueOf(value),resp.trim());
    }
  finally {
      client.stop();
    }
  }
  finally {
    server.stop();
  }
}
