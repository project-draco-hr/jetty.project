{
  int start=-1;
  State startState=null;
  try {
    if (_state == State.END)     return false;
    if (_state == State.CONTENT && _contentPosition == _contentLength) {
      _state=State.END;
      if (_handler.messageComplete(_contentPosition))       return true;
    }
    byte ch;
    int length=-1;
    boolean at_next=false;
    while (_state.ordinal() < State.END.ordinal() && buffer.hasRemaining() && !at_next) {
      ch=buffer.get();
      if (_eol == HttpTokens.CARRIAGE_RETURN && ch == HttpTokens.LINE_FEED) {
        _eol=HttpTokens.LINE_FEED;
        continue;
      }
      _eol=0;
switch (_state) {
case START:
        _contentLength=HttpTokens.UNKNOWN_CONTENT;
      _header=null;
    if (ch > HttpTokens.SPACE || ch < 0) {
      start=buffer.position() - 1;
      startState=_state;
      _state=_requestHandler != null ? State.METHOD : State.RESPONSE_VERSION;
    }
  break;
case METHOD:
if (ch == HttpTokens.SPACE) {
  HttpMethod method=HttpMethod.CACHE.get(buffer,start,buffer.position() - start - 1);
  _field0=method == null ? BufferUtil.toString(buffer,start,buffer.position() - start - 1,StringUtil.__ISO_8859_1_CHARSET) : method.toString();
  _state=State.SPACE1;
}
 else if (ch < HttpTokens.SPACE && ch >= 0) {
  throw new HttpException(HttpStatus.BAD_REQUEST_400);
}
break;
case RESPONSE_VERSION:
if (ch == HttpTokens.SPACE) {
HttpVersion v=HttpVersion.CACHE.get(buffer,start,buffer.position() - start - 1);
_field0=v == null ? BufferUtil.toString(buffer,start,buffer.position() - start - 1,StringUtil.__ISO_8859_1_CHARSET) : v.toString();
start=-1;
_persistent=HttpVersion.HTTP_1_1 == v;
_state=State.SPACE1;
}
 else if (ch < HttpTokens.SPACE && ch >= 0) {
throw new HttpException(HttpStatus.BAD_REQUEST_400);
}
break;
case SPACE1:
if (ch > HttpTokens.SPACE || ch < 0) {
if (_responseHandler != null) {
_state=State.STATUS;
_responseStatus=ch - '0';
}
 else {
start=buffer.position() - 1;
startState=_state;
_state=State.URI;
}
}
 else if (ch < HttpTokens.SPACE) {
throw new HttpException(HttpStatus.BAD_REQUEST_400);
}
break;
case STATUS:
if (ch == HttpTokens.SPACE) {
_state=State.SPACE2;
}
 else if (ch >= '0' && ch <= '9') {
_responseStatus=_responseStatus * 10 + (ch - '0');
}
 else if (ch < HttpTokens.SPACE && ch >= 0) {
at_next|=_responseHandler.startResponse(_field0,_responseStatus,null);
_eol=ch;
_state=State.HEADER;
_field0=_field1=null;
}
 else {
throw new IllegalStateException();
}
break;
case URI:
if (ch == HttpTokens.SPACE) {
_field1=BufferUtil.toString(buffer,start,buffer.position() - start - 1,StringUtil.__UTF8_CHARSET);
start=-1;
_state=State.SPACE2;
}
 else if (ch < HttpTokens.SPACE && ch >= 0) {
_field1=BufferUtil.toString(buffer,start,buffer.position() - start - 1,StringUtil.__UTF8_CHARSET);
start=-1;
at_next|=_requestHandler.startRequest(_field0,_field1,null);
_persistent=false;
_state=State.SEEKING_EOF;
at_next|=_handler.headerComplete();
at_next|=_handler.messageComplete(_contentPosition);
}
break;
case SPACE2:
if (ch > HttpTokens.SPACE || ch < 0) {
start=buffer.position() - 1;
startState=_state;
_state=_requestHandler != null ? State.REQUEST_VERSION : State.REASON;
}
 else if (ch < HttpTokens.SPACE) {
if (_responseHandler != null) {
at_next|=_responseHandler.startResponse(_field0,_responseStatus,null);
_eol=ch;
_state=State.HEADER;
_field0=_field1=null;
}
 else {
at_next|=_requestHandler.startRequest(_field0,_field1,null);
_persistent=false;
_state=State.SEEKING_EOF;
at_next|=_handler.headerComplete();
at_next|=_handler.messageComplete(_contentPosition);
}
}
break;
case REQUEST_VERSION:
if (ch == HttpTokens.CARRIAGE_RETURN || ch == HttpTokens.LINE_FEED) {
HttpVersion v=HttpVersion.CACHE.get(buffer,start,buffer.position() - start - 1);
String version=v == null ? BufferUtil.toString(buffer,start,buffer.position() - start - 1,StringUtil.__ISO_8859_1_CHARSET) : v.toString();
start=-1;
at_next|=_requestHandler.startRequest(_field0,_field1,version);
_eol=ch;
_persistent=HttpVersion.HTTP_1_1 == v;
_state=State.HEADER;
_field0=_field1=null;
continue;
}
break;
case REASON:
if (ch == HttpTokens.CARRIAGE_RETURN || ch == HttpTokens.LINE_FEED) {
String reason=BufferUtil.toString(buffer,start,buffer.position() - start - 1,StringUtil.__ISO_8859_1_CHARSET);
start=-1;
at_next|=_responseHandler.startResponse(_field0,_responseStatus,reason);
_eol=ch;
_state=State.HEADER;
_field0=_field1=null;
continue;
}
break;
case HEADER:
switch (ch) {
case HttpTokens.COLON:
case HttpTokens.SPACE:
case HttpTokens.TAB:
{
length=-1;
_state=State.HEADER_VALUE;
break;
}
default :
{
if (_field0 != null || _field1 != null) {
if (_header != null) {
switch (_header) {
case CONTENT_LENGTH:
if (_contentLength != HttpTokens.CHUNKED_CONTENT && _responseStatus != 304 && _responseStatus != 204 && (_responseStatus < 100 || _responseStatus >= 200)) {
try {
_contentLength=Long.parseLong(_field1);
}
 catch (NumberFormatException e) {
LOG.ignore(e);
throw new HttpException(HttpStatus.BAD_REQUEST_400);
}
if (_contentLength <= 0) _contentLength=HttpTokens.NO_CONTENT;
}
break;
case TRANSFER_ENCODING:
if (_value == HttpHeaderValue.CHUNKED) _contentLength=HttpTokens.CHUNKED_CONTENT;
 else {
if (_field1.endsWith(HttpHeaderValue.CHUNKED.toString())) _contentLength=HttpTokens.CHUNKED_CONTENT;
 else if (_field1.indexOf(HttpHeaderValue.CHUNKED.toString()) >= 0) throw new HttpException(400,null);
}
break;
case CONNECTION:
switch (_value == null ? HttpHeaderValue.UNKNOWN : _value) {
case CLOSE:
_persistent=false;
break;
case KEEP_ALIVE:
_persistent=true;
break;
default :
{
for (String v : _field1.toString().split(",")) {
switch (HttpHeaderValue.CACHE.get(v.trim())) {
case CLOSE:
_persistent=false;
break;
case KEEP_ALIVE:
_persistent=true;
break;
}
}
break;
}
}
}
}
at_next|=_handler.parsedHeader(_field0,_field1);
}
_field0=_field1=null;
_header=null;
_value=null;
if (ch == HttpTokens.CARRIAGE_RETURN || ch == HttpTokens.LINE_FEED) {
_eol=ch;
_contentPosition=0;
if (_contentLength == HttpTokens.UNKNOWN_CONTENT) {
if (_responseStatus == 0 || _responseStatus == 304 || _responseStatus == 204 || _responseStatus < 200) _contentLength=HttpTokens.NO_CONTENT;
 else _contentLength=HttpTokens.EOF_CONTENT;
}
switch (_contentLength > Integer.MAX_VALUE ? Integer.MAX_VALUE : (int)_contentLength) {
case HttpTokens.EOF_CONTENT:
_state=State.EOF_CONTENT;
at_next|=_handler.headerComplete();
break;
case HttpTokens.CHUNKED_CONTENT:
_state=State.CHUNKED_CONTENT;
at_next|=_handler.headerComplete();
break;
case HttpTokens.NO_CONTENT:
at_next|=_handler.headerComplete();
_state=_persistent || (_responseStatus >= 100 && _responseStatus < 200) ? State.END : State.SEEKING_EOF;
at_next|=_handler.messageComplete(_contentPosition);
break;
default :
_state=State.CONTENT;
at_next|=_handler.headerComplete();
break;
}
}
 else {
start=buffer.position() - 1;
startState=_state;
length=1;
_state=State.HEADER_NAME;
}
}
}
break;
case HEADER_NAME:
switch (ch) {
case HttpTokens.CARRIAGE_RETURN:
case HttpTokens.LINE_FEED:
_eol=ch;
_header=HttpHeader.CACHE.get(buffer,start,length);
_field0=_header == null ? BufferUtil.toString(buffer,start,length,StringUtil.__ISO_8859_1_CHARSET) : _header.toString();
start=length=-1;
_state=State.HEADER;
break;
case HttpTokens.COLON:
_header=HttpHeader.CACHE.get(buffer,start,length);
_field0=_header == null ? BufferUtil.toString(buffer,start,length,StringUtil.__ISO_8859_1_CHARSET) : _header.toString();
start=length=-1;
_state=State.HEADER_VALUE;
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
break;
default :
{
length=buffer.position() - start;
_state=State.HEADER_IN_NAME;
}
}
break;
case HEADER_IN_NAME:
switch (ch) {
case HttpTokens.CARRIAGE_RETURN:
case HttpTokens.LINE_FEED:
_eol=ch;
_header=HttpHeader.CACHE.get(buffer,start,length);
_field0=_header == null ? BufferUtil.toString(buffer,start,length,StringUtil.__ISO_8859_1_CHARSET) : _header.toString();
start=length=-1;
_state=State.HEADER;
break;
case HttpTokens.COLON:
_header=HttpHeader.CACHE.get(buffer,start,length);
_field0=_header == null ? BufferUtil.toString(buffer,start,length,StringUtil.__ISO_8859_1_CHARSET) : _header.toString();
start=length=-1;
_state=State.HEADER_VALUE;
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
_state=State.HEADER_NAME;
break;
default :
length++;
}
break;
case HEADER_VALUE:
switch (ch) {
case HttpTokens.CARRIAGE_RETURN:
case HttpTokens.LINE_FEED:
_eol=ch;
if (length > 0) {
if (_field1 != null) {
_value=null;
_field1+=" " + BufferUtil.toString(buffer,start,length,StringUtil.__ISO_8859_1_CHARSET);
}
 else if (HttpHeaderValue.hasKnownValues(_header)) {
_value=HttpHeaderValue.CACHE.get(buffer,start,length);
_field1=_value.toString();
}
 else {
_field1=BufferUtil.toString(buffer,start,length,StringUtil.__ISO_8859_1_CHARSET);
}
start=length=-1;
}
_state=State.HEADER;
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
break;
default :
{
if (start == -1) {
start=buffer.position() - 1;
startState=_state;
}
length=buffer.position() - start;
_state=State.HEADER_IN_VALUE;
}
}
break;
case HEADER_IN_VALUE:
switch (ch) {
case HttpTokens.CARRIAGE_RETURN:
case HttpTokens.LINE_FEED:
_eol=ch;
if (length > 0) {
if (_field1 != null) {
_value=null;
_field1+=" " + BufferUtil.toString(buffer,start,length,StringUtil.__ISO_8859_1_CHARSET);
}
 else if (HttpHeaderValue.hasKnownValues(_header)) {
_value=HttpHeaderValue.CACHE.get(buffer,start,length);
_field1=_value != null ? _value.toString() : BufferUtil.toString(buffer,start,length,StringUtil.__ISO_8859_1_CHARSET);
}
 else {
_field1=BufferUtil.toString(buffer,start,length,StringUtil.__ISO_8859_1_CHARSET);
}
start=length=-1;
}
_state=State.HEADER;
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
_state=State.HEADER_VALUE;
break;
default :
length++;
}
break;
}
}
if (_responseStatus > 0 && _headResponse) {
_state=_persistent || (_responseStatus >= 100 && _responseStatus < 200) ? State.END : State.SEEKING_EOF;
at_next|=_handler.messageComplete(_contentLength);
}
ByteBuffer chunk;
while (_state.ordinal() > State.END.ordinal() && buffer.hasRemaining()) {
if (_eol == HttpTokens.CARRIAGE_RETURN && buffer.get(buffer.position()) == HttpTokens.LINE_FEED) {
_eol=buffer.get();
continue;
}
_eol=0;
switch (_state) {
case EOF_CONTENT:
chunk=buffer.asReadOnlyBuffer();
_contentPosition+=chunk.remaining();
buffer.position(buffer.position() + chunk.remaining());
at_next|=_handler.content(chunk);
break;
case CONTENT:
{
long remaining=_contentLength - _contentPosition;
if (remaining == 0) {
_state=_persistent ? State.END : State.SEEKING_EOF;
at_next|=_handler.messageComplete(_contentPosition);
}
 else {
chunk=buffer.asReadOnlyBuffer();
if (chunk.remaining() > remaining) {
chunk.limit(chunk.position() + (int)remaining);
}
_contentPosition+=chunk.remaining();
buffer.position(buffer.position() + chunk.remaining());
at_next|=_handler.content(chunk);
if (_contentPosition == _contentLength) {
_state=_persistent ? State.END : State.SEEKING_EOF;
at_next|=_handler.messageComplete(_contentPosition);
}
}
break;
}
case CHUNKED_CONTENT:
{
ch=buffer.get(buffer.position());
if (ch == HttpTokens.CARRIAGE_RETURN || ch == HttpTokens.LINE_FEED) _eol=buffer.get();
 else if (ch <= HttpTokens.SPACE) buffer.get();
 else {
_chunkLength=0;
_chunkPosition=0;
_state=State.CHUNK_SIZE;
}
break;
}
case CHUNK_SIZE:
{
ch=buffer.get();
if (ch == HttpTokens.CARRIAGE_RETURN || ch == HttpTokens.LINE_FEED) {
_eol=ch;
if (_chunkLength == 0) {
if (_eol == HttpTokens.CARRIAGE_RETURN && buffer.hasRemaining() && buffer.get(buffer.position()) == HttpTokens.LINE_FEED) _eol=buffer.get();
_state=_persistent ? State.END : State.SEEKING_EOF;
at_next|=_handler.messageComplete(_contentPosition);
}
 else _state=State.CHUNK;
}
 else if (ch <= HttpTokens.SPACE || ch == HttpTokens.SEMI_COLON) _state=State.CHUNK_PARAMS;
 else if (ch >= '0' && ch <= '9') _chunkLength=_chunkLength * 16 + (ch - '0');
 else if (ch >= 'a' && ch <= 'f') _chunkLength=_chunkLength * 16 + (10 + ch - 'a');
 else if (ch >= 'A' && ch <= 'F') _chunkLength=_chunkLength * 16 + (10 + ch - 'A');
 else throw new IOException("bad chunk char: " + ch);
break;
}
case CHUNK_PARAMS:
{
ch=buffer.get();
if (ch == HttpTokens.CARRIAGE_RETURN || ch == HttpTokens.LINE_FEED) {
_eol=ch;
if (_chunkLength == 0) {
if (_eol == HttpTokens.CARRIAGE_RETURN && buffer.hasRemaining() && buffer.get(buffer.position()) == HttpTokens.LINE_FEED) _eol=buffer.get();
_state=_persistent ? State.END : State.SEEKING_EOF;
at_next|=_handler.messageComplete(_contentPosition);
}
 else _state=State.CHUNK;
}
break;
}
case CHUNK:
{
int remaining=_chunkLength - _chunkPosition;
if (remaining == 0) {
_state=State.CHUNKED_CONTENT;
}
 else {
chunk=buffer.asReadOnlyBuffer();
if (chunk.remaining() > remaining) chunk.limit(chunk.position() + remaining);
remaining=chunk.remaining();
_contentPosition+=remaining;
_chunkPosition+=remaining;
buffer.position(buffer.position() + remaining);
at_next|=_handler.content(chunk);
}
break;
}
case SEEKING_EOF:
{
buffer.clear().limit(0);
break;
}
}
}
return at_next;
}
 catch (HttpException e) {
_persistent=false;
_state=State.SEEKING_EOF;
throw e;
}
 finally {
if (start >= 0) {
buffer.position(start);
_state=startState;
}
}
}
