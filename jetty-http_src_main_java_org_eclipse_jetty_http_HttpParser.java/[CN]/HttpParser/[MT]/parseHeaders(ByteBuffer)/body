{
  boolean handle=false;
  while (_state.ordinal() < State.CONTENT.ordinal() && buffer.hasRemaining() && !handle) {
    byte ch=next(buffer);
    if (ch == 0)     break;
    if (_maxHeaderBytes > 0 && ++_headerBytes > _maxHeaderBytes) {
      LOG.warn("Header is too large >" + _maxHeaderBytes);
      throw new BadMessage(HttpStatus.REQUEST_ENTITY_TOO_LARGE_413);
    }
switch (_state) {
case HEADER:
switch (ch) {
case HttpTokens.COLON:
case HttpTokens.SPACE:
case HttpTokens.TAB:
{
          _string.setLength(0);
          if (_valueString != null) {
            _string.append(_valueString);
            _string.append(' ');
          }
          _length=_string.length();
          _valueString=null;
          setState(State.HEADER_VALUE);
          break;
        }
default :
{
        if (_headerString != null || _valueString != null) {
          if (_header != null && handleKnownHeaders(buffer)) {
            _headerString=_valueString=null;
            _header=null;
            _value=null;
            _field=null;
            return true;
          }
          handle=_handler.parsedHeader(_field != null ? _field : new HttpField(_header,_headerString,_valueString)) || handle;
        }
        _headerString=_valueString=null;
        _header=null;
        _value=null;
        _field=null;
        if (ch == HttpTokens.LINE_FEED) {
          _contentPosition=0;
          if (!_host && _version != HttpVersion.HTTP_1_0 && _requestHandler != null) {
            throw new BadMessage(HttpStatus.BAD_REQUEST_400,"No Host");
          }
          if (_responseHandler != null && (_responseStatus == 304 || _responseStatus == 204 || _responseStatus < 200))           _endOfContent=EndOfContent.NO_CONTENT;
 else           if (_endOfContent == EndOfContent.UNKNOWN_CONTENT) {
            if (_responseStatus == 0 || _responseStatus == 304 || _responseStatus == 204 || _responseStatus < 200)             _endOfContent=EndOfContent.NO_CONTENT;
 else             _endOfContent=EndOfContent.EOF_CONTENT;
          }
switch (_endOfContent) {
case EOF_CONTENT:
            setState(State.EOF_CONTENT);
          handle=_handler.headerComplete() || handle;
        break;
case CHUNKED_CONTENT:
      setState(State.CHUNKED_CONTENT);
    handle=_handler.headerComplete() || handle;
  break;
case NO_CONTENT:
handle=_handler.headerComplete() || handle;
setState(State.END);
handle=_handler.messageComplete() || handle;
break;
default :
setState(State.CONTENT);
handle=_handler.headerComplete() || handle;
break;
}
}
 else if (ch <= HttpTokens.SPACE) throw new BadMessage();
 else {
if (buffer.hasRemaining()) {
HttpField field=_connectionFields == null ? null : _connectionFields.getBest(buffer,-1,buffer.remaining());
if (field == null) field=HttpField.CACHE.getBest(buffer,-1,buffer.remaining());
if (field != null) {
String n=field.getName();
String v=field.getValue();
if (v == null) {
_header=field.getHeader();
_headerString=n;
setState(State.HEADER_VALUE);
_string.setLength(0);
_length=0;
buffer.position(buffer.position() + n.length() + 1);
break;
}
 else {
int pos=buffer.position() + n.length() + v.length()+ 1;
byte b=buffer.get(pos);
if (b == HttpTokens.CARRIAGE_RETURN || b == HttpTokens.LINE_FEED) {
_field=field;
_header=_field.getHeader();
_headerString=n;
_valueString=v;
setState(State.HEADER_IN_VALUE);
if (b == HttpTokens.CARRIAGE_RETURN) {
_cr=true;
buffer.position(pos + 1);
}
 else buffer.position(pos);
break;
}
}
}
}
setState(State.HEADER_NAME);
_string.setLength(0);
_string.append((char)ch);
_length=1;
}
}
}
break;
case HEADER_NAME:
if (ch < 0) throw new BadMessage();
switch (ch) {
case HttpTokens.LINE_FEED:
if (_headerString == null) {
_headerString=takeLengthString();
_header=HttpHeader.CACHE.get(_headerString);
}
setState(State.HEADER);
break;
case HttpTokens.COLON:
if (_headerString == null) {
_headerString=takeLengthString();
_header=HttpHeader.CACHE.get(_headerString);
}
setState(State.HEADER_VALUE);
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
break;
default :
{
_string.append((char)ch);
_length=_string.length();
setState(State.HEADER_IN_NAME);
}
}
break;
case HEADER_IN_NAME:
if (ch < HttpTokens.SPACE) {
}
if (ch < 0) throw new BadMessage("Illegal character");
switch (ch) {
case HttpTokens.LINE_FEED:
_headerString=takeString();
_length=-1;
_header=HttpHeader.CACHE.get(_headerString);
setState(State.HEADER);
break;
case HttpTokens.COLON:
if (_headerString == null) {
_headerString=takeString();
_header=HttpHeader.CACHE.get(_headerString);
}
_length=-1;
setState(State.HEADER_VALUE);
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
if (_header != null) {
_string.setLength(0);
_string.append(_header.asString());
_length=_string.length();
_header=null;
_headerString=null;
}
setState(State.HEADER_NAME);
_string.append((char)ch);
break;
default :
if (_header != null) {
_string.setLength(0);
_string.append(_header.asString());
_length=_string.length();
_header=null;
_headerString=null;
}
_string.append((char)ch);
_length++;
}
break;
case HEADER_VALUE:
switch (ch) {
case HttpTokens.LINE_FEED:
if (_length > 0) {
if (_valueString != null) {
_value=null;
_valueString+=" " + takeLengthString();
}
 else if (HttpHeaderValue.hasKnownValues(_header)) {
_valueString=takeLengthString();
_value=HttpHeaderValue.CACHE.get(_valueString);
}
 else {
_value=null;
_valueString=takeLengthString();
}
}
setState(State.HEADER);
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
break;
default :
{
_string.append((char)(0xff & ch));
_length=_string.length();
setState(State.HEADER_IN_VALUE);
}
}
break;
case HEADER_IN_VALUE:
switch (ch) {
case HttpTokens.LINE_FEED:
if (_length > 0) {
if (HttpHeaderValue.hasKnownValues(_header)) {
_valueString=takeString();
_value=HttpHeaderValue.CACHE.get(_valueString);
}
 else {
_value=null;
_valueString=takeString();
}
_length=-1;
}
setState(State.HEADER);
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
if (_valueString != null) {
_string.setLength(0);
_string.append(_valueString);
_length=_valueString.length();
_valueString=null;
_field=null;
}
_string.append((char)ch);
setState(State.HEADER_VALUE);
break;
default :
if (_valueString != null) {
_string.setLength(0);
_string.append(_valueString);
_length=_valueString.length();
_valueString=null;
_field=null;
}
_string.append((char)(0xff & ch));
_length++;
}
break;
default :
throw new IllegalStateException(_state.toString());
}
}
return handle;
}
