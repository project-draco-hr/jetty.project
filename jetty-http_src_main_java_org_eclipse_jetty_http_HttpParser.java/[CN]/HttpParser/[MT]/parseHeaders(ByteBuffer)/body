{
  boolean return_from_parse=false;
  while (_state.ordinal() < State.END.ordinal() && buffer.hasRemaining() && !return_from_parse) {
    byte ch=buffer.get();
    if (_maxHeaderBytes > 0 && ++_headerBytes > _maxHeaderBytes) {
      LOG.warn("Header is too large >" + _maxHeaderBytes);
      badMessage(buffer,HttpStatus.REQUEST_ENTITY_TOO_LARGE_413,null);
      return true;
    }
    if (_eol == HttpTokens.CARRIAGE_RETURN && ch == HttpTokens.LINE_FEED) {
      _eol=HttpTokens.LINE_FEED;
      continue;
    }
    _eol=0;
switch (_state) {
case HEADER:
switch (ch) {
case HttpTokens.COLON:
case HttpTokens.SPACE:
case HttpTokens.TAB:
{
          _string.setLength(0);
          if (_valueString != null) {
            _string.append(_valueString);
            _string.append(' ');
          }
          _length=_string.length();
          _valueString=null;
          setState(State.HEADER_VALUE);
          break;
        }
default :
{
        if (_headerString != null || _valueString != null) {
          if (_header != null && handleKnownHeaders(buffer))           return true;
          return_from_parse|=_handler.parsedHeader(_field != null ? _field : new HttpField(_header,_headerString,_valueString));
          _field=null;
        }
        _headerString=_valueString=null;
        _header=null;
        _value=null;
        if (ch == HttpTokens.CARRIAGE_RETURN || ch == HttpTokens.LINE_FEED) {
          consumeCRLF(ch,buffer);
          _contentPosition=0;
          if (!_host && _version != HttpVersion.HTTP_1_0 && _requestHandler != null) {
            badMessage(buffer,HttpStatus.BAD_REQUEST_400,"No Host");
            return true;
          }
          if (_responseHandler != null && (_responseStatus == 304 || _responseStatus == 204 || _responseStatus < 200))           _endOfContent=EndOfContent.NO_CONTENT;
 else           if (_endOfContent == EndOfContent.UNKNOWN_CONTENT) {
            if (_responseStatus == 0 || _responseStatus == 304 || _responseStatus == 204 || _responseStatus < 200)             _endOfContent=EndOfContent.NO_CONTENT;
 else             _endOfContent=EndOfContent.EOF_CONTENT;
          }
switch (_endOfContent) {
case EOF_CONTENT:
            setState(State.EOF_CONTENT);
          return_from_parse|=_handler.headerComplete();
        break;
case CHUNKED_CONTENT:
      setState(State.CHUNKED_CONTENT);
    return_from_parse|=_handler.headerComplete();
  break;
case NO_CONTENT:
return_from_parse|=_handler.headerComplete();
setState(State.END);
return_from_parse|=_handler.messageComplete();
break;
default :
setState(State.CONTENT);
return_from_parse|=_handler.headerComplete();
break;
}
}
 else {
if (buffer.remaining() > 6 && buffer.hasArray()) {
_field=HttpField.CACHE.getBest(buffer.array(),buffer.arrayOffset() + buffer.position() - 1,buffer.remaining() + 1);
if (_field != null) {
_header=_field.getHeader();
_headerString=_field.getName();
_valueString=_field.getValue();
if (_valueString == null) {
setState(State.HEADER_VALUE);
buffer.position(buffer.position() + _headerString.length() + 1);
_string.setLength(0);
_length=0;
_field=null;
}
 else {
setState(State.HEADER_IN_VALUE);
buffer.position(buffer.position() + _headerString.length() + _valueString.length()+ 1);
}
break;
}
_header=HttpHeader.CACHE.getBest(buffer.array(),buffer.arrayOffset() + buffer.position() - 1,buffer.remaining() + 1);
if (_header != null) {
_headerString=_header.asString();
_string.setLength(0);
setState(State.HEADER_IN_NAME);
buffer.position(buffer.position() + _headerString.length() - 1);
break;
}
}
setState(State.HEADER_NAME);
_string.setLength(0);
_string.append((char)ch);
_length=1;
}
}
}
break;
case HEADER_NAME:
switch (ch) {
case HttpTokens.CARRIAGE_RETURN:
case HttpTokens.LINE_FEED:
consumeCRLF(ch,buffer);
if (_headerString == null) {
_headerString=takeLengthString();
_header=HttpHeader.CACHE.get(_headerString);
}
setState(State.HEADER);
break;
case HttpTokens.COLON:
if (_headerString == null) {
_headerString=takeLengthString();
_header=HttpHeader.CACHE.get(_headerString);
}
setState(State.HEADER_VALUE);
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
_string.append((char)ch);
break;
default :
{
_string.append((char)ch);
_length=_string.length();
setState(State.HEADER_IN_NAME);
}
}
break;
case HEADER_IN_NAME:
switch (ch) {
case HttpTokens.CARRIAGE_RETURN:
case HttpTokens.LINE_FEED:
consumeCRLF(ch,buffer);
_headerString=takeString();
_length=-1;
_header=HttpHeader.CACHE.get(_headerString);
setState(State.HEADER);
break;
case HttpTokens.COLON:
if (_headerString == null) {
_headerString=takeString();
_header=HttpHeader.CACHE.get(_headerString);
}
_length=-1;
setState(State.HEADER_VALUE);
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
if (_header != null) {
_string.setLength(0);
_string.append(_header.asString());
_length=_string.length();
_header=null;
_headerString=null;
}
setState(State.HEADER_NAME);
_string.append((char)ch);
break;
default :
if (_header != null) {
_string.setLength(0);
_string.append(_header.asString());
_length=_string.length();
_header=null;
_headerString=null;
}
_string.append((char)ch);
_length++;
}
break;
case HEADER_VALUE:
switch (ch) {
case HttpTokens.CARRIAGE_RETURN:
case HttpTokens.LINE_FEED:
consumeCRLF(ch,buffer);
if (_length > 0) {
if (_valueString != null) {
_value=null;
_valueString+=" " + takeLengthString();
}
 else if (HttpHeaderValue.hasKnownValues(_header)) {
_valueString=takeLengthString();
_value=HttpHeaderValue.CACHE.get(_valueString);
}
 else {
_value=null;
_valueString=takeLengthString();
}
}
setState(State.HEADER);
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
break;
default :
{
_string.append((char)ch);
_length=_string.length();
setState(State.HEADER_IN_VALUE);
}
}
break;
case HEADER_IN_VALUE:
switch (ch) {
case HttpTokens.CARRIAGE_RETURN:
case HttpTokens.LINE_FEED:
consumeCRLF(ch,buffer);
if (_length > 0) {
if (HttpHeaderValue.hasKnownValues(_header)) {
_valueString=takeString();
_value=HttpHeaderValue.CACHE.get(_valueString);
}
 else {
_value=null;
_valueString=takeString();
}
_length=-1;
}
setState(State.HEADER);
break;
case HttpTokens.SPACE:
case HttpTokens.TAB:
if (_valueString != null) {
_string.setLength(0);
_string.append(_valueString);
_length=_valueString.length();
_valueString=null;
_field=null;
}
_string.append((char)ch);
setState(State.HEADER_VALUE);
break;
default :
if (_valueString != null) {
_string.setLength(0);
_string.append(_valueString);
_length=_valueString.length();
_valueString=null;
_field=null;
}
_string.append((char)ch);
_length++;
}
break;
default :
throw new IllegalStateException(_state.toString());
}
}
return return_from_parse;
}
