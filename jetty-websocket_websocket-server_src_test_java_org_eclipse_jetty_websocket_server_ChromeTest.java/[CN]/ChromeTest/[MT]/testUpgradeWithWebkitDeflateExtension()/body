{
  BlockheadClient client=new BlockheadClient(server.getServerUri());
  try {
    client.addExtensions("x-webkit-deflate-frame");
    client.setProtocols("chat");
    client.connect();
    client.sendStandardRequest();
    HttpResponse response=client.expectUpgradeResponse();
    Assert.assertThat("Response",response.getExtensionsHeader(),containsString("x-webkit-deflate-frame"));
    String msg="this is an echo ... cho ... ho ... o";
    client.write(new TextFrame().setPayload(msg));
    EventQueue<WebSocketFrame> frames=client.readFrames(1,500,TimeUnit.MILLISECONDS);
    WebSocketFrame tf=frames.poll();
    Assert.assertThat("Text Frame.status code",tf.getPayloadAsUTF8(),is(msg));
  }
  finally {
    client.close();
  }
}
