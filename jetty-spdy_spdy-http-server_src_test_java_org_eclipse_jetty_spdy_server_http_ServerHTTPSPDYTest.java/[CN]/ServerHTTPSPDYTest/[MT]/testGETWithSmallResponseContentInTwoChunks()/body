{
  final String data1="0123456789ABCDEF";
  final String data2="FEDCBA9876543210";
  final CountDownLatch handlerLatch=new CountDownLatch(1);
  Session session=startClient(version,startHTTPServer(version,new AbstractHandler(){
    @Override public void handle(    String target,    Request request,    HttpServletRequest httpRequest,    HttpServletResponse httpResponse) throws IOException, ServletException {
      request.setHandled(true);
      httpResponse.setStatus(HttpServletResponse.SC_OK);
      ServletOutputStream output=httpResponse.getOutputStream();
      output.write(data1.getBytes(StandardCharsets.UTF_8));
      output.flush();
      output.write(data2.getBytes(StandardCharsets.UTF_8));
      handlerLatch.countDown();
    }
  }
,30000),null);
  Fields headers=SPDYTestUtils.createHeaders("localhost",connector.getPort(),version,"GET","/foo");
  final CountDownLatch replyLatch=new CountDownLatch(1);
  final CountDownLatch dataLatch=new CountDownLatch(2);
  session.syn(new SynInfo(headers,true),new StreamFrameListener.Adapter(){
    private final AtomicInteger replyFrames=new AtomicInteger();
    private final AtomicInteger dataFrames=new AtomicInteger();
    @Override public void onReply(    Stream stream,    ReplyInfo replyInfo){
      assertEquals(1,replyFrames.incrementAndGet());
      Assert.assertFalse(replyInfo.isClose());
      Fields replyHeaders=replyInfo.getHeaders();
      assertTrue(replyHeaders.get(HTTPSPDYHeader.STATUS.name(version)).getValue().contains("200"));
      replyLatch.countDown();
    }
    @Override public void onData(    Stream stream,    DataInfo dataInfo){
      int data=dataFrames.incrementAndGet();
      assertTrue(data >= 1 && data <= 2);
      if (data == 1)       assertEquals(data1,dataInfo.asString(StandardCharsets.UTF_8,true));
 else       assertEquals(data2,dataInfo.asString(StandardCharsets.UTF_8,true));
      dataLatch.countDown();
    }
  }
);
  assertTrue(handlerLatch.await(5,TimeUnit.SECONDS));
  assertTrue(replyLatch.await(5,TimeUnit.SECONDS));
  assertTrue(dataLatch.await(5,TimeUnit.SECONDS));
}
