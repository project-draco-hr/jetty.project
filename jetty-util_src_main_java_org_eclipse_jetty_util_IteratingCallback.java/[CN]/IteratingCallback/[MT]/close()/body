{
  while (true) {
    State current=_state.get();
switch (current) {
case INACTIVE:
case SUCCEEDED:
case FAILED:
      if (_state.compareAndSet(current,State.CLOSED))       return;
    break;
default :
  if (_state.compareAndSet(current,State.CLOSED)) {
    onCompleteFailure(new IllegalStateException("Closed with pending callback " + this));
    return;
  }
}
}
}
