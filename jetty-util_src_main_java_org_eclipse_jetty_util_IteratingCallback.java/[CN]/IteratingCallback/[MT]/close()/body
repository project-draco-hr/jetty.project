{
  while (true) {
    State current=_state.get();
switch (current) {
case INACTIVE:
case SUCCEEDED:
case FAILED:
{
        if (_state.compareAndSet(current,State.CLOSED))         return;
        break;
      }
case CLOSED:
{
      return;
    }
default :
{
    if (_state.compareAndSet(current,State.CLOSED)) {
      onCompleteFailure(new ClosedChannelException());
      return;
    }
  }
}
}
}
