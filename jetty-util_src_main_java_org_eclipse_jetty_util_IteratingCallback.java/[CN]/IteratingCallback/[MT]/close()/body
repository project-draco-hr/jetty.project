{
  loop:   while (true) {
    State state=_state.get();
switch (state) {
case IDLE:
case SUCCEEDED:
case FAILED:
{
        if (!_state.compareAndSet(state,State.CLOSED))         continue loop;
        break loop;
      }
case CLOSED:
{
      break loop;
    }
case LOCKED:
{
    Thread.yield();
    continue loop;
  }
default :
{
  if (!_state.compareAndSet(state,State.CLOSED))   continue loop;
  onCompleteFailure(new ClosedChannelException());
  break loop;
}
}
}
}
