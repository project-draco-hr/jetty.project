{
  while (true) {
    State state=_state.get();
switch (state) {
case IDLE:
case SUCCEEDED:
case FAILED:
{
        if (_state.compareAndSet(state,State.CLOSED))         return;
        break;
      }
default :
{
      if (_state.compareAndSet(state,State.CLOSED)) {
        onCompleteFailure(new IllegalStateException("Closed with pending callback " + this));
        return;
      }
    }
}
}
}
