{
  loop:   while (true) {
    State state=_state.get();
switch (state) {
case SUCCEEDED:
case FAILED:
case IDLE:
case CLOSED:
{
        break loop;
      }
case LOCKED:
{
      Thread.yield();
      continue loop;
    }
default :
{
    if (!_state.compareAndSet(state,State.FAILED))     continue loop;
    onCompleteFailure(x);
    break loop;
  }
}
}
}
