{
  while (_state.compareAndSet(State.INACTIVE,State.ITERATING)) {
    Action action=process();
switch (action) {
case IDLE:
{
        if (_state.compareAndSet(State.ITERATING,State.INACTIVE))         return true;
        if (_state.compareAndSet(State.ITERATE_AGAIN,State.INACTIVE))         continue;
        continue;
      }
case SCHEDULED:
{
      if (_state.compareAndSet(State.ITERATING,State.ACTIVE) || _state.compareAndSet(State.ITERATE_AGAIN,State.ACTIVE))       return true;
      continue;
    }
case SUCCEEDED:
{
    while (true) {
      State current=_state.get();
switch (current) {
case SUCCEEDED:
case FAILED:
        return true;
case CLOSED:
      throw new IllegalStateException();
default :
    if (_state.compareAndSet(current,State.SUCCEEDED)) {
      onCompleteSuccess();
      return true;
    }
}
}
}
default :
{
throw new IllegalStateException(toString());
}
}
}
return false;
}
