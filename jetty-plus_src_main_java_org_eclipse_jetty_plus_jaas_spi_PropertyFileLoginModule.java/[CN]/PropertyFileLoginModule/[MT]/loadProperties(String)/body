{
  File propsFile;
  if (filename == null) {
    propsFile=new File(System.getProperty("user.dir"),DEFAULT_FILENAME);
    if (!propsFile.exists())     propsFile=new File(System.getProperty("jetty.home"),DEFAULT_FILENAME);
  }
 else {
    propsFile=new File(filename);
  }
  if (!propsFile.exists()) {
    Log.warn("No property file found");
    throw new IllegalStateException("No property file specified in login module configuration file");
  }
  try {
    this.propertyFileName=propsFile.getCanonicalPath();
    if (fileMap.get(propertyFileName) != null) {
      if (Log.isDebugEnabled()) {
        Log.debug("Properties file " + propertyFileName + " already in cache, skipping load");
      }
      return;
    }
    Map userInfoMap=new HashMap();
    Properties props=new Properties();
    props.load(new FileInputStream(propsFile));
    Iterator iter=props.entrySet().iterator();
    while (iter.hasNext()) {
      Map.Entry entry=(Map.Entry)iter.next();
      String username=entry.getKey().toString().trim();
      String credentials=entry.getValue().toString().trim();
      String roles=null;
      int c=credentials.indexOf(',');
      if (c > 0) {
        roles=credentials.substring(c + 1).trim();
        credentials=credentials.substring(0,c).trim();
      }
      if (username != null && username.length() > 0 && credentials != null && credentials.length() > 0) {
        ArrayList roleList=new ArrayList();
        if (roles != null && roles.length() > 0) {
          StringTokenizer tok=new StringTokenizer(roles,", ");
          while (tok.hasMoreTokens())           roleList.add(tok.nextToken());
        }
        userInfoMap.put(username,(new UserInfo(username,Credential.getCredential(credentials.toString()),roleList)));
      }
    }
    fileMap.put(propertyFileName,userInfoMap);
  }
 catch (  Exception e) {
    Log.warn("Error loading properties from file",e);
    throw new RuntimeException(e);
  }
}
