{
  int capacity=512;
  Trie<ContextHandler[]> trie;
  loop:   while (true) {
    trie=new ArrayTernaryTrie<>(false,capacity);
    Handler[] branches=getHandlers();
    for (int b=0; branches != null && b < branches.length; b++) {
      Handler[] handlers=null;
      if (branches[b] instanceof ContextHandler) {
        handlers=new Handler[]{branches[b]};
      }
 else       if (branches[b] instanceof HandlerContainer) {
        handlers=((HandlerContainer)branches[b]).getChildHandlersByClass(ContextHandler.class);
      }
 else       continue;
      for (int i=0; handlers != null && i < handlers.length; i++) {
        ContextHandler handler=(ContextHandler)handlers[i];
        String contextPath=handler.getContextPath().substring(1);
        ContextHandler[] contexts=trie.get(contextPath);
        if (!trie.put(contextPath,ArrayUtil.addToArray(contexts,handler,ContextHandler.class))) {
          capacity+=512;
          continue loop;
        }
      }
    }
    break;
  }
  for (  String ctx : trie.keySet()) {
    ContextHandler[] contexts=trie.get(ctx);
    ContextHandler[] sorted=new ContextHandler[contexts.length];
    int i=0;
    for (    ContextHandler handler : contexts)     if (handler.getVirtualHosts() != null && handler.getVirtualHosts().length > 0)     sorted[i++]=handler;
    for (    ContextHandler handler : contexts)     if (handler.getVirtualHosts() == null || handler.getVirtualHosts().length == 0)     sorted[i++]=handler;
    trie.put(ctx,sorted);
  }
  _contexts=trie;
}
