{
  final CountDownLatch serverLatch=new CountDownLatch(1);
  Server server=new Server();
  Connector connector=new SelectChannelConnector();
  server.addConnector(connector);
  server.setHandler(new AbstractHandler(){
    public void handle(    String target,    Request request,    HttpServletRequest httpRequest,    HttpServletResponse httpResponse) throws IOException, ServletException {
      request.setHandled(true);
      if (target.endsWith("/connect")) {
        serverLatch.countDown();
        throw new TestException();
      }
    }
  }
);
  server.start();
  try {
    RHTTPClient client=createClient(connector.getLocalPort(),"test3");
    try {
      final CountDownLatch connectLatch=new CountDownLatch(1);
      client.addClientListener(new ClientListener.Adapter(){
        @Override public void connectException(){
          connectLatch.countDown();
        }
      }
);
      client.connect();
      assertTrue(serverLatch.await(1000,TimeUnit.MILLISECONDS));
      assertTrue(connectLatch.await(1000,TimeUnit.MILLISECONDS));
    }
  finally {
      destroyClient(client);
    }
  }
  finally {
    server.stop();
  }
}
