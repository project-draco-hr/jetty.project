{
  final List<AsyncListener> aListeners;
  final AsyncContextEvent event;
synchronized (this) {
switch (_state) {
case COMPLETING:
      _state=State.COMPLETED;
    aListeners=_asyncListeners;
  event=_event;
_event=null;
break;
default :
throw new IllegalStateException(this.getStatusString());
}
}
if (aListeners != null) {
for (AsyncListener listener : aListeners) {
try {
if (event != null && event.getThrowable() != null) {
event.getSuppliedRequest().setAttribute(RequestDispatcher.ERROR_EXCEPTION,event.getThrowable());
event.getSuppliedRequest().setAttribute(RequestDispatcher.ERROR_MESSAGE,event.getThrowable().getMessage());
listener.onError(event);
}
 else listener.onComplete(event);
}
 catch (Exception e) {
LOG.warn(e);
}
}
}
if (event != null) event.completed();
}
