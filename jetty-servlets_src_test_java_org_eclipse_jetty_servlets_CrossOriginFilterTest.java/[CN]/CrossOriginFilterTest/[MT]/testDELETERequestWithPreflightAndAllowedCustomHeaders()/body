{
  FilterHolder filterHolder=new FilterHolder(new CrossOriginFilter());
  filterHolder.setInitParameter(CrossOriginFilter.ALLOWED_METHODS_PARAM,"GET,HEAD,POST,PUT,DELETE");
  filterHolder.setInitParameter(CrossOriginFilter.ALLOWED_HEADERS_PARAM,"X-Requested-With,Content-Type,Accept,Origin,X-Custom");
  tester.getContext().addFilter(filterHolder,"/*",FilterMapping.DEFAULT);
  CountDownLatch latch=new CountDownLatch(1);
  tester.getContext().addServlet(new ServletHolder(new ResourceServlet(latch)),"/*");
  String request="" + "OPTIONS / HTTP/1.1\r\n" + "Host: localhost\r\n" + CrossOriginFilter.ACCESS_CONTROL_REQUEST_METHOD_HEADER + ": DELETE\r\n"+ CrossOriginFilter.ACCESS_CONTROL_REQUEST_HEADERS_HEADER+ ": origin,x-custom,x-requested-with\r\n"+ "Origin: http://localhost\r\n"+ "\r\n";
  String response=tester.getResponses(request);
  Assert.assertTrue(response.contains("HTTP/1.1 200"));
  Assert.assertTrue(response.contains(CrossOriginFilter.ACCESS_CONTROL_ALLOW_ORIGIN_HEADER));
  Assert.assertTrue(response.contains(CrossOriginFilter.ACCESS_CONTROL_ALLOW_CREDENTIALS_HEADER));
  Assert.assertTrue(response.contains(CrossOriginFilter.ACCESS_CONTROL_MAX_AGE_HEADER));
  Assert.assertTrue(response.contains(CrossOriginFilter.ACCESS_CONTROL_ALLOW_METHODS_HEADER));
  Assert.assertTrue(response.contains(CrossOriginFilter.ACCESS_CONTROL_ALLOW_HEADERS_HEADER));
  Assert.assertTrue(latch.await(1,TimeUnit.SECONDS));
  request="" + "DELETE / HTTP/1.1\r\n" + "Host: localhost\r\n"+ "X-Custom: value\r\n"+ "X-Requested-With: local\r\n"+ "Origin: http://localhost\r\n"+ "\r\n";
  response=tester.getResponses(request);
  Assert.assertTrue(response.contains("HTTP/1.1 200"));
  Assert.assertTrue(response.contains(CrossOriginFilter.ACCESS_CONTROL_ALLOW_ORIGIN_HEADER));
  Assert.assertTrue(response.contains(CrossOriginFilter.ACCESS_CONTROL_ALLOW_CREDENTIALS_HEADER));
}
