{
  Response response=_channel.getResponse();
  HttpFields fields=response.getHttpFields();
  response.addSetCookie("null",null,null,null,-1,null,false,false,-1);
  assertEquals("null=",fields.get("Set-Cookie"));
  fields.clear();
  response.addSetCookie("minimal","value",null,null,-1,null,false,false,-1);
  assertEquals("minimal=value",fields.get("Set-Cookie"));
  fields.clear();
  response.addSetCookie("everything","something","domain","path",0,"noncomment",true,true,0);
  response.addSetCookie("everything","value","domain","path",0,"comment",true,true,0);
  Enumeration<String> e=fields.getValues("Set-Cookie");
  assertTrue(e.hasMoreElements());
  assertEquals("everything=something;Version=1;Path=path;Domain=domain;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=noncomment",e.nextElement());
  assertEquals("everything=value;Version=1;Path=path;Domain=domain;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=comment",e.nextElement());
  assertFalse(e.hasMoreElements());
  assertEquals("Thu, 01 Jan 1970 00:00:00 GMT",fields.get("Expires"));
  assertFalse(e.hasMoreElements());
  fields.clear();
  response.addSetCookie("everything","other","domain1","path",0,"blah",true,true,0);
  response.addSetCookie("everything","value","domain2","path",0,"comment",true,true,0);
  e=fields.getValues("Set-Cookie");
  assertTrue(e.hasMoreElements());
  assertEquals("everything=other;Version=1;Path=path;Domain=domain1;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=blah",e.nextElement());
  assertTrue(e.hasMoreElements());
  assertEquals("everything=value;Version=1;Path=path;Domain=domain2;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=comment",e.nextElement());
  assertFalse(e.hasMoreElements());
  fields.clear();
  response.addSetCookie("everything","other","domain1","path",0,"blah",true,true,0);
  response.addSetCookie("everything","value","","path",0,"comment",true,true,0);
  e=fields.getValues("Set-Cookie");
  assertTrue(e.hasMoreElements());
  assertEquals("everything=other;Version=1;Path=path;Domain=domain1;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=blah",e.nextElement());
  assertTrue(e.hasMoreElements());
  assertEquals("everything=value;Version=1;Path=path;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=comment",e.nextElement());
  assertFalse(e.hasMoreElements());
  fields.clear();
  response.addSetCookie("everything","other","domain1","path1",0,"blah",true,true,0);
  response.addSetCookie("everything","value","domain1","path2",0,"comment",true,true,0);
  e=fields.getValues("Set-Cookie");
  assertTrue(e.hasMoreElements());
  assertEquals("everything=other;Version=1;Path=path1;Domain=domain1;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=blah",e.nextElement());
  assertTrue(e.hasMoreElements());
  assertEquals("everything=value;Version=1;Path=path2;Domain=domain1;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=comment",e.nextElement());
  assertFalse(e.hasMoreElements());
  fields.clear();
  response.addSetCookie("everything","other","domain1","path1",0,"blah",true,true,0);
  response.addSetCookie("everything","value","domain1","",0,"comment",true,true,0);
  e=fields.getValues("Set-Cookie");
  assertTrue(e.hasMoreElements());
  assertEquals("everything=other;Version=1;Path=path1;Domain=domain1;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=blah",e.nextElement());
  assertTrue(e.hasMoreElements());
  assertEquals("everything=value;Version=1;Domain=domain1;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=comment",e.nextElement());
  assertFalse(e.hasMoreElements());
  fields.clear();
  response.addSetCookie("everything","other","","",0,"blah",true,true,0);
  response.addSetCookie("everything","value","","",0,"comment",true,true,0);
  e=fields.getValues("Set-Cookie");
  assertTrue(e.hasMoreElements());
  assertEquals("everything=other;Version=1;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=blah",e.nextElement());
  assertEquals("everything=value;Version=1;Expires=Thu, 01-Jan-1970 00:00:00 GMT;Max-Age=0;Secure;HttpOnly;Comment=comment",e.nextElement());
  assertFalse(e.hasMoreElements());
  fields.clear();
  response.addSetCookie("ev erything","va lue","do main","pa th",1,"co mment",true,true,1);
  String setCookie=fields.get("Set-Cookie");
  assertThat(setCookie,Matchers.startsWith("\"ev erything\"=\"va lue\";Version=1;Path=\"pa th\";Domain=\"do main\";Expires="));
  assertThat(setCookie,Matchers.endsWith(" GMT;Max-Age=1;Secure;HttpOnly;Comment=\"co mment\""));
  fields.clear();
  response.addSetCookie("name","value",null,null,-1,null,false,false,0);
  setCookie=fields.get("Set-Cookie");
  assertEquals(-1,setCookie.indexOf("Version="));
  fields.clear();
  response.addSetCookie("name","v a l u e",null,null,-1,null,false,false,0);
  setCookie=fields.get("Set-Cookie");
  fields.clear();
  response.addSetCookie("json","{\"services\":[\"cwa\", \"aa\"]}",null,null,-1,null,false,false,-1);
  assertEquals("json=\"{\\\"services\\\":[\\\"cwa\\\", \\\"aa\\\"]}\"",fields.get("Set-Cookie"));
  fields.clear();
  response.addSetCookie("name","value","domain",null,-1,null,false,false,-1);
  response.addSetCookie("name","other","domain",null,-1,null,false,false,-1);
  response.addSetCookie("name","more","domain",null,-1,null,false,false,-1);
  e=fields.getValues("Set-Cookie");
  assertTrue(e.hasMoreElements());
  assertThat(e.nextElement(),Matchers.startsWith("name=value"));
  assertThat(e.nextElement(),Matchers.startsWith("name=other"));
  assertThat(e.nextElement(),Matchers.startsWith("name=more"));
  response.addSetCookie("foo","bar","domain",null,-1,null,false,false,-1);
  response.addSetCookie("foo","bob","domain",null,-1,null,false,false,-1);
  assertThat(fields.get("Set-Cookie"),Matchers.startsWith("name=value"));
  fields.clear();
  response.addSetCookie("name","value%=",null,null,-1,null,false,false,0);
  setCookie=fields.get("Set-Cookie");
  assertEquals("name=value%=",setCookie);
}
