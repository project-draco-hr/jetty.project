{
  Response response=newResponse();
  Request request=response.getHttpChannel().getRequest();
  request.setServerName("myhost");
  request.setServerPort(8888);
  request.setContextPath("/path");
  assertEquals("http://myhost:8888/path/info;param?query=0&more=1#target",response.encodeURL("http://myhost:8888/path/info;param?query=0&more=1#target"));
  request.setRequestedSessionId("12345");
  request.setRequestedSessionIdFromCookie(false);
  HashSessionManager manager=new HashSessionManager();
  manager.setSessionIdManager(new HashSessionIdManager());
  request.setSessionManager(manager);
  request.setSession(new TestSession(manager,"12345"));
  manager.setCheckingRemoteSessionIdEncoding(false);
  assertEquals("http://myhost:8888/path/info;param;jsessionid=12345?query=0&more=1#target",response.encodeURL("http://myhost:8888/path/info;param?query=0&more=1#target"));
  assertEquals("http://other:8888/path/info;param;jsessionid=12345?query=0&more=1#target",response.encodeURL("http://other:8888/path/info;param?query=0&more=1#target"));
  assertEquals("http://myhost/path/info;param;jsessionid=12345?query=0&more=1#target",response.encodeURL("http://myhost/path/info;param?query=0&more=1#target"));
  assertEquals("http://myhost:8888/other/info;param;jsessionid=12345?query=0&more=1#target",response.encodeURL("http://myhost:8888/other/info;param?query=0&more=1#target"));
  manager.setCheckingRemoteSessionIdEncoding(true);
  assertEquals("http://myhost:8888/path/info;param;jsessionid=12345?query=0&more=1#target",response.encodeURL("http://myhost:8888/path/info;param?query=0&more=1#target"));
  assertEquals("http://other:8888/path/info;param?query=0&more=1#target",response.encodeURL("http://other:8888/path/info;param?query=0&more=1#target"));
  assertEquals("http://myhost/path/info;param?query=0&more=1#target",response.encodeURL("http://myhost/path/info;param?query=0&more=1#target"));
  assertEquals("http://myhost:8888/other/info;param?query=0&more=1#target",response.encodeURL("http://myhost:8888/other/info;param?query=0&more=1#target"));
  request.setContextPath("");
  assertEquals("http://myhost:8888/;jsessionid=12345",response.encodeURL("http://myhost:8888"));
  assertEquals("https://myhost:8888/;jsessionid=12345",response.encodeURL("https://myhost:8888"));
  assertEquals("mailto:/foo",response.encodeURL("mailto:/foo"));
  assertEquals("http://myhost:8888/;jsessionid=12345",response.encodeURL("http://myhost:8888/"));
  assertEquals("http://myhost:8888/;jsessionid=12345",response.encodeURL("http://myhost:8888/;jsessionid=7777"));
  assertEquals("http://myhost:8888/;param;jsessionid=12345?query=0&more=1#target",response.encodeURL("http://myhost:8888/;param?query=0&more=1#target"));
  assertEquals("http://other:8888/path/info;param?query=0&more=1#target",response.encodeURL("http://other:8888/path/info;param?query=0&more=1#target"));
  manager.setCheckingRemoteSessionIdEncoding(false);
  assertEquals("/foo;jsessionid=12345",response.encodeURL("/foo"));
  assertEquals("/;jsessionid=12345",response.encodeURL("/"));
  assertEquals("/foo.html;jsessionid=12345#target",response.encodeURL("/foo.html#target"));
  assertEquals(";jsessionid=12345",response.encodeURL(""));
}
