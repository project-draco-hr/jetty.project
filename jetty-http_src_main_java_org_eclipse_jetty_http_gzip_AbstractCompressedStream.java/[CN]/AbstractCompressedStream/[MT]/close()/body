{
  if (_closed)   return;
  if (_wrapper.getRequest().getAttribute("javax.servlet.include.request_uri") != null)   flush();
 else {
    if (_bOut != null) {
      long length=_wrapper.getContentLength();
      if (length < 0) {
        length=_bOut.getCount();
        _wrapper.setContentLength(length);
      }
      if (length < _wrapper.getMinCompressSize())       doNotCompress();
 else       doCompress();
    }
 else     if (_out == null) {
      doNotCompress();
    }
    if (_compressedOutputStream != null)     _compressedOutputStream.close();
 else     _out.close();
    _closed=true;
  }
}
