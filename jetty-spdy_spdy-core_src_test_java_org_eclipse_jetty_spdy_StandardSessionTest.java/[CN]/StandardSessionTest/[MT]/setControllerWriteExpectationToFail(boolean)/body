{
  when(controller.write(any(ByteBuffer.class),any(Callback.class),any(StandardSession.FrameBytes.class))).thenAnswer(new Answer<Integer>(){
    public Integer answer(    InvocationOnMock invocation){
      Object[] args=invocation.getArguments();
      Callback<StandardSession.FrameBytes> callback=(Callback<FrameBytes>)args[1];
      FrameBytes context=(FrameBytes)args[2];
      if (fail)       callback.failed(context,new ClosedChannelException());
 else       callback.completed(context);
      return 0;
    }
  }
);
}
