{
  boolean persistent;
switch (_version) {
case HTTP_1_0:
{
      if (_connection != null) {
        if (_connection.contains(HttpHeaderValue.KEEP_ALIVE.asString()))         persistent=true;
 else         persistent=_fields.contains(HttpHeader.CONNECTION,HttpHeaderValue.KEEP_ALIVE.asString());
      }
 else       persistent=false;
      if (!persistent)       persistent=HttpMethod.CONNECT.is(getRequest().getMethod());
      if (persistent)       getResponse().getHttpFields().add(HttpHeader.CONNECTION,HttpHeaderValue.KEEP_ALIVE);
      break;
    }
case HTTP_1_1:
{
    if (_expect) {
      badMessage(HttpStatus.EXPECTATION_FAILED_417,null);
      return true;
    }
    if (_connection != null) {
      if (_connection.contains(HttpHeaderValue.CLOSE.asString()))       persistent=false;
 else       persistent=!_fields.contains(HttpHeader.CONNECTION,HttpHeaderValue.CLOSE.asString());
    }
 else     persistent=true;
    if (!persistent)     persistent=HttpMethod.CONNECT.is(getRequest().getMethod());
    if (!persistent)     getResponse().getHttpFields().add(HttpHeader.CONNECTION,HttpHeaderValue.CLOSE);
    break;
  }
default :
{
  throw new IllegalStateException();
}
}
if (!persistent) _httpConnection._generator.setPersistent(false);
if (_hostPort == null) onRequest(new MetaData.Request(_version,_method,_uri,_fields,null,0));
 else onRequest(new MetaData.Request(_version,_method,_uri,_fields,_hostPort.getHost(),_hostPort.getPort()));
return true;
}
