{
  if (_thread == Thread.currentThread()) {
    if (_state.compareAndSet(SelectorState.CHANGING,SelectorState.MORE_CHANGES))     _changes.offer(change);
 else {
      runChanges();
      runChange(change);
    }
  }
 else {
    _changes.offer(change);
    LOG.debug("Queued change {}",change);
    loop:     while (true) {
switch (_state.get()) {
case CHANGING:
        if (!_state.compareAndSet(SelectorState.CHANGING,SelectorState.MORE_CHANGES))         continue;
      break loop;
case SELECTING:
    if (!_state.compareAndSet(SelectorState.SELECTING,SelectorState.WAKING))     continue;
  wakeup();
break loop;
default :
break loop;
}
}
}
}
