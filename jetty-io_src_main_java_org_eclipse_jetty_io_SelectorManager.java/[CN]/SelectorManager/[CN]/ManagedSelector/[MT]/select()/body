{
  boolean debug=LOG.isDebugEnabled();
  try {
    processChanges();
    if (debug)     LOG.debug("Selector loop waiting on select");
    int selected=_selector.select();
    if (debug)     LOG.debug("Selector loop woken up from select, {}/{} selected",selected,_selector.keys().size());
    _needsWakeup=false;
    Set<SelectionKey> selectedKeys=_selector.selectedKeys();
    for (    SelectionKey key : selectedKeys) {
      if (key.isValid()) {
        processKey(key);
      }
 else {
        if (debug)         LOG.debug("Selector loop ignoring invalid key for channel {}",key.channel());
        Object attachment=key.attachment();
        if (attachment instanceof EndPoint)         ((EndPoint)attachment).close();
      }
    }
    selectedKeys.clear();
  }
 catch (  IOException x) {
    if (isRunning())     LOG.warn(x);
 else     LOG.ignore(x);
  }
}
