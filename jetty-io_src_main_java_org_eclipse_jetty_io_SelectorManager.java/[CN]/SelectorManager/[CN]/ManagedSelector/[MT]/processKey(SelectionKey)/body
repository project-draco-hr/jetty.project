{
  Object attachment=key.attachment();
  try {
    if (attachment instanceof SelectableEndPoint) {
      ((SelectableEndPoint)attachment).onSelected();
    }
 else     if (key.isConnectable()) {
      SocketChannel channel=(SocketChannel)key.channel();
      try {
        boolean connected=channel.finishConnect();
        if (connected) {
          key.interestOps(0);
          EndPoint endpoint=createEndPoint(channel,key);
          key.attach(endpoint);
        }
 else {
          throw new ConnectException();
        }
      }
 catch (      Exception x) {
        connectionFailed(channel,x,attachment);
        closeNoExceptions(channel);
      }
    }
 else {
      throw new IllegalStateException();
    }
  }
 catch (  CancelledKeyException x) {
    LOG.debug("Ignoring cancelled key for channel {}",key.channel());
    if (attachment instanceof EndPoint)     ((EndPoint)attachment).close();
  }
catch (  Exception x) {
    LOG.warn("Could not process key for channel " + key.channel(),x);
    if (attachment instanceof EndPoint)     ((EndPoint)attachment).close();
  }
}
