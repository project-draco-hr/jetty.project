{
  LocalWebSocketConnection physical=new LocalWebSocketConnection(testname);
  physical.setPolicy(WebSocketPolicy.newClientPolicy());
  physical.open();
  MuxDecoder serverRead=new MuxDecoder();
  Muxer muxer=new Muxer(physical);
  DummyMuxAddClient addClient=new DummyMuxAddClient();
  muxer.setAddClient(addClient);
  muxer.setOutgoingFramesHandler(serverRead);
  MuxEncoder serverWrite=MuxEncoder.toIncoming(physical);
  StringBuilder request=new StringBuilder();
  request.append("GET /echo HTTP/1.1\r\n");
  request.append("Host: localhost\r\n");
  request.append("Upgrade: websocket\r\n");
  request.append("Connection: Upgrade\r\n");
  request.append("Sec-WebSocket-Key: ZDTIRU5vU9xOfkg8JAgN3A==\r\n");
  request.append("Sec-WebSocket-Version: 13\r\n");
  request.append("\r\n");
  long channelId=1L;
  MuxAddChannelRequest req=new MuxAddChannelRequest();
  req.setChannelId(channelId);
  req.setEncoding((byte)0);
  req.setHandshake(request.toString());
  MuxChannel channel=muxer.getChannel(channelId,true);
  MuxEncoder clientWrite=MuxEncoder.toOutgoing(channel);
  clientWrite.op(req);
  serverRead.assertHasOp(MuxOp.ADD_CHANNEL_REQUEST,1);
  StringBuilder response=new StringBuilder();
  response.append("HTTP/1.1 101 Switching Protocols\r\n");
  response.append("Upgrade: websocket\r\n");
  response.append("Connection: upgrade\r\n");
  response.append("Sec-WebSocket-Accept: Kgo85/8KVE8YPONSeyhgL3GwqhI=\r\n");
  response.append("\r\n");
  MuxAddChannelResponse resp=new MuxAddChannelResponse();
  resp.setChannelId(channelId);
  resp.setFailed(false);
  resp.setEncoding((byte)0);
  resp.setHandshake(resp.toString());
  serverWrite.op(resp);
}
