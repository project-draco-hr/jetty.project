{
  Request request=result.getRequest();
  HttpConversation conversation=client.getConversation(request.getConversationID(),false);
  List<Response.ResponseListener> listeners=conversation.getExchanges().peekFirst().getResponseListeners();
  ContentResponse response=new HttpContentResponse(result.getResponse(),getContent(),getEncoding());
  if (result.isFailed()) {
    Throwable failure=result.getFailure();
    LOG.debug("Authentication challenge failed {}",failure);
    notifier.forwardFailureComplete(listeners,request,result.getRequestFailure(),response,result.getResponseFailure());
    return;
  }
  List<WWWAuthenticate> wwwAuthenticates=parseWWWAuthenticate(response);
  if (wwwAuthenticates.isEmpty()) {
    LOG.debug("Authentication challenge without WWW-Authenticate header");
    notifier.forwardFailureComplete(listeners,request,null,response,new HttpResponseException("HTTP protocol violation: 401 without WWW-Authenticate header",response));
    return;
  }
  final String uri=request.getURI();
  Authentication authentication=null;
  WWWAuthenticate wwwAuthenticate=null;
  for (  WWWAuthenticate wwwAuthn : wwwAuthenticates) {
    authentication=client.getAuthenticationStore().findAuthentication(wwwAuthn.type,uri,wwwAuthn.realm);
    if (authentication != null) {
      wwwAuthenticate=wwwAuthn;
      break;
    }
  }
  if (authentication == null) {
    LOG.debug("No authentication available for {}",request);
    notifier.forwardSuccessComplete(listeners,request,response);
    return;
  }
  final Authentication.Result authnResult=authentication.authenticate(request,response,wwwAuthenticate.value,conversation);
  LOG.debug("Authentication result {}",authnResult);
  if (authnResult == null) {
    notifier.forwardSuccessComplete(listeners,request,response);
    return;
  }
  Request newRequest=client.copyRequest(request,request.getURI());
  authnResult.apply(newRequest);
  newRequest.onResponseSuccess(new Response.SuccessListener(){
    @Override public void onSuccess(    Response response){
      client.getAuthenticationStore().addAuthenticationResult(authnResult);
    }
  }
).send(null);
}
