{
  int fragSize=4;
  BlockheadClient client=new BlockheadClient(server.getServerUri());
  client.clearExtensions();
  client.addExtensions("fragment;maxLength=" + fragSize);
  client.setProtocols("onConnect");
  try {
    client.setTimeout(TimeUnit.SECONDS,1);
    client.connect();
    client.sendStandardRequest();
    HttpResponse resp=client.expectUpgradeResponse();
    Assert.assertThat("Response",resp.getExtensionsHeader(),containsString("fragment"));
    String msg="Sent as a long message that should be split";
    client.write(WebSocketFrame.text(msg));
    String parts[]=split(msg,fragSize);
    IncomingFramesCapture capture=client.readFrames(parts.length,TimeUnit.MILLISECONDS,1000);
    for (int i=0; i < parts.length; i++) {
      WebSocketFrame frame=capture.getFrames().poll();
      Assert.assertThat("text[" + i + "].payload",frame.getPayloadAsUTF8(),is(parts[i]));
    }
  }
  finally {
    client.close();
  }
}
