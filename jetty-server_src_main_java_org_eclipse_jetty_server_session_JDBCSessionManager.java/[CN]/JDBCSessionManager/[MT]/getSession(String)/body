{
  Session session=(Session)_sessions.get(idInCluster);
synchronized (this) {
    try {
      SessionData data=null;
      long now=System.currentTimeMillis();
      if (LOG.isDebugEnabled()) {
        if (session == null)         LOG.debug("getSession(" + idInCluster + "): not in session map,"+ " now="+ now+ " lastSaved="+ (session == null ? 0 : session._data._lastSaved)+ " interval="+ (_saveIntervalSec * 1000L));
 else         LOG.debug("getSession(" + idInCluster + "): in session map, "+ " now="+ now+ " lastSaved="+ (session == null ? 0 : session._data._lastSaved)+ " interval="+ (_saveIntervalSec * 1000L)+ " lastNode="+ session._data.getLastNode()+ " thisNode="+ getSessionIdManager().getWorkerName()+ " difference="+ (now - session._data._lastSaved));
      }
      if (session == null || ((now - session._data._lastSaved) >= (_saveIntervalSec * 1000L))) {
        LOG.debug("getSession(" + idInCluster + "): no session in session map or stale session. Reloading session data from db.");
        data=loadSession(idInCluster,canonicalize(_context.getContextPath()),getVirtualHost(_context));
      }
 else       if ((now - session._data._lastSaved) >= (_saveIntervalSec * 1000L)) {
        LOG.debug("getSession(" + idInCluster + "): stale session. Reloading session data from db.");
        data=loadSession(idInCluster,canonicalize(_context.getContextPath()),getVirtualHost(_context));
      }
 else {
        LOG.debug("getSession(" + idInCluster + "): session in session map");
        data=session._data;
      }
      if (data != null) {
        if (!data.getLastNode().equals(getSessionIdManager().getWorkerName()) || session == null) {
          if (data._expiryTime <= 0 || data._expiryTime > now) {
            LOG.debug("getSession(" + idInCluster + "): lastNode="+ data.getLastNode()+ " thisNode="+ getSessionIdManager().getWorkerName());
            data.setLastNode(getSessionIdManager().getWorkerName());
            session=new Session(now,data);
            _sessions.put(idInCluster,session);
            session.didActivate();
            updateSessionNode(data);
          }
 else           if (LOG.isDebugEnabled())           LOG.debug("getSession(" + idInCluster + "): Session has expired");
        }
 else         if (LOG.isDebugEnabled())         LOG.debug("getSession(" + idInCluster + "): Session not stale "+ session._data);
      }
 else {
        session=null;
        if (LOG.isDebugEnabled())         LOG.debug("getSession(" + idInCluster + "): No session in database matching id="+ idInCluster);
      }
      return session;
    }
 catch (    Exception e) {
      LOG.warn("Unable to load session from database",e);
      return null;
    }
  }
}
