{
  while (true) {
    int oldInterestOps=_interestOps.get();
    int newInterestOps;
    if (add)     newInterestOps=oldInterestOps | operation;
 else     newInterestOps=oldInterestOps & ~operation;
    if (isInputShutdown())     newInterestOps&=~SelectionKey.OP_READ;
    if (isOutputShutdown())     newInterestOps&=~SelectionKey.OP_WRITE;
    if (newInterestOps != oldInterestOps) {
      if (_interestOps.compareAndSet(oldInterestOps,newInterestOps)) {
        if (LOG.isDebugEnabled())         LOG.debug("Local interests updated {} -> {} for {}",oldInterestOps,newInterestOps,this);
        _selector.updateKey(_updateTask);
      }
 else {
        if (LOG.isDebugEnabled())         LOG.debug("Local interests update conflict: now {}, was {}, attempted {} for {}",_interestOps.get(),oldInterestOps,newInterestOps,this);
        continue;
      }
    }
 else {
      if (LOG.isDebugEnabled())       LOG.debug("Ignoring local interests update {} -> {} for {}",oldInterestOps,newInterestOps,this);
    }
    break;
  }
}
