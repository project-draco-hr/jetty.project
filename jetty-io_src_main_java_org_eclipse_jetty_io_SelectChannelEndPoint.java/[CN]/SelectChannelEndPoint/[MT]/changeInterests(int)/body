{
  boolean pending=false;
  while (true) {
    State current=_interestState.get();
    if (LOG.isDebugEnabled())     LOG.debug("Changing interests in state {} for {}",current,this);
switch (current) {
case SELECTED:
case SELECTING:
{
        if (!_interestState.compareAndSet(current,State.LOCKED))         continue;
        try {
          int oldInterestOps=_interestOps;
          int newInterestOps=oldInterestOps | operation;
          if (LOG.isDebugEnabled())           LOG.debug("changeInterests pending={} {}->{} for {}",pending,oldInterestOps,newInterestOps,this);
          if (newInterestOps != oldInterestOps)           _interestOps=newInterestOps;
          if (current == State.SELECTING)           setKeyInterests();
        }
  finally {
          _interestState.set(current);
        }
        if (current == State.SELECTING)         _selector.wakeup();
        return;
      }
case LOCKED:
{
      Thread.yield();
      break;
    }
}
}
}
