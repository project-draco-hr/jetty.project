{
synchronized (lock) {
    succeeded.clear();
    while (buffers.size() < gatheredBufferLimit && !queue.isEmpty()) {
      FrameEntry frame=queue.remove(0);
      active.add(frame);
      buffers.add(frame.getHeaderBytes());
      ByteBuffer payload=frame.getPayload();
      if (payload != null)       buffers.add(payload);
    }
    if (LOG.isDebugEnabled())     LOG.debug("process {} active={} buffers={}",FrameFlusher.this,active,buffers);
  }
  if (buffers.size() == 0)   return State.IDLE;
  endpoint.write(this,buffers.toArray(new ByteBuffer[buffers.size()]));
  buffers.clear();
  return State.SCHEDULED;
}
