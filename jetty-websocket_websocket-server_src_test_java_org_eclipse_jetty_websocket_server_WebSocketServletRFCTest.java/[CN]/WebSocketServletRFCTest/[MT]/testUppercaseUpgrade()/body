{
  BlockheadClient client=new BlockheadClient(server.getServerUri());
  try {
    client.connect();
    StringBuilder req=new StringBuilder();
    req.append("GET ").append(client.getRequestPath()).append(" HTTP/1.1\r\n");
    req.append("HOST: ").append(client.getRequestHost()).append("\r\n");
    req.append("UPGRADE: WEBSOCKET\r\n");
    req.append("CONNECTION: UPGRADE\r\n");
    req.append("SEC-WEBSOCKET-KEY: ").append(client.getRequestWebSocketKey()).append("\r\n");
    req.append("SEC-WEBSOCKET-ORIGIN: ").append(client.getRequestWebSocketOrigin()).append("\r\n");
    req.append("SEC-WEBSOCKET-PROTOCOL: ECHO\r\n");
    req.append("SEC-WEBSOCKET-VERSION: 13\r\n");
    req.append("\r\n");
    client.writeRaw(req.toString());
    client.expectUpgradeResponse();
    String msg="this is an echo ... cho ... ho ... o";
    client.write(new TextFrame().setPayload(msg));
    IncomingFramesCapture capture=client.readFrames(1,TimeUnit.MILLISECONDS,500);
    WebSocketFrame tf=capture.getFrames().poll();
    Assert.assertThat("Text Frame.status code",tf.getPayloadAsUTF8(),is(msg));
  }
  finally {
    client.close();
  }
}
