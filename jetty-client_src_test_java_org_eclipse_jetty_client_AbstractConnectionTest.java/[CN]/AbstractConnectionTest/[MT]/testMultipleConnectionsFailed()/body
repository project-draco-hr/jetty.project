{
  ServerSocket serverSocket=new ServerSocket();
  serverSocket.bind(null);
  int port=serverSocket.getLocalPort();
  serverSocket.close();
  HttpClient httpClient=newHttpClient();
  httpClient.setMaxConnectionsPerAddress(1);
  httpClient.start();
  try {
    HttpExchange[] exchanges=new HttpExchange[20];
    final CountDownLatch latch=new CountDownLatch(exchanges.length);
    for (int i=0; i < exchanges.length; ++i) {
      HttpExchange exchange=new HttpExchange(){
        @Override protected void onConnectionFailed(        Throwable x){
          latch.countDown();
        }
      }
;
      exchange.setAddress(new Address("localhost",port));
      exchange.setRequestURI("/");
      exchanges[i]=exchange;
    }
    for (    HttpExchange exchange : exchanges)     httpClient.send(exchange);
    for (    HttpExchange exchange : exchanges)     assertEquals(HttpExchange.STATUS_EXCEPTED,exchange.waitForDone());
    assertTrue(latch.await(1000,TimeUnit.MILLISECONDS));
  }
  finally {
    httpClient.stop();
  }
}
