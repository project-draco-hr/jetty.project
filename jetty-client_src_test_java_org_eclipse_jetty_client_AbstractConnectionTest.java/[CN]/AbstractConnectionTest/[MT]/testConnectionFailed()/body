{
  ServerSocket serverSocket=new ServerSocket();
  serverSocket.bind(null);
  int port=serverSocket.getLocalPort();
  serverSocket.close();
  HttpClient httpClient=newHttpClient();
  httpClient.start();
  try {
    CountDownLatch latch=new CountDownLatch(1);
    HttpExchange exchange=new ConnectionExchange(latch);
    exchange.setAddress(new Address("localhost",port));
    exchange.setRequestURI("/");
    httpClient.send(exchange);
    boolean passed=latch.await(4000,TimeUnit.MILLISECONDS);
    assertTrue(passed);
    long wait=100;
    long maxWait=10 * wait;
    long curWait=wait;
    while (curWait < maxWait && !exchange.isDone()) {
      Thread.sleep(wait);
      curWait+=wait;
    }
    assertEquals(HttpExchange.STATUS_EXCEPTED,exchange.getStatus());
  }
  finally {
    httpClient.stop();
  }
}
