{
  ServerSocket serverSocket=new ServerSocket();
  serverSocket.bind(null);
  int port=serverSocket.getLocalPort();
  HttpClient httpClient=newHttpClient();
  httpClient.setIdleTimeout(700);
  httpClient.start();
  try {
    HttpExchange exchange=new ConnectionExchange();
    exchange.setAddress(new Address("localhost",port));
    exchange.setRequestURI("/");
    HttpDestination dest=httpClient.getDestination(new Address("localhost",port),false);
    httpClient.send(exchange);
    Socket server=serverSocket.accept();
    server.setSoTimeout(5000);
    byte[] buf=new byte[4096];
    int len=server.getInputStream().read(buf);
    assertEquals(1,dest.getConnections());
    assertEquals(0,dest.getIdleConnections());
    server.getOutputStream().write("HTTP/1.1 200 OK\r\nContent-Length: 0\r\n\r\n".getBytes());
    assertEquals(HttpExchange.STATUS_COMPLETED,exchange.waitForDone());
    Thread.sleep(200);
    assertEquals(1,dest.getConnections());
    assertEquals(1,dest.getIdleConnections());
    exchange=new ConnectionExchange();
    exchange.setAddress(new Address("localhost",port));
    exchange.setRequestURI("/");
    httpClient.send(exchange);
    assertEquals(1,dest.getConnections());
    assertEquals(0,dest.getIdleConnections());
    len=server.getInputStream().read(buf);
    assertEquals(1,dest.getConnections());
    assertEquals(0,dest.getIdleConnections());
    server.getOutputStream().write("HTTP/1.1 200 OK\r\nContent-Length: 0\r\n\r\n".getBytes());
    Thread.sleep(500);
    assertEquals(1,dest.getConnections());
    assertEquals(1,dest.getIdleConnections());
    Thread.sleep(500);
    assertEquals(0,dest.getConnections());
    assertEquals(0,dest.getIdleConnections());
    serverSocket.close();
  }
  finally {
    httpClient.stop();
  }
}
