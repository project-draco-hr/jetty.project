{
  if (_storeDir == null || !_storeDir.exists()) {
    return;
  }
  if (!_storeDir.canWrite()) {
    Log.warn("Unable to save Sessions: Session persistence storage directory " + _storeDir.getAbsolutePath() + " is not writeable");
    return;
  }
  Iterator<Map.Entry<String,HashedSession>> itor=_sessions.entrySet().iterator();
  while (itor.hasNext()) {
    Map.Entry<String,HashedSession> entry=itor.next();
    String id=entry.getKey();
    HashedSession session=entry.getValue();
synchronized (session) {
      if (!session.isIdled() && !session.isSaveFailed()) {
        File file=null;
        FileOutputStream fos=null;
        try {
          file=new File(_storeDir,id);
          if (file.exists())           file.delete();
          file.createNewFile();
          fos=new FileOutputStream(file);
          session.willPassivate();
          session.save(fos);
          session.didActivate();
          fos.close();
        }
 catch (        Exception e) {
          session.saveFailed();
          Log.warn("Problem persisting session " + id,e);
          if (fos != null) {
            IO.close(fos);
            file.delete();
          }
        }
      }
    }
  }
}
