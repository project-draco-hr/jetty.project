{
  HttpServletRequest srequest=(HttpServletRequest)request;
  if (srequest.getContentType() == null || !srequest.getContentType().startsWith("multipart/form-data")) {
    chain.doFilter(request,response);
    return;
  }
  InputStream in=new BufferedInputStream(request.getInputStream());
  String content_type=srequest.getContentType();
  MultiMap<String> params=new MultiMap<String>();
  for (Iterator<Map.Entry<String,String[]>> i=request.getParameterMap().entrySet().iterator(); i.hasNext(); ) {
    Map.Entry<String,String[]> entry=i.next();
    Object value=entry.getValue();
    if (value instanceof String[])     params.addValues(entry.getKey(),(String[])value);
 else     params.add(entry.getKey(),value);
  }
  MultipartConfigElement config=new MultipartConfigElement(tempdir.getCanonicalPath(),_maxFileSize,_maxRequestSize,_fileOutputBuffer);
  MultiPartInputStream mpis=new MultiPartInputStream(in,content_type,config,tempdir);
  try {
    Collection<Part> parts=mpis.getParts();
    if (parts != null) {
      Iterator<Part> itor=parts.iterator();
      while (itor.hasNext() && params.size() < _maxFormKeys) {
        Part p=itor.next();
        MultiPartInputStream.MultiPart mp=(MultiPartInputStream.MultiPart)p;
        if (mp.getFile() != null) {
          request.setAttribute(mp.getName(),mp.getFile());
          if (mp.getContentDispositionFilename() != null) {
            params.add(mp.getName(),mp.getContentDispositionFilename());
            if (mp.getContentType() != null)             params.add(mp.getName() + CONTENT_TYPE_SUFFIX,mp.getContentType());
          }
          if (_deleteFiles) {
            mp.getFile().deleteOnExit();
            ArrayList files=(ArrayList)request.getAttribute(FILES);
            if (files == null) {
              files=new ArrayList();
              request.setAttribute(FILES,files);
            }
            files.add(mp.getFile());
          }
        }
 else {
          ByteArrayOutputStream bytes=new ByteArrayOutputStream();
          IO.copy(p.getInputStream(),bytes);
          params.add(p.getName(),bytes.toByteArray());
          if (p.getContentType() != null)           params.add(p.getName() + CONTENT_TYPE_SUFFIX,p.getContentType());
        }
      }
    }
    chain.doFilter(new Wrapper(srequest,params),response);
  }
  finally {
    deleteFiles(request);
  }
}
