{
  LOG.debug("newConnection({},{},{})",channel,endPoint,attachment);
  WebSocketClient.ConnectFuture confut=(WebSocketClient.ConnectFuture)attachment;
  try {
    String scheme=confut.getWebSocketUri().getScheme();
    if ("wss".equalsIgnoreCase(scheme)) {
      if (sslContextFactory != null) {
        SSLEngine engine=newSSLEngine(sslContextFactory,channel);
        SslConnection sslConnection=new SslConnection(bufferPool,executor,endPoint,engine);
        EndPoint sslEndPoint=sslConnection.getDecryptedEndPoint();
        Connection connection=newWebSocketConnection(channel,sslEndPoint,confut);
        sslEndPoint.setConnection(connection);
        connectionOpened(connection);
        return sslConnection;
      }
 else {
        throw new IOException("Cannot init SSL");
      }
    }
 else {
      return newWebSocketConnection(channel,endPoint,confut);
    }
  }
 catch (  IOException e) {
    LOG.debug(e);
    confut.failed(null,e);
    throw e;
  }
}
