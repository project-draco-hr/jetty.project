{
  if (_channel.isIncluding())   return;
  if (_outputState == OutputState.NONE && !isCommitted()) {
    if (encoding == null) {
      if (_characterEncoding != null) {
        _characterEncoding=null;
        if (_contentType != null) {
          _contentType=MimeTypes.getContentTypeWithoutCharset(_contentType);
          _fields.put(HttpHeader.CONTENT_TYPE,_contentType);
        }
      }
    }
 else {
      _characterEncoding=StringUtil.normalizeCharset(encoding);
      if (_contentType != null) {
        _contentType=MimeTypes.getContentTypeWithoutCharset(_contentType) + ";charset=" + _characterEncoding;
        _fields.put(HttpHeader.CONTENT_TYPE,_contentType);
      }
    }
  }
}
