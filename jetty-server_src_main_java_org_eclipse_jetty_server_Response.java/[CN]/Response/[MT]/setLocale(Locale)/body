{
  if (locale == null || isCommitted() || _connection.isIncluding())   return;
  _locale=locale;
  _connection.getResponseFields().put(HttpHeader.CONTENT_LANGUAGE,locale.toString().replace('_','-'));
  if (_explicitEncoding || _outputState != 0)   return;
  if (_connection.getRequest().getContext() == null)   return;
  String charset=_connection.getRequest().getContext().getContextHandler().getLocaleEncoding(locale);
  if (charset != null && charset.length() > 0) {
    _characterEncoding=charset;
    String type=getContentType();
    if (type != null) {
      _characterEncoding=charset;
      int semi=type.indexOf(';');
      if (semi < 0) {
        _mimeType=type;
        _contentType=type+=";charset=" + charset;
      }
 else {
        _mimeType=type.substring(0,semi);
        _contentType=_mimeType+=";charset=" + charset;
      }
      _cachedMimeType=MimeTypes.CACHE.get(_mimeType);
      _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
    }
  }
}
