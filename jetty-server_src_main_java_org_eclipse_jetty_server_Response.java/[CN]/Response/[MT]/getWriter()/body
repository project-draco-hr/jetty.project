{
  if (_outputType == OutputType.STREAM)   throw new IllegalStateException("STREAM");
  if (_outputType == OutputType.NONE) {
    String encoding=_characterEncoding;
    if (encoding == null) {
      if (_mimeType != null && _mimeType.isCharsetAssumed())       encoding=_mimeType.getCharsetString();
 else {
        encoding=MimeTypes.inferCharsetFromContentType(_contentType);
        if (encoding == null)         encoding=StringUtil.__ISO_8859_1;
        setCharacterEncoding(encoding,false);
      }
    }
    if (_writer != null && _writer.isFor(encoding))     _writer.reopen();
 else {
      if (StringUtil.__ISO_8859_1.equalsIgnoreCase(encoding))       _writer=new ResponseWriter(new Iso88591HttpWriter(_out),encoding);
 else       if (StringUtil.__UTF8.equalsIgnoreCase(encoding))       _writer=new ResponseWriter(new Utf8HttpWriter(_out),encoding);
 else       _writer=new ResponseWriter(new EncodingHttpWriter(_out,encoding),encoding);
    }
    _outputType=OutputType.WRITER;
  }
  return _writer;
}
