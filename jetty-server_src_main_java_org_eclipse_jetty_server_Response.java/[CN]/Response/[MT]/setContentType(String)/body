{
  if (isCommitted() || _connection.isIncluding())   return;
  if (contentType == null) {
    if (_locale == null)     _characterEncoding=null;
    _mimeType=null;
    _contentType=null;
    _connection.getResponseFields().remove(HttpHeader.CONTENT_TYPE);
  }
 else {
    int i0=contentType.indexOf(';');
    if (i0 > 0) {
      _mimeType=contentType.substring(0,i0).trim();
      MimeTypes.Type mime_type=MimeTypes.CACHE.get(_mimeType);
      int i1=contentType.indexOf("charset=",i0 + 1);
      if (i1 >= 0) {
        _explicitEncoding=true;
        int i8=i1 + 8;
        int i2=contentType.indexOf(' ',i8);
        if (_outputState == WRITER) {
          if ((i1 == i0 + 1 && i2 < 0) || (i1 == i0 + 2 && i2 < 0 && contentType.charAt(i0 + 1) == ' ')) {
            if (mime_type != null) {
              CachedBuffer content_type=mime_type.getAssociate(_characterEncoding);
              if (content_type != null) {
                _contentType=content_type.toString();
                _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,content_type);
              }
 else {
                _contentType=_mimeType + ";charset=" + _characterEncoding;
                _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
              }
            }
 else {
              _contentType=_mimeType + ";charset=" + _characterEncoding;
              _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
            }
          }
 else           if (i2 < 0) {
            _contentType=contentType.substring(0,i1) + ";charset=" + QuotedStringTokenizer.quoteIfNeeded(_characterEncoding,";= ");
            _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
          }
 else {
            _contentType=contentType.substring(0,i1) + contentType.substring(i2) + ";charset="+ QuotedStringTokenizer.quoteIfNeeded(_characterEncoding,";= ");
            _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
          }
        }
 else         if ((i1 == i0 + 1 && i2 < 0) || (i1 == i0 + 2 && i2 < 0 && contentType.charAt(i0 + 1) == ' ')) {
          mime_type=MimeTypes.CACHE.get(_mimeType);
          _characterEncoding=QuotedStringTokenizer.unquote(contentType.substring(i8));
          if (mime_type != null) {
            CachedBuffer content_type=mime_type.getAssociate(_characterEncoding);
            if (content_type != null) {
              _contentType=content_type.toString();
              _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,content_type);
            }
 else {
              _contentType=contentType;
              _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
            }
          }
 else {
            _contentType=contentType;
            _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
          }
        }
 else         if (i2 > 0) {
          _characterEncoding=QuotedStringTokenizer.unquote(contentType.substring(i8,i2));
          _contentType=contentType;
          _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
        }
 else {
          _characterEncoding=QuotedStringTokenizer.unquote(contentType.substring(i8));
          _contentType=contentType;
          _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
        }
      }
 else {
        mime_type=null;
        _contentType=_characterEncoding == null ? contentType : contentType + ";charset=" + QuotedStringTokenizer.quoteIfNeeded(_characterEncoding,";= ");
        _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
      }
    }
 else {
      _mimeType=contentType;
      _cachedMimeType=MimeTypes.CACHE.get(_mimeType);
      if (_characterEncoding != null) {
        if (_cachedMimeType != null) {
          CachedBuffer content_type=_cachedMimeType.getAssociate(_characterEncoding);
          if (content_type != null) {
            _contentType=content_type.toString();
            _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,content_type);
          }
 else {
            _contentType=_mimeType + ";charset=" + QuotedStringTokenizer.quoteIfNeeded(_characterEncoding,";= ");
            _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
          }
        }
 else {
          _contentType=contentType + ";charset=" + QuotedStringTokenizer.quoteIfNeeded(_characterEncoding,";= ");
          _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
        }
      }
 else       if (_cachedMimeType != null) {
        _contentType=_cachedMimeType.toString();
        _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_cachedMimeType);
      }
 else {
        _contentType=contentType;
        _connection.getResponseFields().put(HttpHeader.CONTENT_TYPE,_contentType);
      }
    }
  }
}
