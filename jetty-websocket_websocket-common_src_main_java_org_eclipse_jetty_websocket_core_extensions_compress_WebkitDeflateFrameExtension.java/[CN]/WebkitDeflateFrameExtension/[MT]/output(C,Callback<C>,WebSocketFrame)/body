{
  if (frame.isControlFrame()) {
    nextOutput(context,callback,frame);
    return;
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("output({}, {}, {})",context,callback,frame);
  }
  ByteBuffer data=frame.getPayload();
  try {
    method.compress().input(data);
    while (!method.compress().isDone()) {
      ByteBuffer buf=method.compress().process();
      WebSocketFrame out=new WebSocketFrame(frame,buf);
      out.setRsv1(true);
      if (!method.compress().isDone()) {
        out.setFin(false);
        nextOutputNoCallback(out);
      }
 else {
        nextOutput(context,callback,out);
      }
    }
    method.compress().end();
  }
  finally {
    getBufferPool().release(data);
  }
}
