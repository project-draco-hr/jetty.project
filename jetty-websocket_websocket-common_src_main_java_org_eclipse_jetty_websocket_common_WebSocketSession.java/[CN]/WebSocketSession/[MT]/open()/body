{
  if (remote != null) {
    return;
  }
  ClassLoader old=Thread.currentThread().getContextClassLoader();
  try {
    Thread.currentThread().setContextClassLoader(classLoader);
    connection.getIOState().onConnected();
    remote=new WebSocketRemoteEndpoint(connection,outgoingHandler,getBatchMode());
    websocket.openSession(this);
    connection.getIOState().onOpened();
    if (LOG.isDebugEnabled()) {
      LOG.debug("open -> {}",dump());
    }
  }
 catch (  Throwable t) {
    int statusCode=StatusCode.SERVER_ERROR;
    if (policy.getBehavior() == WebSocketBehavior.CLIENT) {
      statusCode=StatusCode.POLICY_VIOLATION;
    }
    close(statusCode,t.getMessage());
  }
 finally {
    Thread.currentThread().setContextClassLoader(old);
  }
}
