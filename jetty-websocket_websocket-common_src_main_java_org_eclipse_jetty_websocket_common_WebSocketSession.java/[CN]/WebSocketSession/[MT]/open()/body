{
  if (remote != null) {
    return;
  }
  try (ThreadClassLoaderScope scope=new ThreadClassLoaderScope(classLoader)){
    connection.getIOState().onConnected();
    remote=new WebSocketRemoteEndpoint(connection,outgoingHandler,getBatchMode());
    websocket.openSession(this);
    connection.getIOState().onOpened();
    if (LOG.isDebugEnabled()) {
      LOG.debug("open -> {}",dump());
    }
  }
 catch (  Throwable t) {
    LOG.warn(t);
    int statusCode=StatusCode.SERVER_ERROR;
    if (policy.getBehavior() == WebSocketBehavior.CLIENT) {
      statusCode=StatusCode.POLICY_VIOLATION;
    }
    close(statusCode,t.getMessage());
  }
}
