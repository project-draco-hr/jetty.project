{
  if (policy.getBehavior() == WebSocketBehavior.CLIENT) {
    throw new MuxPhysicalConnectionException(MuxDropChannel.Reason.UNKNOWN_MUX_CONTROL_BLOCK,"AddChannelRequest not allowed per spec");
  }
  if (request.getRsv() != 0) {
    throw new MuxPhysicalConnectionException(MuxDropChannel.Reason.UNKNOWN_REQUEST_ENCODING,"RSV Not allowed to be set");
  }
  long channelId=request.getChannelId();
  MuxChannel channel=getChannel(channelId,true);
  try {
switch (request.getEncoding()) {
case MuxAddChannelRequest.IDENTITY_ENCODING:
{
        UpgradeRequest idenReq=MuxRequest.parse(request.getHandshake());
        addServer.handshake(this,channel,idenReq);
        break;
      }
case MuxAddChannelRequest.DELTA_ENCODING:
{
      UpgradeRequest baseReq=addServer.getPhysicalHandshakeRequest();
      UpgradeRequest deltaReq=MuxRequest.parse(request.getHandshake());
      UpgradeRequest mergedReq=MuxRequest.merge(baseReq,deltaReq);
      addServer.handshake(this,channel,mergedReq);
      break;
    }
default :
{
    throw new MuxPhysicalConnectionException(MuxDropChannel.Reason.BAD_REQUEST,"Unrecognized request encoding");
  }
}
}
 catch (MuxPhysicalConnectionException e) {
throw e;
}
catch (Throwable t) {
throw new MuxPhysicalConnectionException(MuxDropChannel.Reason.BAD_REQUEST,"Unable to parse request",t);
}
}
