{
  EndPointPair<T> c=newConnection();
  ByteBuffer buffer=BufferUtil.allocate(4096);
  c.client.flush(BufferUtil.toBuffer("request"));
  int len=c.server.fill(buffer);
  assertEquals(7,len);
  assertEquals("request",BufferUtil.toString(buffer));
  assertTrue(c.client.isOpen());
  assertFalse(c.client.isOutputShutdown());
  assertTrue(c.server.isOpen());
  assertFalse(c.server.isOutputShutdown());
  c.server.flush(BufferUtil.toBuffer("response"));
  c.server.shutdownOutput();
  assertTrue(c.client.isOpen());
  assertFalse(c.client.isOutputShutdown());
  assertTrue(c.server.isOpen());
  assertTrue(c.server.isOutputShutdown());
  BufferUtil.clear(buffer);
  len=c.client.fill(buffer);
  assertEquals(8,len);
  assertEquals("response",BufferUtil.toString(buffer));
  assertTrue(c.client.isOpen());
  assertFalse(c.client.isOutputShutdown());
  assertTrue(c.server.isOpen());
  assertTrue(c.server.isOutputShutdown());
  BufferUtil.clear(buffer);
  len=c.client.fill(buffer);
  assertEquals(-1,len);
  assertTrue(c.client.isOpen());
  assertFalse(c.client.isOutputShutdown());
  assertTrue(c.server.isOpen());
  assertTrue(c.server.isOutputShutdown());
  c.client.shutdownOutput();
  assertFalse(c.client.isOpen());
  assertTrue(c.client.isOutputShutdown());
  assertTrue(c.server.isOpen());
  assertTrue(c.server.isOutputShutdown());
  BufferUtil.clear(buffer);
  len=c.server.fill(buffer);
  assertEquals(-1,len);
  assertFalse(c.client.isOpen());
  assertTrue(c.client.isOutputShutdown());
  assertFalse(c.server.isOpen());
  assertTrue(c.server.isOutputShutdown());
}
