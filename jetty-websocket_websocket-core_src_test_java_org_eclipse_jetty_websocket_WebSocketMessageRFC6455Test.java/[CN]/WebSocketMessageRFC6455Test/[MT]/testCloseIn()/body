{
  int[][] tests={{-1,0,-1},{-1,0,-1},{1000,2,1000},{1000,2 + 4,1000},{1005,2 + 23,1002},{1005,2 + 23,1002},{1006,2 + 23,1002},{1006,2 + 23,1002},{4000,2,4000},{4000,2 + 4,4000},{9000,2 + 23,1002},{9000,2 + 23,1002}};
  String[] mesg={"","","","mesg","","mesg","","mesg","","mesg","","mesg"};
  String[] resp={"","","","mesg","Invalid close code 1005","Invalid close code 1005","Invalid close code 1006","Invalid close code 1006","","mesg","Invalid close code 9000","Invalid close code 9000"};
  for (int t=0; t < tests.length; t++) {
    String tst="" + t;
    Socket socket=new Socket("localhost",__connector.getLocalPort());
    OutputStream output=socket.getOutputStream();
    output.write(("GET /chat HTTP/1.1\r\n" + "Host: server.example.com\r\n" + "Upgrade: websocket\r\n"+ "Connection: Upgrade\r\n"+ "Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==\r\n"+ "Sec-WebSocket-Origin: http://example.com\r\n"+ "Sec-WebSocket-Protocol: chat\r\n"+ "Sec-WebSocket-Version: " + WebSocketConnectionRFC6455.VERSION + "\r\n"+ "\r\n").getBytes("ISO-8859-1"));
    output.flush();
    socket.setSoTimeout(100000);
    InputStream input=socket.getInputStream();
    lookFor("HTTP/1.1 101 Switching Protocols\r\n",input);
    skipTo("Sec-WebSocket-Accept: ",input);
    lookFor("s3pPLMBiTxaQ9kYGzzhZRbK+xOo=",input);
    skipTo("\r\n\r\n",input);
    assertTrue(__serverWebSocket.awaitConnected(1000));
    assertNotNull(__serverWebSocket.connection);
    int code=tests[t][0];
    String m=mesg[t];
    output.write(0x88);
    output.write(0x80 + (code <= 0 ? 0 : (2 + m.length())));
    output.write(0x00);
    output.write(0x00);
    output.write(0x00);
    output.write(0x00);
    if (code > 0) {
      output.write(code / 0x100);
      output.write(code % 0x100);
      output.write(m.getBytes());
    }
    output.flush();
    __serverWebSocket.awaitDisconnected(1000);
    byte[] buf=new byte[128];
    int len=input.read(buf);
    assertEquals(tst,2 + tests[t][1],len);
    assertEquals(tst,(byte)0x88,buf[0]);
    if (len >= 4) {
      code=(0xff & buf[2]) * 0x100 + (0xff & buf[3]);
      assertEquals(tst,tests[t][2],code);
      if (len > 4) {
        m=new String(buf,4,len - 4,"UTF-8");
        assertEquals(tst,resp[t],m);
      }
    }
 else     assertEquals(tst,tests[t][2],-1);
    len=input.read(buf);
    assertEquals(tst,-1,len);
  }
}
