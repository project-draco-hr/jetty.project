{
  _count.set(0);
  final CountDownLatch complete=new CountDownLatch(nb);
  final CountDownLatch latch=new CountDownLatch(nb);
  HttpExchange[] httpExchange=new HttpExchange[nb];
  long start=System.currentTimeMillis();
  for (int i=0; i < nb; i++) {
    final int n=i;
    httpExchange[n]=new HttpExchange(){
      String result="pending";
      int len=0;
      @Override protected void onRequestCommitted(){
        result="committed";
      }
      @Override protected void onRequestComplete() throws IOException {
        result="sent";
      }
      @Override protected void onResponseStatus(      Buffer version,      int status,      Buffer reason){
        result="status";
      }
      @Override protected void onResponseHeader(      Buffer name,      Buffer value){
      }
      @Override protected void onResponseHeaderComplete() throws IOException {
        result="content";
        super.onResponseHeaderComplete();
      }
      @Override protected void onResponseContent(      Buffer content){
        len+=content.length();
      }
      @Override protected void onResponseComplete(){
        result="complete";
        if (len == 2009)         latch.countDown();
 else         System.err.println(n + " ONLY " + len);
        complete.countDown();
      }
      @Override protected void onConnectionFailed(      Throwable ex){
        complete.countDown();
        result="failed";
        System.err.println(n + " FAILED " + ex);
        super.onConnectionFailed(ex);
      }
      @Override protected void onException(      Throwable ex){
        complete.countDown();
        result="excepted";
        System.err.println(n + " EXCEPTED " + ex);
        super.onException(ex);
      }
      @Override protected void onExpire(){
        complete.countDown();
        result="expired";
        System.err.println(n + " EXPIRED " + len);
        super.onExpire();
      }
      @Override public String toString(){
        return n + " " + result+ " "+ len;
      }
    }
;
    httpExchange[n].setURL(_scheme + "localhost:" + _port+ "/"+ n);
    httpExchange[n].addRequestHeader("arbitrary","value");
    if (close)     httpExchange[n].setRequestHeader("Connection","close");
    _httpClient.send(httpExchange[n]);
  }
  assertTrue(complete.await(45,TimeUnit.SECONDS));
  long elapsed=System.currentTimeMillis() - start;
  if (elapsed > 0)   System.err.println(nb + "/" + _count+ " c="+ close+ " rate="+ (nb * 1000 / elapsed));
  assertEquals("nb=" + nb + " close="+ close,0,latch.getCount());
}
