{
  start(new BasicAuthenticationHandler());
  AuthenticationStore authenticationStore=client.getAuthenticationStore();
  String realm="test";
  final AtomicInteger requests=new AtomicInteger();
  Request.Listener.Adapter requestListener=new Request.Listener.Adapter(){
    @Override public void onSuccess(    Request request){
      requests.incrementAndGet();
    }
  }
;
  client.getRequestListeners().add(requestListener);
  Request request=client.newRequest("localhost",connector.getLocalPort()).path("/test").param("type","Basic").param("realm",realm);
  ContentResponse response=request.send().get(5,TimeUnit.SECONDS);
  Assert.assertNotNull(response);
  Assert.assertEquals(401,response.status());
  Assert.assertEquals(1,requests.get());
  client.getRequestListeners().remove(requestListener);
  requests.set(0);
  String user="jetty";
  String password="rocks";
  authenticationStore.addAuthentication(new BasicAuthentication("http://localhost:" + connector.getLocalPort(),realm,user,password));
  requestListener=new Request.Listener.Adapter(){
    @Override public void onSuccess(    Request request){
      requests.incrementAndGet();
    }
  }
;
  client.getRequestListeners().add(requestListener);
  request.param("user",user).param("password",password);
  response=request.send().get(5,TimeUnit.SECONDS);
  Assert.assertNotNull(response);
  Assert.assertEquals(200,response.status());
  Assert.assertEquals(2,requests.get());
  client.getRequestListeners().remove(requestListener);
  requests.set(0);
  requestListener=new Request.Listener.Adapter(){
    @Override public void onSuccess(    Request request){
      requests.incrementAndGet();
    }
  }
;
  client.getRequestListeners().add(requestListener);
  request.header(HttpHeader.AUTHORIZATION.asString(),null);
  response=request.send().get(555,TimeUnit.SECONDS);
  Assert.assertNotNull(response);
  Assert.assertEquals(200,response.status());
  Assert.assertEquals(1,requests.get());
  client.getRequestListeners().remove(requestListener);
  requests.set(0);
}
