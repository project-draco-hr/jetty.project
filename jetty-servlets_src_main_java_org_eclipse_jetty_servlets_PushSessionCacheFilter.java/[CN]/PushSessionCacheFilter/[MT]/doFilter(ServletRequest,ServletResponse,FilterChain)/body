{
  Request baseRequest=Request.getBaseRequest(request);
  HttpFields fields=baseRequest.getHttpFields();
  String referer=fields.get(HttpHeader.REFERER);
  if (LOG.isDebugEnabled())   LOG.debug("{} {} referer={}%n",baseRequest.getMethod(),baseRequest.getRequestURI(),referer);
  HttpSession session=baseRequest.getSession(true);
  String sessionId=session.getId();
  String path=URIUtil.addPaths(baseRequest.getServletPath(),baseRequest.getPathInfo());
  Target target=_cache.get(path);
  if (target == null) {
    Target t=new Target(path);
    target=_cache.putIfAbsent(path,t);
    target=target == null ? t : target;
  }
  target._timestamp.put(sessionId,System.currentTimeMillis());
  request.setAttribute(TARGET_ATTR,target);
  if (target._associated.size() > 0) {
    PushBuilder builder=baseRequest.getPushBuilder();
    if (!session.isNew())     builder.setConditional(true);
    if (builder != null) {
      for (      Target associated : target._associated.values()) {
        LOG.info("PUSH {}->{}",path,associated._path);
        builder.push(associated._path,associated._etag,associated._lastModified);
      }
    }
  }
  chain.doFilter(request,response);
}
