{
  Request baseRequest=Request.getBaseRequest(request);
  String uri=baseRequest.getRequestURI();
  if (LOG.isDebugEnabled())   LOG.debug("{} {} push={}",baseRequest.getMethod(),uri,baseRequest.isPush());
  HttpSession session=baseRequest.getSession(true);
  Target target=_cache.get(uri);
  if (target == null) {
    Target t=new Target(uri);
    target=_cache.putIfAbsent(uri,t);
    target=target == null ? t : target;
  }
  request.setAttribute(TARGET_ATTR,target);
  ConcurrentHashMap<String,Long> timestamps=(ConcurrentHashMap<String,Long>)session.getAttribute(TIMESTAMP_ATTR);
  if (timestamps == null) {
    timestamps=new ConcurrentHashMap<>();
    session.setAttribute(TIMESTAMP_ATTR,timestamps);
  }
  timestamps.put(uri,System.currentTimeMillis());
  if (baseRequest.isPushSupported() && target._associated.size() > 0) {
    PushBuilder builder=baseRequest.getPushBuilder();
    builder.addHeader("X-Pusher",PushSessionCacheFilter.class.toString());
    for (    Target associated : target._associated.values()) {
      String path=associated._path;
      if (LOG.isDebugEnabled())       LOG.debug("PUSH {} <- {}",path,uri);
      builder.path(path).etag(associated._etag).lastModified(associated._lastModified).push();
    }
  }
  chain.doFilter(request,response);
}
