{
  final CountDownLatch closeLatch=new CountDownLatch(1);
  final CountDownLatch dataLatch=new CountDownLatch(1);
  ServerSessionFrameListener serverSessionFrameListener=new ServerSessionFrameListener.Adapter(){
    private AtomicInteger syns=new AtomicInteger();
    @Override public StreamFrameListener onSyn(    Stream stream,    SynInfo synInfo){
      stream.reply(new ReplyInfo(true));
      int synCount=syns.incrementAndGet();
      if (synCount == 1) {
        return null;
      }
 else {
        stream.getSession().goAway();
        closeLatch.countDown();
        return new StreamFrameListener.Adapter(){
          @Override public void onData(          Stream stream,          DataInfo dataInfo){
            dataLatch.countDown();
          }
        }
;
      }
    }
  }
;
  final AtomicReference<GoAwayInfo> goAwayRef=new AtomicReference<>();
  final CountDownLatch goAwayLatch=new CountDownLatch(1);
  SessionFrameListener clientSessionFrameListener=new SessionFrameListener.Adapter(){
    @Override public void onGoAway(    Session session,    GoAwayInfo goAwayInfo){
      goAwayRef.set(goAwayInfo);
      goAwayLatch.countDown();
    }
  }
;
  Session session=startClient(startServer(serverSessionFrameListener),clientSessionFrameListener);
  final CountDownLatch reply1Latch=new CountDownLatch(1);
  Stream stream1=session.syn(new SynInfo(true),new StreamFrameListener.Adapter(){
    @Override public void onReply(    Stream stream,    ReplyInfo replyInfo){
      reply1Latch.countDown();
    }
  }
).get();
  Assert.assertTrue(reply1Latch.await(5,TimeUnit.SECONDS));
  Stream stream2=session.syn(new SynInfo(false),null).get();
  Assert.assertTrue(closeLatch.await(5,TimeUnit.SECONDS));
  try {
    stream2.data(new StringDataInfo("foo",true));
    Assert.assertFalse(dataLatch.await(1,TimeUnit.SECONDS));
  }
 catch (  SPDYException x) {
    Assert.assertThat(x.getCause(),CoreMatchers.instanceOf(ClosedChannelException.class));
  }
  Assert.assertTrue(goAwayLatch.await(5,TimeUnit.SECONDS));
  GoAwayInfo goAway=goAwayRef.get();
  Assert.assertNotNull(goAway);
  Assert.assertEquals(stream1.getId(),goAway.getLastStreamId());
}
