{
  try {
    request.getAsyncContext();
    throw new IllegalStateException();
  }
 catch (  IllegalStateException e) {
  }
  response.addHeader("history",request.getDispatcherType() + " " + request.getRequestURI());
  if (request instanceof ServletRequestWrapper || response instanceof ServletResponseWrapper)   response.addHeader("history","wrapped" + ((request instanceof ServletRequestWrapper) ? " REQ" : "") + ((response instanceof ServletResponseWrapper) ? " RSP" : ""));
  boolean wrap="true".equals(request.getParameter("wrap"));
  int read_before=0;
  long sleep_for=-1;
  long suspend_for=-1;
  long suspend2_for=-1;
  long resume_after=-1;
  long resume2_after=-1;
  long complete_after=-1;
  long complete2_after=-1;
  if (request.getParameter("read") != null)   read_before=Integer.parseInt(request.getParameter("read"));
  if (request.getParameter("sleep") != null)   sleep_for=Integer.parseInt(request.getParameter("sleep"));
  if (request.getParameter("suspend") != null)   suspend_for=Integer.parseInt(request.getParameter("suspend"));
  if (request.getParameter("suspend2") != null)   suspend2_for=Integer.parseInt(request.getParameter("suspend2"));
  if (request.getParameter("resume") != null)   resume_after=Integer.parseInt(request.getParameter("resume"));
  final String path=request.getParameter("path");
  if (request.getParameter("resume2") != null)   resume2_after=Integer.parseInt(request.getParameter("resume2"));
  if (request.getParameter("complete") != null)   complete_after=Integer.parseInt(request.getParameter("complete"));
  if (request.getParameter("complete2") != null)   complete2_after=Integer.parseInt(request.getParameter("complete2"));
  if (request.getAttribute("State") == null) {
    request.setAttribute("State",new Integer(1));
    response.addHeader("history","initial");
    if (read_before > 0) {
      byte[] buf=new byte[read_before];
      request.getInputStream().read(buf);
    }
 else     if (read_before < 0) {
      InputStream in=request.getInputStream();
      int b=in.read();
      while (b != -1)       b=in.read();
    }
 else     if (request.getContentLength() > 0) {
      new Thread(){
        @Override public void run(){
          int c=0;
          try {
            InputStream in=request.getInputStream();
            int b=0;
            while (b != -1)             if ((b=in.read()) >= 0)             c++;
            response.addHeader("history","async-read=" + c);
          }
 catch (          Exception e) {
            e.printStackTrace();
          }
        }
      }
.start();
    }
    if (suspend_for >= 0) {
      final AsyncContext async=wrap ? request.startAsync(new HttpServletRequestWrapper(request),new HttpServletResponseWrapper(response)) : request.startAsync();
      if (suspend_for > 0)       async.setTimeout(suspend_for);
      async.addListener(__listener);
      response.addHeader("history","suspend");
      if (complete_after > 0) {
        TimerTask complete=new TimerTask(){
          @Override public void run(){
            try {
              response.setStatus(200);
              response.getOutputStream().println("COMPLETED\n");
              response.addHeader("history","complete");
              async.complete();
            }
 catch (            Exception e) {
              e.printStackTrace();
            }
          }
        }
;
synchronized (_timer) {
          _timer.schedule(complete,complete_after);
        }
      }
 else       if (complete_after == 0) {
        response.setStatus(200);
        response.getOutputStream().println("COMPLETED\n");
        response.addHeader("history","complete");
        async.complete();
      }
 else       if (resume_after > 0) {
        TimerTask resume=new TimerTask(){
          @Override public void run(){
            ((HttpServletResponse)async.getResponse()).addHeader("history","resume");
            if (path != null) {
              int q=path.indexOf('?');
              String uriInContext=(q >= 0) ? URIUtil.encodePath(path.substring(0,q)) + path.substring(q) : URIUtil.encodePath(path);
              async.dispatch(uriInContext);
            }
 else             async.dispatch();
          }
        }
;
synchronized (_timer) {
          _timer.schedule(resume,resume_after);
        }
      }
 else       if (resume_after == 0) {
        ((HttpServletResponse)async.getResponse()).addHeader("history","resume");
        if (path != null)         async.dispatch(path);
 else         async.dispatch();
      }
    }
 else     if (sleep_for >= 0) {
      try {
        Thread.sleep(sleep_for);
      }
 catch (      InterruptedException e) {
        e.printStackTrace();
      }
      response.setStatus(200);
      response.getOutputStream().println("SLEPT\n");
    }
 else {
      response.setStatus(200);
      response.getOutputStream().println("NORMAL\n");
    }
  }
 else {
    response.addHeader("history","!initial");
    if (suspend2_for >= 0 && request.getAttribute("2nd") == null) {
      final AsyncContext async=wrap ? request.startAsync(new HttpServletRequestWrapper(request),new HttpServletResponseWrapper(response)) : request.startAsync();
      async.addListener(__listener);
      request.setAttribute("2nd","cycle");
      if (suspend2_for > 0) {
        async.setTimeout(suspend2_for);
      }
      response.addHeader("history","suspend");
      if (complete2_after > 0) {
        TimerTask complete=new TimerTask(){
          @Override public void run(){
            try {
              response.setStatus(200);
              response.getOutputStream().println("COMPLETED\n");
              response.addHeader("history","complete");
              async.complete();
            }
 catch (            Exception e) {
              e.printStackTrace();
            }
          }
        }
;
synchronized (_timer) {
          _timer.schedule(complete,complete2_after);
        }
      }
 else       if (complete2_after == 0) {
        response.setStatus(200);
        response.getOutputStream().println("COMPLETED\n");
        response.addHeader("history","complete");
        async.complete();
      }
 else       if (resume2_after > 0) {
        TimerTask resume=new TimerTask(){
          @Override public void run(){
            response.addHeader("history","resume");
            async.dispatch();
          }
        }
;
synchronized (_timer) {
          _timer.schedule(resume,resume2_after);
        }
      }
 else       if (resume2_after == 0) {
        response.addHeader("history","dispatch");
        async.dispatch();
      }
    }
 else     if (request.getDispatcherType() == DispatcherType.ERROR) {
      response.getOutputStream().println("ERROR: " + request.getContextPath() + request.getServletPath()+ request.getPathInfo());
    }
 else {
      response.setStatus(200);
      response.getOutputStream().println("DISPATCHED");
    }
  }
}
