{
  Connection result=idleConnections.poll();
  if (result != null)   return result;
  final int maxConnections=client.getMaxConnectionsPerAddress();
  while (true) {
    int current=connectionCount.get();
    final int next=current + 1;
    if (next > maxConnections) {
      LOG.debug("Max connections reached {}: {}",this,current);
      return idleConnections.poll();
    }
    if (connectionCount.compareAndSet(current,next)) {
      newConnection(new Callback<Connection>(){
        @Override public void completed(        Connection connection){
          LOG.debug("Created connection {}/{} {} for {}",next,maxConnections,connection,this);
          process(connection);
        }
        @Override public void failed(        Connection connection,        Throwable x){
        }
      }
);
      return idleConnections.poll();
    }
  }
}
