{
  final WebSocket clientWS=new WebSocket(){
    Outbound _outbound;
    public void onConnect(    Outbound outbound){
      _outbound=outbound;
      _results.add("clientWS.onConnect");
      _results.add(_outbound);
    }
    public void onDisconnect(){
    }
    public void onMessage(    byte frame,    String data){
      _results.add("clientWS.onMessage");
      _results.add(data);
    }
    public void onMessage(    byte frame,    byte[] data,    int offset,    int length){
    }
    public void onFragment(    boolean more,    byte opcode,    byte[] data,    int offset,    int length){
    }
  }
;
  HttpExchange httpExchange=new HttpExchange(){
    /** 
 * @see org.eclipse.jetty.client.HttpExchange#onResponseStatus(org.eclipse.jetty.io.Buffer,int,org.eclipse.jetty.io.Buffer)
 */
    @Override protected void onResponseStatus(    Buffer version,    int status,    Buffer reason) throws IOException {
      waitFor(2);
      _results.add(new Integer(status));
      super.onResponseStatus(version,status,reason);
    }
    /** 
 * @see org.eclipse.jetty.client.HttpExchange#onSwitchProtocol(org.eclipse.jetty.io.EndPoint)
 */
    @Override protected Connection onSwitchProtocol(    EndPoint endp) throws IOException {
      waitFor(3);
      WebSocketConnectionD00 connection=new WebSocketConnectionD00(clientWS,endp,0);
      _results.add("onSwitchProtocol");
      _results.add(connection);
      clientWS.onConnect(connection);
      return connection;
    }
    private void waitFor(    int results){
      try {
        int c=10;
        while (_results.size() < results && c-- > 0)         Thread.sleep(10);
      }
 catch (      InterruptedException e) {
        e.printStackTrace();
      }
    }
  }
;
  httpExchange.setURL("http://localhost:" + _port + "/");
  httpExchange.setMethod(HttpMethods.GET);
  httpExchange.addRequestHeader("Upgrade","WebSocket");
  httpExchange.addRequestHeader("Connection","Upgrade");
  _httpClient.send(httpExchange);
  int status=httpExchange.waitForDone();
  assertEquals(HttpExchange.STATUS_COMPLETED,status);
  assertEquals("serverWS.onConnect",_results.poll(1,TimeUnit.SECONDS));
  TestWebSocket serverWS=(TestWebSocket)_results.poll(1,TimeUnit.SECONDS);
  assertEquals(new Integer(101),_results.poll(1,TimeUnit.SECONDS));
  assertEquals("onSwitchProtocol",_results.poll(1,TimeUnit.SECONDS));
  WebSocketConnectionD00 client_conn=(WebSocketConnectionD00)_results.poll(1,TimeUnit.SECONDS);
  assertEquals("clientWS.onConnect",_results.poll(1,TimeUnit.SECONDS));
  assertEquals(client_conn,_results.poll(1,TimeUnit.SECONDS));
  client_conn.sendMessage("hello world");
  assertEquals("serverWS.onMessage",_results.poll(1,TimeUnit.SECONDS));
  assertEquals("hello world",_results.poll(1,TimeUnit.SECONDS));
  serverWS.sendMessage("buongiorno");
  assertEquals("clientWS.onMessage",_results.poll(1,TimeUnit.SECONDS));
  assertEquals("buongiorno",_results.poll(1,TimeUnit.SECONDS));
}
