{
  Class clazz=getTargetClass();
  if (clazz == null) {
    LOG.warn(_className + " cannot be loaded");
    return;
  }
  if (!HttpServlet.class.isAssignableFrom(clazz)) {
    LOG.warn(clazz.getName() + " is not assignable from javax.servlet.http.HttpServlet");
    return;
  }
  WebServlet annotation=(WebServlet)clazz.getAnnotation(WebServlet.class);
  if (annotation.urlPatterns().length > 0 && annotation.value().length > 0) {
    LOG.warn(clazz.getName() + " defines both @WebServlet.value and @WebServlet.urlPatterns");
    return;
  }
  String[] urlPatterns=annotation.value();
  if (urlPatterns.length == 0)   urlPatterns=annotation.urlPatterns();
  if (urlPatterns.length == 0) {
    LOG.warn(clazz.getName() + " defines neither @WebServlet.value nor @WebServlet.urlPatterns");
    return;
  }
  ArrayList<String> urlPatternList=new ArrayList<String>();
  for (  String p : urlPatterns)   urlPatternList.add(Util.normalizePattern(p));
  String servletName=(annotation.name().equals("") ? clazz.getName() : annotation.name());
  MetaData metaData=_context.getMetaData();
  ServletHolder[] holders=_context.getServletHandler().getServlets();
  boolean isNew=true;
  ServletHolder holder=null;
  if (holders != null) {
    for (    ServletHolder h : holders) {
      if (h.getName() != null && servletName.equals(h.getName())) {
        holder=h;
        isNew=false;
        break;
      }
    }
  }
  if (isNew) {
    holder=_context.getServletHandler().newServletHolder(Holder.Source.ANNOTATION);
    holder.setHeldClass(clazz);
    metaData.setOrigin(servletName + ".servlet.servlet-class");
    holder.setName(servletName);
    holder.setDisplayName(annotation.displayName());
    metaData.setOrigin(servletName + ".servlet.display-name");
    holder.setInitOrder(annotation.loadOnStartup());
    metaData.setOrigin(servletName + ".servlet.load-on-startup");
    holder.setAsyncSupported(annotation.asyncSupported());
    metaData.setOrigin(servletName + ".servlet.async-supported");
    for (    WebInitParam ip : annotation.initParams()) {
      holder.setInitParameter(ip.name(),ip.value());
      metaData.setOrigin(servletName + ".servlet.init-param." + ip.name());
    }
    _context.getServletHandler().addServlet(holder);
    ServletMapping mapping=new ServletMapping();
    mapping.setServletName(holder.getName());
    mapping.setPathSpecs(LazyList.toStringArray(urlPatternList));
    _context.getServletHandler().addServletMapping(mapping);
    metaData.setOrigin(servletName + ".servlet.mappings");
  }
 else {
    if (holder.getClassName() == null)     holder.setClassName(clazz.getName());
    if (holder.getHeldClass() == null)     holder.setHeldClass(clazz);
    for (    WebInitParam ip : annotation.initParams()) {
      if (metaData.getOrigin(servletName + ".servlet.init-param." + ip.name()) == Origin.NotSet) {
        holder.setInitParameter(ip.name(),ip.value());
        metaData.setOrigin(servletName + ".servlet.init-param." + ip.name());
      }
    }
    boolean mappingsExist=false;
    boolean anyNonDefaults=false;
    ServletMapping[] allMappings=_context.getServletHandler().getServletMappings();
    if (allMappings != null) {
      for (      ServletMapping m : allMappings) {
        if (m.getServletName() != null && servletName.equals(m.getServletName())) {
          mappingsExist=true;
          if (!m.isDefault()) {
            anyNonDefaults=true;
            break;
          }
        }
      }
    }
    if (anyNonDefaults)     return;
    boolean clash=false;
    if (mappingsExist) {
      for (      String p : urlPatternList) {
        ServletMapping m=_context.getServletHandler().getServletMapping(p);
        if (m != null && !m.isDefault()) {
          clash=true;
          break;
        }
      }
    }
    if (!mappingsExist || !clash) {
      ServletMapping m=new ServletMapping();
      m.setServletName(servletName);
      m.setPathSpecs(LazyList.toStringArray(urlPatternList));
      _context.getServletHandler().addServletMapping(m);
    }
  }
}
