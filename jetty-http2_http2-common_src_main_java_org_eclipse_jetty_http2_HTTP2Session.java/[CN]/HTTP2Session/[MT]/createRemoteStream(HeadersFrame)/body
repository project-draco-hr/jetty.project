{
  int streamId=frame.getStreamId();
  while (true) {
    int currentStreams=streamCount.get();
    int maxStreams=maxStreamCount;
    if (maxStreams >= 0 && currentStreams >= maxStreams) {
      reset(new ResetFrame(streamId,ErrorCodes.REFUSED_STREAM_ERROR),disconnectOnFailure());
      return null;
    }
    if (streamCount.compareAndSet(currentStreams,currentStreams + 1))     break;
  }
  IStream stream=newStream(frame);
  if (streams.putIfAbsent(streamId,stream) == null) {
    updateLastStreamId(streamId);
    stream.setIdleTimeout(endPoint.getIdleTimeout());
    flowControl.onNewStream(stream);
    if (LOG.isDebugEnabled())     LOG.debug("Created remote {}",stream);
    return stream;
  }
 else {
    close(ErrorCodes.PROTOCOL_ERROR,"duplicate_stream",disconnectOnFailure());
    return null;
  }
}
