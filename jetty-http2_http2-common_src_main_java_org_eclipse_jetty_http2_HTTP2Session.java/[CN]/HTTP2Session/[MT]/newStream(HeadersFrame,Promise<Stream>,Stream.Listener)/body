{
synchronized (this) {
    int streamId=streamIds.getAndAdd(2);
    PriorityFrame priority=frame.getPriority();
    priority=priority == null ? null : new PriorityFrame(streamId,priority.getDependentStreamId(),priority.getWeight(),priority.isExclusive());
    frame=new HeadersFrame(streamId,frame.getMetaData(),priority,frame.isEndStream());
    final IStream stream=createLocalStream(streamId,promise);
    if (stream == null)     return;
    stream.updateClose(frame.isEndStream(),true);
    stream.setListener(listener);
    ControlEntry entry=new ControlEntry(frame,stream,new PromiseCallback<>(promise,stream));
    flusher.append(entry);
  }
  flusher.iterate();
}
