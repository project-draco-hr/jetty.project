{
  if (!_STARTED) {
    throw new PolicyException("JettyPolicy must be started.");
  }
synchronized (_cache) {
    if (_cache.containsKey(codesource)) {
      return copyOf(_cache.get(codesource));
    }
    PermissionCollection perms=new Permissions();
    for (Iterator<PolicyBlock> i=_grants.iterator(); i.hasNext(); ) {
      PolicyBlock policyBlock=i.next();
      ProtectionDomain grantPD=policyBlock.toProtectionDomain();
      if (grantPD.getCodeSource() == null || grantPD.getCodeSource().implies(codesource)) {
        if (__DEBUG) {
          debug("----START----");
          debug("PDCS: " + grantPD.getCodeSource());
          debug("CS: " + codesource);
        }
        for (Enumeration<Permission> e=policyBlock.getPermissions().elements(); e.hasMoreElements(); ) {
          Permission perm=e.nextElement();
          if (__DEBUG) {
            debug("D: " + perm);
          }
          perms.add(perm);
        }
        if (__DEBUG) {
          debug("----STOP----");
        }
      }
    }
    _cache.put(codesource,perms);
    return copyOf(perms);
  }
}
