{
  if (!_STARTED) {
    throw new PolicyException("JettyPolicy must be started.");
  }
synchronized (_cache) {
    if (_cache.containsKey(domain)) {
      return copyOf(_cache.get(domain));
    }
    PermissionCollection perms=new Permissions();
    for (Iterator<PolicyBlock> i=_grants.iterator(); i.hasNext(); ) {
      PolicyBlock policyBlock=i.next();
      ProtectionDomain grantPD=policyBlock.toProtectionDomain();
      if (__DEBUG) {
        debug("----START----");
        debug("PDCS: " + policyBlock.getCodeSource());
        debug("CS: " + domain.getCodeSource());
      }
      if (grantPD.getCodeSource() == null || grantPD.getCodeSource().implies(domain.getCodeSource()) && grantPD.getPrincipals() == null || grantPD.getCodeSource().implies(domain.getCodeSource()) && validate(grantPD.getPrincipals(),domain.getPrincipals())) {
        for (Enumeration<Permission> e=policyBlock.getPermissions().elements(); e.hasMoreElements(); ) {
          Permission perm=e.nextElement();
          if (__DEBUG) {
            debug("D: " + perm);
          }
          perms.add(perm);
        }
      }
      if (__DEBUG) {
        debug("----STOP----");
      }
    }
    _cache.put(domain,perms);
    return copyOf(perms);
  }
}
