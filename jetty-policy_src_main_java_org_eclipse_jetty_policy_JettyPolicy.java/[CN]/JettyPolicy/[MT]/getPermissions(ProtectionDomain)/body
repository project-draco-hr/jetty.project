{
  if (!initialized) {
    refresh();
  }
  if (_cache.containsKey(domain)) {
    return _cache.get(domain);
  }
synchronized (_cache) {
    if (_cache.containsKey(domain)) {
      return _cache.get(domain);
    }
    PermissionCollection perms=new Permissions();
    for (Iterator<PolicyBlock> i=_grants.iterator(); i.hasNext(); ) {
      PolicyBlock policyBlock=i.next();
      ProtectionDomain grantPD=policyBlock.toProtectionDomain();
      if (__DEBUG) {
        System.out.println("----START----");
        System.out.println("PDCS: " + policyBlock.getCodeSource());
        System.out.println("CS: " + domain.getCodeSource());
      }
      if (grantPD.getCodeSource() == null || grantPD.getCodeSource().implies(domain.getCodeSource()) && grantPD.getPrincipals() == null || grantPD.getCodeSource().implies(domain.getCodeSource()) && validate(grantPD.getPrincipals(),domain.getPrincipals())) {
        for (Enumeration<Permission> e=policyBlock.getPermissions().elements(); e.hasMoreElements(); ) {
          Permission perm=e.nextElement();
          if (__DEBUG) {
            System.out.println("D: " + perm);
          }
          perms.add(perm);
        }
      }
      if (__DEBUG) {
        System.out.println("----STOP----");
      }
    }
    _cache.put(domain,perms);
    return perms;
  }
}
