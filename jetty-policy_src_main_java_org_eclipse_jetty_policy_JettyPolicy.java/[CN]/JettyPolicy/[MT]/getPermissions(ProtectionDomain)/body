{
  PermissionCollection perms=new Permissions();
  for (Iterator<ProtectionDomain> i=pdMapping.keySet().iterator(); i.hasNext(); ) {
    ProtectionDomain pd=i.next();
    if (pd.getCodeSource() == null || pd.getCodeSource().implies(domain.getCodeSource()) && pd.getPrincipals() == null || validate(pd.getPrincipals(),domain.getPrincipals())) {
      if (pdMapping.get(pd) != null) {
        for (Enumeration<Permission> e=pdMapping.get(pd).getPermissions().elements(); e.hasMoreElements(); ) {
          perms.add(e.nextElement());
        }
      }
      if (pd.getPermissions() != null) {
        for (Enumeration<Permission> e=pd.getPermissions().elements(); e.hasMoreElements(); ) {
          perms.add(e.nextElement());
        }
      }
    }
  }
  return perms;
}
