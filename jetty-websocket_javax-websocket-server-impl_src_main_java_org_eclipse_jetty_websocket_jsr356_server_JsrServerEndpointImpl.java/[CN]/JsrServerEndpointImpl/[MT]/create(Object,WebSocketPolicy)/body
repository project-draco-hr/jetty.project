{
  Object endpoint=websocket;
  if (websocket instanceof ConfiguredEndpoint) {
    ConfiguredEndpoint ce=(ConfiguredEndpoint)websocket;
    endpoint=ce.getEndpoint();
    if (ce.getConfig() != null) {
      throw new IllegalStateException("Cannot create @ServerEndpoint websocket with an external EndpointConfig");
    }
  }
  Class<?> endpointClass=endpoint.getClass();
  JsrServerMetadata basemetadata=container.getServerEndpointMetadata(endpointClass);
  JsrEvents events=new JsrEvents(basemetadata);
  ServerEndpointConfig config=basemetadata.getEndpointConfigCopy();
  return new JsrAnnotatedEventDriver(policy,endpoint,events,config);
}
