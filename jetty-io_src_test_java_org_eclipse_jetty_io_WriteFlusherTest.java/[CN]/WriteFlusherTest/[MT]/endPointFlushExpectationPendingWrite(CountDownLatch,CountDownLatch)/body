{
  when(_endPointMock.flush(any(ByteBuffer[].class))).thenAnswer(new Answer<Object>(){
    @Override public Object answer(    InvocationOnMock invocation) throws Throwable {
      writeCalledLatch.countDown();
      Object[] arguments=invocation.getArguments();
      ByteBuffer byteBuffer=(ByteBuffer)arguments[0];
      int oldPos=byteBuffer.position();
      if (byteBuffer.remaining() == 2) {
        failedCalledLatch.await(5,TimeUnit.SECONDS);
        BufferUtil.flipToFill(byteBuffer);
      }
 else       if (byteBuffer.remaining() == 3) {
        byteBuffer.position(1);
        return 1;
      }
 else {
        byteBuffer.position(byteBuffer.limit());
      }
      return byteBuffer.limit() - oldPos;
    }
  }
);
}
