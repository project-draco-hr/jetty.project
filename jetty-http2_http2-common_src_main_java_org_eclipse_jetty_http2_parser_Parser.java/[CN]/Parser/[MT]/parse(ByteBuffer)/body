{
  try {
    while (true) {
switch (state) {
case HEADER:
{
          if (!headerParser.parse(buffer))           return;
          if (continuation) {
            if (headerParser.getFrameType() != FrameType.CONTINUATION.getType()) {
              BufferUtil.clear(buffer);
              notifyConnectionFailure(ErrorCode.PROTOCOL_ERROR.code,"continuation_frame_expected");
              return;
            }
            if (headerParser.hasFlag(Flags.END_HEADERS)) {
              continuation=false;
            }
          }
 else {
            if (headerParser.getFrameType() == FrameType.HEADERS.getType() && !headerParser.hasFlag(Flags.END_HEADERS)) {
              continuation=true;
            }
          }
          state=State.BODY;
          break;
        }
case BODY:
{
        int type=headerParser.getFrameType();
        if (LOG.isDebugEnabled())         LOG.debug("Parsing {} frame",FrameType.from(type));
        if (type < 0 || type >= bodyParsers.length) {
          BufferUtil.clear(buffer);
          notifyConnectionFailure(ErrorCode.PROTOCOL_ERROR.code,"unknown_frame_type_" + type);
          return;
        }
        BodyParser bodyParser=bodyParsers[type];
        if (headerParser.getLength() == 0) {
          bodyParser.emptyBody(buffer);
          reset();
          if (!buffer.hasRemaining())           return;
        }
 else {
          if (!bodyParser.parse(buffer))           return;
          if (LOG.isDebugEnabled())           LOG.debug("Parsed {} frame",FrameType.from(type));
          reset();
        }
        break;
      }
default :
{
      throw new IllegalStateException();
    }
}
}
}
 catch (Throwable x) {
if (LOG.isDebugEnabled()) LOG.debug(x);
BufferUtil.clear(buffer);
notifyConnectionFailure(ErrorCode.PROTOCOL_ERROR.code,"parser_error");
}
}
