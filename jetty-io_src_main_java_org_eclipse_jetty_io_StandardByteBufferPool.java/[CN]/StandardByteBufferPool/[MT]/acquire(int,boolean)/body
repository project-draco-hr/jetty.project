{
  int bucket=bucketFor(size);
  ConcurrentMap<Integer,Queue<ByteBuffer>> buffers=buffersFor(direct);
  ByteBuffer result=null;
  Queue<ByteBuffer> byteBuffers=buffers.get(bucket);
  if (byteBuffers != null)   result=byteBuffers.poll();
  if (result == null) {
    int capacity=bucket * factor;
    result=direct ? ByteBuffer.allocateDirect(capacity) : ByteBuffer.allocate(capacity);
  }
  result.clear();
  result.limit(size);
  return result;
}
