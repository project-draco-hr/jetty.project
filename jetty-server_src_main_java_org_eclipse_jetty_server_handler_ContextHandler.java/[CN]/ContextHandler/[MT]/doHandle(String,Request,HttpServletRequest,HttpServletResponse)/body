{
  boolean new_context=false;
  Context old_context=null;
  String old_context_path=null;
  String old_servlet_path=null;
  String old_path_info=null;
  ClassLoader old_classloader=null;
  Thread current_thread=null;
  String pathInfo=null;
  DispatcherType dispatch=request.getDispatcherType();
  old_context=baseRequest.getContext();
  if (old_context != _scontext) {
    new_context=true;
    if (DispatcherType.REQUEST.equals(dispatch) || DispatcherType.ASYNC.equals(dispatch)) {
      if (target.length() > _contextPath.length()) {
        if (_contextPath.length() > 1)         target=target.substring(_contextPath.length());
        pathInfo=target;
      }
 else       if (_contextPath.length() == 1) {
        target=URIUtil.SLASH;
        pathInfo=URIUtil.SLASH;
      }
 else {
        target=URIUtil.SLASH;
        pathInfo=null;
      }
    }
  }
  try {
    old_context_path=baseRequest.getContextPath();
    old_servlet_path=baseRequest.getServletPath();
    old_path_info=baseRequest.getPathInfo();
    baseRequest.setContext(_scontext);
    if (!DispatcherType.INCLUDE.equals(dispatch) && target.startsWith("/")) {
      if (_contextPath.length() == 1)       baseRequest.setContextPath("");
 else       baseRequest.setContextPath(_contextPath);
      baseRequest.setServletPath(null);
      baseRequest.setPathInfo(pathInfo);
    }
    ServletRequestEvent event=null;
    if (new_context) {
      if (_classLoader != null) {
        current_thread=Thread.currentThread();
        old_classloader=current_thread.getContextClassLoader();
        current_thread.setContextClassLoader(_classLoader);
      }
      baseRequest.setRequestListeners(_requestListeners);
      if (_requestAttributeListeners != null) {
        final int s=LazyList.size(_requestAttributeListeners);
        for (int i=0; i < s; i++)         baseRequest.addEventListener(((EventListener)LazyList.get(_requestAttributeListeners,i)));
      }
    }
    try {
      if (DispatcherType.REQUEST.equals(dispatch) && isProtectedTarget(target))       throw new HttpException(HttpServletResponse.SC_NOT_FOUND);
      Handler handler=getHandler();
      if (handler != null)       handler.handle(target,request,response);
    }
 catch (    HttpException e) {
      Log.debug(e);
      response.sendError(e.getStatus(),e.getReason());
    }
 finally {
      if (new_context) {
        baseRequest.takeRequestListeners();
        if (_requestAttributeListeners != null) {
          for (int i=LazyList.size(_requestAttributeListeners); i-- > 0; )           baseRequest.removeEventListener(((EventListener)LazyList.get(_requestAttributeListeners,i)));
        }
      }
    }
  }
  finally {
    if (old_context != _scontext) {
      if (_classLoader != null) {
        current_thread.setContextClassLoader(old_classloader);
      }
      baseRequest.setContext(old_context);
      baseRequest.setContextPath(old_context_path);
      baseRequest.setServletPath(old_servlet_path);
      baseRequest.setPathInfo(old_path_info);
    }
  }
}
