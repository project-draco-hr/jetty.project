{
  final CountDownLatch idle=new CountDownLatch(1);
  TestCB cb=new TestCB(){
    int i=5;
    @Override protected Next process(){
      processed++;
switch (i--) {
case 5:
        succeeded();
      return Next.SCHEDULED;
case 4:
    scheduler.schedule(successTask,5,TimeUnit.MILLISECONDS);
  return Next.SCHEDULED;
case 3:
scheduler.schedule(new Runnable(){
  @Override public void run(){
    idle.countDown();
  }
}
,5,TimeUnit.MILLISECONDS);
return Next.IDLE;
case 2:
succeeded();
return Next.SCHEDULED;
case 1:
scheduler.schedule(successTask,5,TimeUnit.MILLISECONDS);
return Next.SCHEDULED;
case 0:
return Next.SUCCEEDED;
default :
throw new IllegalStateException();
}
}
}
;
cb.iterate();
idle.await(10,TimeUnit.SECONDS);
Assert.assertTrue(cb.isIdle());
cb.iterate();
Assert.assertTrue(cb.waitForComplete());
Assert.assertEquals(6,cb.processed);
}
