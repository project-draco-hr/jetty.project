{
  Buffer buf=buffer.buffer();
  int len=0;
  if (buf instanceof NIOBuffer) {
    final NIOBuffer nbuf=(NIOBuffer)buf;
    final ByteBuffer bbuf=nbuf.getByteBuffer();
    try {
synchronized (bbuf) {
        try {
          bbuf.position(buffer.putIndex());
          len=_channel.read(bbuf);
          LOG.debug("{} {} {} read={}",this.getChannel().isOpen(),this.isInputShutdown(),this.isOutputShutdown(),this.getChannel().isOpen(),len);
        }
  finally {
          buffer.setPutIndex(bbuf.position());
          bbuf.position(0);
        }
      }
      if (len < 0 && isOpen()) {
        if (!isInputShutdown())         shutdownInput();
 else         if (isOutputShutdown())         _channel.close();
      }
    }
 catch (    IOException x) {
      LOG.debug(x);
      try {
        close();
      }
 catch (      IOException xx) {
        LOG.ignore(xx);
      }
      if (len > 0)       throw x;
      len=-1;
    }
  }
 else {
    throw new IOException("Not Implemented");
  }
  return len;
}
