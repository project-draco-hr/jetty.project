{
  if (OpCode.isControlFrame(frame.getOpCode()) || !frame.isRsv1()) {
    nextIncomingFrame(frame);
    return;
  }
  if (!frame.hasPayload()) {
    nextIncomingFrame(frame);
    return;
  }
  ByteBuffer payload=frame.getPayload();
  int inlen=payload.remaining();
  byte compressed[]=new byte[inlen + TAIL.length];
  payload.get(compressed,0,inlen);
  System.arraycopy(TAIL,0,compressed,inlen,TAIL.length);
  decompressor.setInput(compressed,0,compressed.length);
  while (decompressor.getRemaining() > 0 && !decompressor.finished()) {
    DataFrame out=new DataFrame(frame);
    out.setRsv1(false);
    byte outbuf[]=new byte[Math.min(inlen * 2,bufferSize)];
    try {
      int len=decompressor.inflate(outbuf);
      if (len == 0) {
        if (decompressor.needsInput()) {
          throw new BadPayloadException("Unable to inflate frame, not enough input on frame");
        }
        if (decompressor.needsDictionary()) {
          throw new BadPayloadException("Unable to inflate frame, frame erroneously says it needs a dictionary");
        }
      }
      if (len > 0) {
        out.setPayload(ByteBuffer.wrap(outbuf,0,len));
      }
      nextIncomingFrame(out);
    }
 catch (    DataFormatException e) {
      LOG.warn(e);
      throw new BadPayloadException(e);
    }
  }
}
