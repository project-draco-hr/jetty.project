{
  String uri=request.getRequestURI();
  String query=request.getQueryString();
  if (query != null && query.length() > 0)   uri+="?" + query;
  String host=request.getHeader("Host");
  String origin=request.getHeader("Host");
  String key1=request.getHeader("Sec-WebSocket-Key1");
  if (key1 != null) {
    String key2=request.getHeader("Sec-WebSocket-Key2");
    setHixieKeys(key1,key2);
    response.setHeader("Upgrade","WebSocket");
    response.addHeader("Connection","Upgrade");
    response.addHeader("Sec-WebSocket-Origin",origin);
    response.addHeader("Sec-WebSocket-Location",(request.isSecure() ? "wss://" : "ws://") + host + uri);
    if (subprotocol != null)     response.addHeader("Sec-WebSocket-Protocol",subprotocol);
    response.sendError(101,"WebSocket Protocol Handshake");
  }
 else {
    response.setHeader("Upgrade","WebSocket");
    response.addHeader("Connection","Upgrade");
    response.addHeader("WebSocket-Origin",origin);
    response.addHeader("WebSocket-Location",(request.isSecure() ? "wss://" : "ws://") + host + uri);
    if (subprotocol != null)     response.addHeader("WebSocket-Protocol",subprotocol);
    response.sendError(101,"Web Socket Protocol Handshake");
    response.flushBuffer();
    if (_websocket instanceof OnFrame)     ((OnFrame)_websocket).onHandshake(this);
    _websocket.onOpen(this);
  }
}
