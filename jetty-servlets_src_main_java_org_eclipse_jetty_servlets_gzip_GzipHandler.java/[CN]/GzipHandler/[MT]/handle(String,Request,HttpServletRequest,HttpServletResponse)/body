{
  LOG.debug("{} doFilter {}",this,request);
  String requestURI=request.getRequestURI();
  if (!_methods.contains(request.getMethod())) {
    LOG.debug("{} excluded by method {}",this,request);
    _handler.handle(target,baseRequest,request,response);
    return;
  }
  if (isExcludedPath(requestURI)) {
    LOG.debug("{} excluded by path {}",this,request);
    _handler.handle(target,baseRequest,request,response);
    return;
  }
  if (_mimeTypes.size() > 0 && _excludeMimeTypes) {
    ServletContext context=request.getServletContext();
    String mimeType=context == null ? _knownMimeTypes.getMimeByExtension(request.getRequestURI()) : context.getMimeType(request.getRequestURI());
    if (mimeType != null) {
      mimeType=MimeTypes.getContentTypeWithoutCharset(mimeType);
      if (_mimeTypes.contains(mimeType)) {
        LOG.debug("{} excluded by path suffix {}",this,request);
        _handler.handle(target,baseRequest,request,response);
        return;
      }
    }
  }
  if (response.getHeader("Content-Encoding") != null) {
    _handler.handle(target,baseRequest,request,response);
    return;
  }
  if (_checkGzExists && request.getServletContext() != null) {
    String path=request.getServletContext().getRealPath(URIUtil.addPaths(request.getServletPath(),request.getPathInfo()));
    if (path != null) {
      File gz=new File(path + ".gz");
      if (gz.exists()) {
        LOG.debug("{} gzip exists {}",this,request);
        _handler.handle(target,baseRequest,request,response);
        return;
      }
    }
  }
  String etag=request.getHeader("If-None-Match");
  if (etag != null) {
    if (etag.contains(ETAG_GZIP))     request.setAttribute(ETAG,etag.replace(ETAG_GZIP,""));
  }
  HttpChannel channel=HttpChannel.getCurrentHttpChannel();
  HttpOutput out=channel.getResponse().getHttpOutput();
  out.setFilter(new GzipHttpOutputInterceptor(this,channel,out.getFilter()));
  _handler.handle(target,baseRequest,request,response);
}
