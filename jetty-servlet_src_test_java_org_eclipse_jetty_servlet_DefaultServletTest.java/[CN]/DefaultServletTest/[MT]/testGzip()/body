{
  testdir.ensureEmpty();
  File resBase=testdir.getPathFile("docroot").toFile();
  FS.ensureDirExists(resBase);
  File file0=new File(resBase,"data0.txt");
  createFile(file0,"Hello Text 0");
  File file0gz=new File(resBase,"data0.txt.gz");
  createFile(file0gz,"fake gzip");
  String resBasePath=resBase.getAbsolutePath();
  ServletHolder defholder=context.addServlet(DefaultServlet.class,"/");
  defholder.setInitParameter("dirAllowed","false");
  defholder.setInitParameter("redirectWelcome","false");
  defholder.setInitParameter("welcomeServlets","false");
  defholder.setInitParameter("gzip","true");
  defholder.setInitParameter("etags","true");
  defholder.setInitParameter("resourceBase",resBasePath);
  String response=connector.getResponses("GET /context/data0.txt HTTP/1.0\r\nHost:localhost:8080\r\n\r\n");
  assertResponseContains("Content-Length: 12",response);
  assertResponseContains("Content-Type: text/plain",response);
  assertResponseContains("Hello Text 0",response);
  assertResponseContains("Vary: Accept-Encoding",response);
  assertResponseContains("ETag: ",response);
  assertResponseNotContains("Content-Encoding: gzip",response);
  int e=response.indexOf("ETag: ");
  String etag=response.substring(e + 6,response.indexOf('"',e + 11) + 1);
  String etag_gzip=etag.substring(0,etag.length() - 1) + "--gzip\"";
  response=connector.getResponses("GET /context/data0.txt HTTP/1.0\r\nHost:localhost:8080\r\nAccept-Encoding:gzip\r\n\r\n");
  assertResponseContains("Content-Length: 9",response);
  assertResponseContains("fake gzip",response);
  assertResponseContains("Content-Type: text/plain",response);
  assertResponseContains("Vary: Accept-Encoding",response);
  assertResponseContains("Content-Encoding: gzip",response);
  assertResponseContains("ETag: " + etag_gzip,response);
  response=connector.getResponses("GET /context/data0.txt.gz HTTP/1.0\r\nHost:localhost:8080\r\nAccept-Encoding:gzip\r\n\r\n");
  assertResponseContains("Content-Length: 9",response);
  assertResponseContains("fake gzip",response);
  assertResponseContains("Content-Type: application/gzip",response);
  assertResponseNotContains("Vary: Accept-Encoding",response);
  assertResponseNotContains("Content-Encoding: gzip",response);
  assertResponseNotContains("ETag: " + etag_gzip,response);
  assertResponseContains("ETag: ",response);
}
