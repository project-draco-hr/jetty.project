{
  SocketChannel channel=connect(request,host,port);
  channel.configureBlocking(false);
  HttpConnection httpConnection=HttpConnection.getCurrentConnection();
  Buffer headerBuffer=((HttpParser)httpConnection.getParser()).getHeaderBuffer();
  Buffer bodyBuffer=((HttpParser)httpConnection.getParser()).getBodyBuffer();
  int length=headerBuffer == null ? 0 : headerBuffer.length();
  length+=bodyBuffer == null ? 0 : bodyBuffer.length();
  IndirectNIOBuffer buffer=null;
  if (length > 0) {
    buffer=new IndirectNIOBuffer(length);
    if (headerBuffer != null) {
      buffer.put(headerBuffer);
      headerBuffer.clear();
    }
    if (bodyBuffer != null) {
      buffer.put(bodyBuffer);
      bodyBuffer.clear();
    }
  }
  ProxyToServerConnection proxyToServer=new ProxyToServerConnection(secure,buffer);
  ClientToProxyConnection clientToProxy=new ClientToProxyConnection(channel,httpConnection.getEndPoint(),httpConnection.getTimeStamp());
  clientToProxy.setConnection(proxyToServer);
  proxyToServer.setConnection(clientToProxy);
  upgradeConnection(request,response,clientToProxy);
}
