{
  final Socket socket=new Socket("localhost",__connector.getLocalPort());
  OutputStream output=socket.getOutputStream();
  final int count=100000;
  output.write(("GET /chat HTTP/1.1\r\n" + "Host: server.example.com\r\n" + "Upgrade: websocket\r\n"+ "Connection: Upgrade\r\n"+ "Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==\r\n"+ "Sec-WebSocket-Origin: http://example.com\r\n"+ "Sec-WebSocket-Protocol: latch\r\n"+ "Sec-WebSocket-Version: 8\r\n"+ "\r\n").getBytes("ISO-8859-1"));
  output.flush();
  socket.setSoTimeout(60000);
  InputStream input=socket.getInputStream();
  lookFor("HTTP/1.1 101 Switching Protocols\r\n",input);
  skipTo("Sec-WebSocket-Accept: ",input);
  lookFor("s3pPLMBiTxaQ9kYGzzhZRbK+xOo=",input);
  skipTo("\r\n\r\n",input);
  assertTrue(__serverWebSocket.awaitConnected(1000));
  assertNotNull(__serverWebSocket.connection);
  __serverWebSocket.connection.setMaxIdleTime(60000);
  __latch.countDown();
  final AtomicLong totalB=new AtomicLong();
  new Thread(){
    public void run(){
      try {
        Thread.sleep(2000);
        byte[] recv=new byte[32 * 1024];
        int len=0;
        while (len >= 0) {
          totalB.addAndGet(len);
          len=socket.getInputStream().read(recv,0,recv.length);
          Thread.sleep(10);
        }
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
    }
  }
.start();
  long start=System.currentTimeMillis();
  String mesg="How Now Brown Cow";
  for (int i=0; i < count; i++) {
    __serverWebSocket.connection.sendMessage(mesg);
    if (i % 100 == 0)     output.flush();
  }
  long duration=System.currentTimeMillis() - start;
  while (totalB.get() < (count * (mesg.length() + 2)))   Thread.sleep(100);
  assertEquals(count * (mesg.length() + 2),totalB.get());
  System.err.println("max=" + duration);
  assertTrue(duration > 1500);
}
