{
  String contextPath="";
  String servletMapping="/server";
  int inactivePeriod=200;
  int scavengePeriod=3;
  int idlePeriod=5;
  File storeDir=new File(System.getProperty("java.io.tmpdir"),"idle-test");
  storeDir.deleteOnExit();
  HashTestServer server1=createServer(0,inactivePeriod,scavengePeriod,idlePeriod,storeDir);
  TestServlet servlet=new TestServlet();
  ServletHolder holder=new ServletHolder(servlet);
  ServletContextHandler contextHandler=server1.addContext(contextPath);
  contextHandler.addServlet(holder,servletMapping);
  server1.start();
  int port1=server1.getPort();
  try {
    HttpClient client=new HttpClient();
    client.setConnectorType(HttpClient.CONNECTOR_SOCKET);
    client.start();
    String url="http://localhost:" + port1 + contextPath+ servletMapping;
    ContentExchange exchange1=new ContentExchange(true);
    exchange1.setMethod(HttpMethods.GET);
    exchange1.setURL(url + "?action=init");
    client.send(exchange1);
    exchange1.waitForDone();
    assertEquals(HttpServletResponse.SC_OK,exchange1.getResponseStatus());
    String sessionCookie=exchange1.getResponseFields().getStringField("Set-Cookie");
    assertTrue(sessionCookie != null);
    sessionCookie=sessionCookie.replaceFirst("(\\W)(P|p)ath=","$1\\$Path=");
    pause(scavengePeriod * 2);
    checkSessionIdled(storeDir);
    ContentExchange exchange2=new ContentExchange(true);
    exchange2.setMethod(HttpMethods.GET);
    exchange2.setURL(url + "?action=test");
    exchange2.getRequestFields().add("Cookie",sessionCookie);
    client.send(exchange2);
    exchange2.waitForDone();
    assertEquals(HttpServletResponse.SC_OK,exchange2.getResponseStatus());
    checkSessionDeIdled(storeDir);
  }
  finally {
    server1.stop();
    IO.delete(storeDir);
  }
}
