{
  Handler handler=new Handler();
  HttpGenerator gen=new HttpGenerator();
  String t=run.toString();
  run.tr.getHttpFields().clear();
  String response=run.tr.build(run.httpVersion,gen,"OK\r\nTest",run.connection.val,null,run.chunks);
  if (run.httpVersion == 9) {
    assertFalse(t,gen.isPersistent());
    if (run.tr._body != null)     assertEquals(t,run.tr._body,response);
    return;
  }
  HttpParser parser=new HttpParser(handler);
  parser.setHeadResponse(run.tr._head);
  parser.parseNext(BufferUtil.toBuffer(response));
  if (run.tr._body != null)   assertEquals(t,run.tr._body,this._content);
  if (run.httpVersion == 10)   assertTrue(t,gen.isPersistent() || run.tr._contentLength >= 0 || run.connection == ConnectionType.CLOSE || run.connection == ConnectionType.NONE);
 else   assertTrue(t,gen.isPersistent() || run.connection == ConnectionType.CLOSE || run.connection == ConnectionType.TE_CLOSE);
  if (run.httpVersion > 9)   assertEquals("OK??Test",_reason);
  if (_content == null)   assertTrue(t,run.tr._body == null);
 else   assertThat(t,run.tr._contentLength,either(equalTo(_content.length())).or(equalTo(-1)));
}
