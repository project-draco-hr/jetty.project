{
  _server=new Server();
  _server.setGracefulShutdown(500);
  Connector connector=new SelectChannelConnector();
  connector.setPort(0);
  _server.setConnectors(new Connector[]{connector});
  Constraint constraint=new Constraint();
  constraint.setName("Need User or Admin");
  constraint.setRoles(new String[]{"user","admin"});
  constraint.setAuthenticate(true);
  ConstraintMapping cm=new ConstraintMapping();
  cm.setConstraint(constraint);
  cm.setPathSpec("/*");
  LoginService loginService=new HashLoginService("MyRealm","src/test/resources/realm.properties");
  ConstraintSecurityHandler sh=new ConstraintSecurityHandler();
  sh.setLoginService(loginService);
  sh.setAuthenticator(new BasicAuthenticator());
  _server.setHandler(sh);
  Handler testHandler=new AbstractHandler(){
    public void handle(    String target,    Request baseRequest,    HttpServletRequest request,    HttpServletResponse response) throws IOException, ServletException {
      baseRequest.setHandled(true);
      response.setStatus(200);
      if (request.getServerName().equals("jetty.eclipse.org")) {
        response.getOutputStream().println("Proxy request: " + request.getRequestURL());
      }
 else       if (request.getMethod().equalsIgnoreCase("GET")) {
        response.getOutputStream().println("<hello>");
        for (int i=0; i < 100; i++) {
          response.getOutputStream().println("  <world>" + i + "</world>");
          if (i % 20 == 0)           response.getOutputStream().flush();
        }
        response.getOutputStream().println("</hello>");
      }
 else {
        copyStream(request.getInputStream(),response.getOutputStream());
      }
    }
  }
;
  sh.setHandler(testHandler);
  _server.start();
  _port=connector.getLocalPort();
}
