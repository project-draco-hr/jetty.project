{
  boolean isHeadRequest=HttpMethod.HEAD.is(request.getMethod());
  boolean hasContent=BufferUtil.hasContent(content) && !isHeadRequest;
  boolean sendContent=hasContent || (info == null && lastContent);
  if (info != null) {
    if (commit.compareAndSet(false,true)) {
      if (sendContent) {
        commit(info,false,commitCallback);
        send(content,lastContent,callback);
      }
 else {
        commit(info,lastContent,callback);
      }
    }
 else {
      callback.failed(new IllegalStateException());
    }
  }
 else {
    if (sendContent) {
      send(content,lastContent,callback);
    }
 else {
      callback.succeeded();
    }
  }
}
