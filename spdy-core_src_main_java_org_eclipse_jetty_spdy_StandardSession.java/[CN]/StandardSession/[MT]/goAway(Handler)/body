{
  if (goAwaySent.compareAndSet(false,true)) {
    if (!goAwayReceived.get()) {
      try {
        GoAwayFrame frame=new GoAwayFrame(version,lastStreamId,SessionStatus.OK.getCode());
        control(null,frame,handler);
        flush();
        return;
      }
 catch (      StreamException x) {
        handler.failed(x);
        throw new SPDYException(x);
      }
    }
  }
  handler.completed();
}
