{
  try {
    ByteBuffer buffer=BufferUtil.allocate(4);
    int filled=getEndPoint().fill(buffer);
    Assert.assertEquals(4,filled);
    Assert.assertArrayEquals(CAFE_BABE,buffer.array());
    getEndPoint().write(Callback.NOOP,buffer);
    getEndPoint().upgrade(connectionFactory.newConnection(connector,getEndPoint()));
  }
 catch (  Throwable x) {
    close();
  }
}
