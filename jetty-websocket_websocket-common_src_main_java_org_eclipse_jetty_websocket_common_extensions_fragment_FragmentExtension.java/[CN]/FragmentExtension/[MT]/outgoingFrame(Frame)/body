{
  if (frame.getType().isControl()) {
    return nextOutgoingFrame(frame);
  }
  int length=frame.getPayloadLength();
  byte opcode=frame.getType().getOpCode();
  ByteBuffer payload=frame.getPayload().slice();
  int originalLimit=payload.limit();
  int currentPosition=payload.position();
  if (maxLength <= 0) {
    return nextOutgoingFrame(frame);
  }
  boolean continuation=false;
  while (length > maxLength) {
    WebSocketFrame frag=new WebSocketFrame(frame);
    frag.setOpCode(opcode);
    frag.setFin(false);
    frag.setContinuation(continuation);
    payload.position(currentPosition);
    payload.limit(Math.min(payload.position() + maxLength,originalLimit));
    frag.setPayload(payload);
    nextOutgoingFrame(frag);
    length-=maxLength;
    opcode=OpCode.CONTINUATION;
    continuation=true;
    currentPosition=payload.limit();
  }
  WebSocketFrame frag=new WebSocketFrame(frame);
  frag.setOpCode(opcode);
  frag.setFin(frame.isFin());
  frag.setContinuation(continuation);
  payload.position(currentPosition);
  payload.limit(originalLimit);
  frag.setPayload(payload);
  return nextOutgoingFrame(frag);
}
