{
  FrameBytes frameBytes=null;
  ByteBuffer buffer=null;
synchronized (queue) {
    if (flushing || queue.isEmpty())     return;
    Set<IStream> stalledStreams=null;
    Iterator<FrameBytes> iter=queue.iterator();
    while (iter.hasNext()) {
      frameBytes=iter.next();
      IStream stream=frameBytes.getStream();
      if (stream != null && stalledStreams != null && stalledStreams.contains(stream))       continue;
      buffer=frameBytes.getByteBuffer();
      if (buffer != null) {
        iter.remove();
        if (stream != null && stream.isReset()) {
          frameBytes.fail(new StreamException(stream.getId(),StreamStatus.INVALID_STREAM,"Stream: " + stream + " is reset!"));
          return;
        }
        break;
      }
      if (stalledStreams == null)       stalledStreams=new HashSet<>();
      if (stream != null)       stalledStreams.add(stream);
      LOG.debug("Flush stalled for {}, {} frame(s) in queue",frameBytes,queue.size());
    }
    if (buffer == null)     return;
    flushing=true;
    LOG.debug("Flushing {}, {} frame(s) in queue",frameBytes,queue.size());
  }
  write(buffer,frameBytes);
}
