{
  FrameBytes frameBytes=null;
  ByteBuffer buffer=null;
synchronized (queue) {
    if (flushing || queue.isEmpty())     return;
    Set<IStream> stalledStreams=null;
    for (int i=0; i < queue.size(); ++i) {
      frameBytes=queue.get(i);
      if (stalledStreams != null && stalledStreams.contains(frameBytes.getStream()))       continue;
      buffer=frameBytes.getByteBuffer();
      if (buffer != null) {
        queue.remove(i);
        break;
      }
      if (stalledStreams == null)       stalledStreams=new HashSet<>();
      stalledStreams.add(frameBytes.getStream());
      logger.debug("Flush stalled for {}, {} frame(s) in queue",frameBytes,queue.size());
    }
    if (buffer == null)     return;
    flushing=true;
    logger.debug("Flushing {}, {} frame(s) in queue",frameBytes,queue.size());
  }
  write(buffer,this,frameBytes);
}
