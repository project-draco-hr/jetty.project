{
  FrameBytes frameBytes;
  ByteBuffer buffer;
synchronized (queue) {
    if (flushing)     return;
    frameBytes=queue.poll();
    if (frameBytes == null)     return;
    FrameBytes stalled=null;
    while (true) {
      buffer=frameBytes.getByteBuffer();
      if (buffer != null)       break;
      enqueueLast(frameBytes);
      if (stalled == null)       stalled=frameBytes;
 else       if (stalled == frameBytes)       return;
      logger.debug("Flush stalled for {}, {} frame(s) in queue",frameBytes,queue.size());
      frameBytes=queue.poll();
    }
    flushing=true;
    logger.debug("Flushing {}, {} frame(s) in queue",frameBytes,queue.size());
  }
  logger.debug("Writing {} frame bytes of {}",buffer.remaining(),frameBytes);
  write(buffer,this,frameBytes);
}
