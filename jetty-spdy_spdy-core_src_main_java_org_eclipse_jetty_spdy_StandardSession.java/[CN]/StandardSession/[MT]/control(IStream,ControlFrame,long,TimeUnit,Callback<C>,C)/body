{
  try {
    if (stream != null) {
      updateLastStreamId(stream);
      if (stream.isClosed())       removeStream(stream);
    }
synchronized (this) {
      ByteBuffer buffer=generator.control(frame);
      logger.debug("Queuing {} on {}",frame,stream);
      ControlFrameBytes<C> frameBytes=new ControlFrameBytes<>(stream,callback,context,frame,buffer);
      if (timeout > 0)       frameBytes.task=scheduler.schedule(frameBytes,timeout,unit);
      if (ControlFrameType.PING == frame.getType())       prepend(frameBytes);
 else       append(frameBytes);
    }
    flush();
  }
 catch (  Throwable x) {
    notifyHandlerFailed(callback,context,x);
  }
}
