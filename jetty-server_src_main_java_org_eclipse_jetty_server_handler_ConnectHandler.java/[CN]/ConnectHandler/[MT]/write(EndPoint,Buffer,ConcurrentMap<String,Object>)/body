{
  if (buffer == null)   return 0;
  int length=buffer.length();
  final StringBuilder debug=LOG.isDebugEnabled() ? new StringBuilder() : null;
  int flushed=endPoint.flush(buffer);
  if (debug != null)   debug.append(flushed);
  while (buffer.length() > 0 && !endPoint.isOutputShutdown()) {
    if (!endPoint.isBlocking()) {
      boolean ready=endPoint.blockWritable(getWriteTimeout());
      if (!ready)       throw new IOException("Write timeout");
    }
    flushed=endPoint.flush(buffer);
    if (debug != null)     debug.append("+").append(flushed);
  }
  LOG.debug("Written {}/{} bytes {}",debug,length,endPoint);
  buffer.compact();
  return length;
}
