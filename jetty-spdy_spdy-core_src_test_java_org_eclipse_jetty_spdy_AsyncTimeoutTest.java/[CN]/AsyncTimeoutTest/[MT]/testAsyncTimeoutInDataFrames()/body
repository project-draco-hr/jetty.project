{
  final long timeout=1000;
  final TimeUnit unit=TimeUnit.MILLISECONDS;
  ByteBufferPool bufferPool=new MappedByteBufferPool();
  Executor threadPool=Executors.newCachedThreadPool();
  Scheduler scheduler=new TimerScheduler();
  scheduler.start();
  Generator generator=new Generator(bufferPool,new StandardCompressionFactory.StandardCompressor());
  Session session=new StandardSession(SPDY.V2,bufferPool,threadPool,scheduler,new TestController(),null,null,1,null,generator,new FlowControlStrategy.None()){
    @Override protected void write(    ByteBuffer buffer,    Callback callback){
      try {
        if (buffer.get(0) == 0)         unit.sleep(2 * timeout);
        super.write(buffer,callback);
      }
 catch (      InterruptedException x) {
        throw new SPDYException(x);
      }
    }
  }
;
  Stream stream=session.syn(new SynInfo(false),null).get(5,TimeUnit.SECONDS);
  final CountDownLatch failedLatch=new CountDownLatch(1);
  stream.data(new StringDataInfo("data",true),timeout,unit,new Callback.Adapter(){
    @Override public void failed(    Throwable x){
      failedLatch.countDown();
    }
  }
);
  Assert.assertTrue(failedLatch.await(2 * timeout,unit));
}
