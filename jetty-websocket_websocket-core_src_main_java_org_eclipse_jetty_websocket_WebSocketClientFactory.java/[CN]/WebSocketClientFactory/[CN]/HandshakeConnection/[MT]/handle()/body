{
  while (_endp.isOpen() && !_parser.isComplete()) {
    if (_handshake == null || _handshake.length() > 0)     if (!handshake())     return this;
    if (!_parser.parseAvailable()) {
      if (_endp.isInputShutdown())       _future.handshakeFailed(new IOException("Incomplete handshake response"));
      return this;
    }
  }
  if (_error == null) {
    if (_accept == null) {
      _error="No Sec-WebSocket-Accept";
    }
 else     if (!WebSocketConnectionRFC6455.hashKey(_key).equals(_accept)) {
      _error="Bad Sec-WebSocket-Accept";
    }
 else {
      WebSocketConnection connection=newWebSocketConnection();
      ByteBuffer header=_parser.getHeaderBuffer();
      if (header.hasContent())       connection.fillBuffersFrom(header);
      _buffers.returnBuffer(header);
      _future.onConnection(connection);
      return connection;
    }
  }
  _endp.close();
  return this;
}
