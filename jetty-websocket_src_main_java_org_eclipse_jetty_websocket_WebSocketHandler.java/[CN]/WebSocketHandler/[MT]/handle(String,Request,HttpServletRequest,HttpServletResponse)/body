{
  if ("websocket".equalsIgnoreCase(request.getHeader("Upgrade"))) {
    String protocol=request.getHeader("Sec-WebSocket-Protocol");
    if (protocol == null)     protocol=request.getHeader("WebSocket-Protocol");
    WebSocket websocket=null;
    for (    String p : WebSocketFactory.parseProtocols(protocol)) {
      websocket=doWebSocketConnect(request,p);
      if (websocket != null) {
        protocol=p;
        break;
      }
    }
    String host=request.getHeader("Host");
    String origin=request.getHeader("Origin");
    origin=checkOrigin(request,host,origin);
    if (websocket != null)     _webSocketFactory.upgrade(request,response,websocket,origin,protocol);
 else     response.sendError(503);
  }
 else {
    super.handle(target,baseRequest,request,response);
  }
}
