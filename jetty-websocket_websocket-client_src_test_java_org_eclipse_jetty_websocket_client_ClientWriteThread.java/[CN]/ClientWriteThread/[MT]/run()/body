{
  final AtomicInteger m=new AtomicInteger();
  try {
    LOG.debug("Writing {} messages to connection {}",messageCount);
    LOG.debug("Artificial Slowness {} ms",slowness);
    Future<Void> lastMessage=null;
    while (m.get() < messageCount) {
      lastMessage=conn.write(message + "/" + m.get()+ "/");
      m.incrementAndGet();
      if (slowness > 0) {
        TimeUnit.MILLISECONDS.sleep(slowness);
      }
    }
    lastMessage.get(2,TimeUnit.MINUTES);
  }
 catch (  InterruptedException|ExecutionException|TimeoutException e) {
    LOG.warn(e);
  }
}
