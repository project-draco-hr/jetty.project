{
  if (_deflater.needsInput()) {
    if (_deflater.finished()) {
      _factory.recycle(_deflater);
      _deflater=null;
      getHttpChannel().getByteBufferPool().release(_buffer);
      _buffer=null;
      return Next.SUCCEEDED;
    }
    if (!_complete)     return Next.SUCCEEDED;
  }
  BufferUtil.compact(_buffer);
  int off=_buffer.arrayOffset() + _buffer.limit();
  int len=_buffer.capacity() - _buffer.limit() - (_complete ? 8 : 0);
  int produced=_deflater.deflate(_buffer.array(),off,len,Deflater.NO_FLUSH);
  _buffer.limit(_buffer.limit() + produced);
  boolean complete=_deflater.finished();
  if (complete)   addTrailer();
  superWrite(_buffer,complete,this);
  return Next.SCHEDULED;
}
