{
  if (_deflater.needsInput()) {
    if (BufferUtil.isEmpty(_content)) {
      if (_deflater.finished()) {
        _factory.recycle(_deflater);
        _deflater=null;
        getHttpChannel().getByteBufferPool().release(_buffer);
        _buffer=null;
        return Action.SUCCEEDED;
      }
      if (!_complete)       return Action.SUCCEEDED;
    }
 else {
      BufferUtil.clearToFill(_input);
      BufferUtil.put(_content,_input);
      BufferUtil.flipToFlush(_input,0);
      byte[] array=_input.array();
      int off=_input.arrayOffset() + _input.position();
      int len=_input.remaining();
      _crc.update(array,off,len);
      _deflater.setInput(array,off,len);
      if (_complete && BufferUtil.isEmpty(_content))       _deflater.finish();
    }
  }
  BufferUtil.compact(_buffer);
  int off=_buffer.arrayOffset() + _buffer.limit();
  int len=_buffer.capacity() - _buffer.limit() - (_complete ? 8 : 0);
  int produced=_deflater.deflate(_buffer.array(),off,len,Deflater.NO_FLUSH);
  _buffer.limit(_buffer.limit() + produced);
  boolean complete=_deflater.finished();
  if (complete)   addTrailer();
  superWrite(_buffer,complete,this);
  return Action.EXECUTING;
}
