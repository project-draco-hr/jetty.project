{
  List<String> protocols=this.protocols;
  if (protocols.isEmpty()) {
    protocols=connector.getProtocols();
    Iterator<String> i=protocols.iterator();
    while (i.hasNext()) {
      String protocol=i.next();
      String prefix="ssl-";
      if (protocol.regionMatches(true,0,prefix,0,prefix.length()) || protocol.equalsIgnoreCase("alpn")) {
        i.remove();
      }
    }
  }
  String dft=defaultProtocol;
  if (dft == null && !protocols.isEmpty())   dft=protocols.get(0);
  SSLEngine engine=null;
  EndPoint ep=endPoint;
  while (engine == null && ep != null) {
    if (ep instanceof SslConnection.DecryptedEndPoint)     engine=((SslConnection.DecryptedEndPoint)ep).getSslConnection().getSSLEngine();
 else     ep=null;
  }
  return configure(newServerConnection(connector,endPoint,engine,protocols,dft),connector,endPoint);
}
