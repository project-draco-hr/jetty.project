{
  int origLimit=buf.limit();
  int limit=buf.limit();
  int len;
  int pos=buf.position();
  int overallLeft=buf.remaining();
  while (overallLeft > 0) {
    buf.position(pos);
    limit=Math.min(origLimit,pos + segmentSize);
    buf.limit(limit);
    len=buf.remaining();
    overallLeft-=len;
    pos+=len;
    writeRaw(buf);
    flush();
  }
}
