{
  String respHeader=readResponseHeader();
  if (LOG.isDebugEnabled()) {
    LOG.debug("Response Header: {}{}",'\n',respHeader);
  }
  Assert.assertThat("Response Code",respHeader,startsWith("HTTP/1.1 101 Switching Protocols"));
  Assert.assertThat("Response Header Upgrade",respHeader,containsString("Upgrade: WebSocket\r\n"));
  Assert.assertThat("Response Header Connection",respHeader,containsString("Connection: Upgrade\r\n"));
  List<ExtensionConfig> configs=getExtensionConfigs(respHeader);
  ExtensionStack extensionStack=new ExtensionStack(this.extensionFactory);
  extensionStack.negotiate(configs);
  extensionStack.setNextIncoming(this);
  extensionStack.setNextOutgoing(this);
  extensionStack.configure(parser);
  extensionStack.configure(generator);
  try {
    extensionStack.start();
  }
 catch (  Exception e) {
    throw new IOException("Unable to start Extension Stack");
  }
  parser.setIncomingFramesHandler(extensionStack);
  return respHeader;
}
