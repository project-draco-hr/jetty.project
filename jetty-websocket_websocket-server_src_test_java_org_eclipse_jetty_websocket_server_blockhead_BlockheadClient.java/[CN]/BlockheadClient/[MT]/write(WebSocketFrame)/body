{
  LOG.debug("write(Frame->{})",frame);
  frame.setMask(clientmask);
  ByteBuffer buf=generator.generate(frame);
  BufferUtil.flipToFlush(buf,0);
  if (LOG.isDebugEnabled()) {
    LOG.debug("writing out: {}",BufferUtil.toDetailString(buf));
  }
  byte arr[]=BufferUtil.toArray(buf);
  out.write(arr,0,arr.length);
  out.flush();
  if (frame.getOpCode() == OpCode.CLOSE) {
    disconnect();
  }
}
