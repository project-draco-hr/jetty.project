{
  if (!"WebSocket".equals(request.getHeader("Upgrade")))   throw new IllegalStateException("!Upgrade:websocket");
  if (!"HTTP/1.1".equals(request.getProtocol()))   throw new IllegalStateException("!HTTP/1.1");
  int draft=request.getIntHeader("Sec-WebSocket-Draft");
  HttpConnection http=HttpConnection.getCurrentConnection();
  ConnectedEndPoint endp=(ConnectedEndPoint)http.getEndPoint();
  final WebSocketConnection connection;
switch (draft) {
default :
    connection=new WebSocketConnectionD00(websocket,endp,_buffers,http.getTimeStamp(),_maxIdleTime,draft);
}
connection.handshake(request,response,origin,subprotocol);
response.flushBuffer();
connection.fillBuffersFrom(((HttpParser)http.getParser()).getHeaderBuffer());
connection.fillBuffersFrom(((HttpParser)http.getParser()).getBodyBuffer());
request.setAttribute("org.eclipse.jetty.io.Connection",connection);
}
