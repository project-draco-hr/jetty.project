{
  HpackEncoder encoder=new HpackEncoder(38 * 5);
  HttpFields fields=new HttpFields();
  HttpField[] field={new HttpField("fo0","b0r"),new HttpField("fo1","b1r"),new HttpField("fo2","b2r"),new HttpField("fo3","b3r"),new HttpField("fo4","b4r"),new HttpField("fo5","b5r"),new HttpField("fo6","b6r"),new HttpField("fo7","b7r"),new HttpField("fo8","b8r"),new HttpField("fo9","b9r"),new HttpField("foA","bAr")};
  for (int i=0; i <= 3; i++)   fields.add(field[i]);
  ByteBuffer buffer=BufferUtil.allocate(4096);
  int pos=BufferUtil.flipToFill(buffer);
  encoder.encode(buffer,new MetaData(HttpVersion.HTTP_2_0,fields));
  BufferUtil.flipToFlush(buffer,pos);
  assertThat(buffer.remaining(),Matchers.greaterThan(0));
  Assert.assertEquals(4,encoder.getContext().size());
  HashSet<HttpField> refSet=new HashSet<>();
  for (  Entry entry : encoder.getContext().getReferenceSet())   refSet.add(entry.getHttpField());
  Assert.assertEquals(4,refSet.size());
  for (int i=0; i <= 3; i++)   Assert.assertTrue(refSet.contains(field[i]));
  BufferUtil.clearToFill(buffer);
  encoder.encode(buffer,new MetaData(HttpVersion.HTTP_2_0,fields));
  BufferUtil.flipToFlush(buffer,0);
  assertThat(buffer.remaining(),Matchers.is(0));
  Assert.assertEquals(4,encoder.getContext().size());
  refSet.clear();
  for (  Entry entry : encoder.getContext().getReferenceSet())   refSet.add(entry.getHttpField());
  Assert.assertEquals(4,refSet.size());
  for (int i=0; i <= 3; i++)   Assert.assertTrue(refSet.contains(field[i]));
  for (int i=4; i <= 7; i++)   fields.add(field[i]);
  BufferUtil.clearToFill(buffer);
  encoder.encode(buffer,new MetaData(HttpVersion.HTTP_2_0,fields));
  BufferUtil.flipToFlush(buffer,0);
  assertThat(buffer.remaining(),Matchers.greaterThan(0));
  Assert.assertEquals(5,encoder.getContext().size());
  refSet.clear();
  for (  Entry entry : encoder.getContext().getReferenceSet())   refSet.add(entry.getHttpField());
  Assert.assertEquals(5,refSet.size());
  for (int i=3; i <= 7; i++)   Assert.assertTrue(refSet.contains(field[i]));
  for (int i=0; i <= 7; i+=2)   fields.remove(field[i].getName());
  BufferUtil.clearToFill(buffer);
  encoder.encode(buffer,new MetaData(HttpVersion.HTTP_2_0,fields));
  BufferUtil.flipToFlush(buffer,0);
  assertThat(buffer.remaining(),Matchers.greaterThan(0));
  Assert.assertEquals(5,encoder.getContext().size());
  refSet.clear();
  for (  Entry entry : encoder.getContext().getReferenceSet())   refSet.add(entry.getHttpField());
  Assert.assertEquals(4,refSet.size());
  for (int i=0; i <= 7; i++) {
    if (i % 2 == 1)     Assert.assertTrue(refSet.contains(field[i]));
 else     Assert.assertFalse(refSet.contains(field[i]));
  }
  fields.remove(field[1].getName());
  BufferUtil.clearToFill(buffer);
  encoder.encode(buffer,new MetaData(HttpVersion.HTTP_2_0,fields));
  BufferUtil.flipToFlush(buffer,0);
  assertThat(buffer.remaining(),Matchers.greaterThan(0));
  Assert.assertEquals(5,encoder.getContext().size());
  refSet.clear();
  for (  Entry entry : encoder.getContext().getReferenceSet())   refSet.add(entry.getHttpField());
  Assert.assertEquals(3,refSet.size());
  for (int i=2; i <= 7; i++) {
    if (i % 2 == 1)     Assert.assertTrue(refSet.contains(field[i]));
 else     Assert.assertFalse(refSet.contains(field[i]));
  }
  fields.add(field[1]);
  BufferUtil.clearToFill(buffer);
  encoder.encode(buffer,new MetaData(HttpVersion.HTTP_2_0,fields));
  BufferUtil.flipToFlush(buffer,0);
  assertThat(buffer.remaining(),Matchers.greaterThan(0));
  Assert.assertEquals(5,encoder.getContext().size());
  refSet.clear();
  for (  Entry entry : encoder.getContext().getReferenceSet())   refSet.add(entry.getHttpField());
  Assert.assertEquals(4,refSet.size());
  for (int i=0; i <= 7; i++) {
    if (i % 2 == 1)     Assert.assertTrue(refSet.contains(field[i]));
 else     Assert.assertFalse(refSet.contains(field[i]));
  }
}
