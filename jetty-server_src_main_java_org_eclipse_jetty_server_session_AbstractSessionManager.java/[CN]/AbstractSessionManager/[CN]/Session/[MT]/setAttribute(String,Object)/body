{
  Object old_value=null;
synchronized (Session.this) {
    if (value == null) {
      removeAttribute(name);
      return;
    }
    if (isNotAvailable())     throw new IllegalStateException();
    old_value=_attributes.put(name,value);
  }
  if (old_value == null || !value.equals(old_value)) {
    unbindValue(name,old_value);
    bindValue(name,value);
    if (_sessionAttributeListeners != null) {
      HttpSessionBindingEvent event=new HttpSessionBindingEvent(this,name,old_value == null ? value : old_value);
      for (int i=0; i < LazyList.size(_sessionAttributeListeners); i++) {
        HttpSessionAttributeListener l=(HttpSessionAttributeListener)LazyList.get(_sessionAttributeListeners,i);
        if (old_value == null)         l.attributeAdded(event);
 else         l.attributeReplaced(event);
      }
    }
  }
}
