{
  String key=request.getHeader("Sec-WebSocket-Key");
  response.setHeader("Upgrade","WebSocket");
  response.addHeader("Connection","Upgrade");
  response.addHeader("Sec-WebSocket-Accept",hashKey(key));
  if (subprotocol != null) {
    response.addHeader("Sec-WebSocket-Protocol",subprotocol);
  }
  for (  Extension ext : getExtensions()) {
    response.addHeader("Sec-WebSocket-Extensions",ext.getParameterizedName());
  }
  response.sendError(101);
  onFrameHandshake();
  onWebSocketOpen();
}
