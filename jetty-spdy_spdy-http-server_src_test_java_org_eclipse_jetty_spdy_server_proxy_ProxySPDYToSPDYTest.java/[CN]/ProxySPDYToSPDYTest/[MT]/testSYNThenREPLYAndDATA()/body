{
  final byte[] data="0123456789ABCDEF".getBytes("UTF-8");
  final String header="foo";
  InetSocketAddress proxyAddress=startProxy(startServer(new ServerSessionFrameListener.Adapter(){
    @Override public StreamFrameListener onSyn(    Stream stream,    SynInfo synInfo){
      Fields requestHeaders=synInfo.getHeaders();
      Assert.assertNotNull(requestHeaders.get("via"));
      Assert.assertNotNull(requestHeaders.get(header));
      Fields responseHeaders=new Fields();
      responseHeaders.put(header,"baz");
      stream.reply(new ReplyInfo(responseHeaders,false),new Callback.Adapter());
      stream.data(new BytesDataInfo(data,true),new Callback.Adapter());
      return null;
    }
  }
));
  proxyConnector.addConnectionFactory(proxyConnector.getConnectionFactory("spdy/" + version));
  Session client=factory.newSPDYClient(version).connect(proxyAddress,null);
  final CountDownLatch replyLatch=new CountDownLatch(1);
  final CountDownLatch dataLatch=new CountDownLatch(1);
  Fields headers=new Fields();
  headers.put(HTTPSPDYHeader.HOST.name(version),"localhost:" + proxyAddress.getPort());
  headers.put(header,"bar");
  client.syn(new SynInfo(headers,true),new StreamFrameListener.Adapter(){
    private final ByteArrayOutputStream result=new ByteArrayOutputStream();
    @Override public void onReply(    Stream stream,    ReplyInfo replyInfo){
      Fields headers=replyInfo.getHeaders();
      Assert.assertNotNull(headers.get(header));
      replyLatch.countDown();
    }
    @Override public void onData(    Stream stream,    DataInfo dataInfo){
      result.write(dataInfo.asBytes(true),0,dataInfo.length());
      if (dataInfo.isClose()) {
        Assert.assertArrayEquals(data,result.toByteArray());
        dataLatch.countDown();
      }
    }
  }
);
  Assert.assertTrue(replyLatch.await(5,TimeUnit.SECONDS));
  Assert.assertTrue(dataLatch.await(5,TimeUnit.SECONDS));
  client.goAway(new GoAwayInfo(5,TimeUnit.SECONDS));
}
