{
  Connection connection=null;
  List<String> expiredSessionIds=new ArrayList<String>();
  try {
    if (LOG.isDebugEnabled())     LOG.debug("Scavenge sweep started at " + System.currentTimeMillis());
    if (_lastScavengeTime > 0) {
      connection=getConnection();
      connection.setAutoCommit(true);
      PreparedStatement statement=connection.prepareStatement(_selectBoundedExpiredSessions);
      long lowerBound=(_lastScavengeTime - _scavengeIntervalMs);
      long upperBound=_lastScavengeTime;
      if (LOG.isDebugEnabled())       LOG.debug(" Searching for sessions expired between " + lowerBound + " and "+ upperBound);
      statement.setLong(1,lowerBound);
      statement.setLong(2,upperBound);
      ResultSet result=statement.executeQuery();
      while (result.next()) {
        String sessionId=result.getString("sessionId");
        expiredSessionIds.add(sessionId);
        if (LOG.isDebugEnabled())         LOG.debug(" Found expired sessionId=" + sessionId);
      }
      Handler[] contexts=_server.getChildHandlersByClass(ContextHandler.class);
      for (int i=0; contexts != null && i < contexts.length; i++) {
        SessionHandler sessionHandler=(SessionHandler)((ContextHandler)contexts[i]).getChildHandlerByClass(SessionHandler.class);
        if (sessionHandler != null) {
          SessionManager manager=sessionHandler.getSessionManager();
          if (manager != null && manager instanceof JDBCSessionManager) {
            ((JDBCSessionManager)manager).expire(expiredSessionIds);
          }
        }
      }
      upperBound=_lastScavengeTime - (2 * _scavengeIntervalMs);
      if (upperBound > 0) {
        if (LOG.isDebugEnabled())         LOG.debug("Deleting old expired sessions expired before " + upperBound);
        statement=connection.prepareStatement(_deleteOldExpiredSessions);
        statement.setLong(1,upperBound);
        int rows=statement.executeUpdate();
        if (LOG.isDebugEnabled())         LOG.debug("Deleted " + rows + " rows");
      }
    }
  }
 catch (  Exception e) {
    if (isRunning())     LOG.warn("Problem selecting expired sessions",e);
 else     LOG.ignore(e);
  }
 finally {
    _lastScavengeTime=System.currentTimeMillis();
    if (LOG.isDebugEnabled())     LOG.debug("Scavenge sweep ended at " + _lastScavengeTime);
    if (connection != null) {
      try {
        connection.close();
      }
 catch (      SQLException e) {
        LOG.warn(e);
      }
    }
  }
}
