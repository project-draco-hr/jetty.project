{
  SessionPromise sessionPromise=(SessionPromise)attachment;
  final SPDYClient client=sessionPromise.client;
  try {
    if (sslContextFactory != null) {
      final AtomicReference<AsyncEndPoint> sslEndPointRef=new AtomicReference<>();
      final AtomicReference<Object> attachmentRef=new AtomicReference<>(attachment);
      SSLEngine engine=client.newSSLEngine(sslContextFactory,channel);
      SslConnection sslConnection=new SslConnection(bufferPool,threadPool,endPoint,engine){
        @Override public void onClose(){
          sslEndPointRef.set(null);
          attachmentRef.set(null);
          super.onClose();
        }
      }
;
      endPoint.setAsyncConnection(sslConnection);
      AsyncEndPoint sslEndPoint=sslConnection.getAppEndPoint();
      sslEndPointRef.set(sslEndPoint);
      NextProtoNego.put(engine,new NextProtoNego.ClientProvider(){
        @Override public boolean supports(){
          return true;
        }
        @Override public void unsupported(){
          ClientSPDYAsyncConnectionFactory connectionFactory=new ClientSPDYAsyncConnectionFactory();
          AsyncEndPoint sslEndPoint=sslEndPointRef.get();
          AsyncConnection connection=connectionFactory.newAsyncConnection(channel,sslEndPoint,attachmentRef.get());
          sslEndPoint.setAsyncConnection(connection);
        }
        @Override public String selectProtocol(        List<String> protocols){
          String protocol=client.selectProtocol(protocols);
          if (protocol == null)           return null;
          AsyncConnectionFactory connectionFactory=client.getAsyncConnectionFactory(protocol);
          AsyncEndPoint sslEndPoint=sslEndPointRef.get();
          AsyncConnection connection=connectionFactory.newAsyncConnection(channel,sslEndPoint,attachmentRef.get());
          sslEndPoint.setAsyncConnection(connection);
          return protocol;
        }
      }
);
      AsyncConnection connection=new EmptyAsyncConnection(sslEndPoint);
      sslEndPoint.setAsyncConnection(connection);
      startHandshake(engine);
      return sslConnection;
    }
 else {
      AsyncConnectionFactory connectionFactory=new ClientSPDYAsyncConnectionFactory();
      AsyncConnection connection=connectionFactory.newAsyncConnection(channel,endPoint,attachment);
      endPoint.setAsyncConnection(connection);
      return connection;
    }
  }
 catch (  RuntimeException x) {
    sessionPromise.failed(null,x);
    throw x;
  }
}
