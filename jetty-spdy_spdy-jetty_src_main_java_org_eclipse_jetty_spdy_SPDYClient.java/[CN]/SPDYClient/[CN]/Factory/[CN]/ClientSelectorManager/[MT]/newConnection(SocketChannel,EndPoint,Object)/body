{
  SessionPromise sessionPromise=(SessionPromise)attachment;
  final SPDYClient client=sessionPromise.client;
  try {
    if (sslContextFactory != null) {
      final SSLEngine engine=client.newSSLEngine(sslContextFactory,channel);
      SslConnection sslConnection=new SslConnection(bufferPool,executor,endPoint,engine){
        @Override public void onClose(){
          NextProtoNego.remove(engine);
          super.onClose();
        }
      }
;
      EndPoint sslEndPoint=sslConnection.getDecryptedEndPoint();
      NextProtoNegoClientConnection connection=new NextProtoNegoClientConnection(channel,sslEndPoint,attachment,client.factory.executor,client);
      sslEndPoint.setConnection(connection);
      connectionOpened(connection);
      NextProtoNego.put(engine,connection);
      return sslConnection;
    }
 else {
      ConnectionFactory connectionFactory=new ClientSPDYConnectionFactory();
      return connectionFactory.newConnection(channel,endPoint,attachment);
    }
  }
 catch (  RuntimeException x) {
    sessionPromise.failed(null,x);
    throw x;
  }
}
