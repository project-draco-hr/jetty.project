{
  ShutdownMonitor monitor=ShutdownMonitor.getInstance();
  monitor.setExitVm(false);
  monitor.setPort(0);
  TestableServer server=new TestableServer();
  server.setStopAtShutdown(true);
  server.start();
  assertTrue(ShutdownThread.isRegistered(server));
  assertTrue(ShutdownMonitor.isRegistered(server));
  String key=monitor.getKey();
  int port=monitor.getPort();
  stop("stop",port,key,true);
  monitor.await();
  assertTrue(!monitor.isAlive());
  assertTrue(server.stopped);
  assertTrue(!server.destroyed);
  assertTrue(!ShutdownThread.isRegistered(server));
  assertTrue(!ShutdownMonitor.isRegistered(server));
}
