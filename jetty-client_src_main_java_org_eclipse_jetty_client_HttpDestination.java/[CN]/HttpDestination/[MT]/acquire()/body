{
  Connection result=idleConnections.poll();
  if (result != null)   return result;
  final int maxConnections=client.getMaxConnectionsPerAddress();
  while (true) {
    int current=connectionCount.get();
    final int next=current + 1;
    if (next > maxConnections) {
      LOG.debug("Max connections {} reached for {}",current,this);
      return idleConnections.poll();
    }
    if (connectionCount.compareAndSet(current,next)) {
      LOG.debug("Creating connection {}/{} for {}",next,maxConnections,this);
      CONNECTCallback connectCallback=new CONNECTCallback(new Callback<Connection>(){
        @Override public void succeeded(){
          process(connection,true);
        }
        @Override public void failed(        final Throwable x){
          client.getExecutor().execute(new Runnable(){
            @Override public void run(){
              drain(x);
              if (connection != null)               connection.close();
            }
          }
);
        }
      }
);
      newConnection(new TCPPromise(next,maxConnections,connectCallback));
      return idleConnections.poll();
    }
  }
}
