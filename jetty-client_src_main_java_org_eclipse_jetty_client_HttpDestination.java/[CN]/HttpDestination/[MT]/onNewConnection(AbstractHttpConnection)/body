{
  Connection reservedConnection=null;
synchronized (this) {
    _pendingConnections--;
    _connections.add(connection);
    if (_pendingReservedConnections > 0) {
      reservedConnection=connection;
      _pendingReservedConnections--;
    }
 else {
      EndPoint endPoint=connection.getEndPoint();
      if (isProxied() && endPoint instanceof SelectConnector.UpgradableEndPoint) {
        SelectConnector.UpgradableEndPoint proxyEndPoint=(SelectConnector.UpgradableEndPoint)endPoint;
        ConnectExchange connect=new ConnectExchange(getAddress(),proxyEndPoint);
        connect.setAddress(getProxy());
        LOG.debug("Establishing tunnel to {} via {}",getAddress(),getProxy());
        send(connection,connect);
      }
 else {
        if (_exchanges.size() == 0) {
          LOG.debug("No exchanges for new connection {}",connection);
          connection.setIdleTimeout();
          _idleConnections.add(connection);
        }
 else {
          HttpExchange exchange=_exchanges.remove(0);
          send(connection,exchange);
        }
      }
    }
  }
  if (reservedConnection != null) {
    try {
      _reservedConnections.put(reservedConnection);
    }
 catch (    InterruptedException e) {
      LOG.ignore(e);
    }
  }
}
