{
  Connection q_connection=null;
synchronized (this) {
    _pendingConnections--;
    _connections.add(connection);
    if (_newConnection > 0) {
      q_connection=connection;
      _newConnection--;
    }
 else     if (_queue.size() == 0) {
      connection.setIdleTimeout();
      _idle.add(connection);
    }
 else {
      EndPoint endPoint=connection.getEndPoint();
      if (isProxied() && endPoint instanceof SelectConnector.UpgradableEndPoint) {
        SelectConnector.UpgradableEndPoint proxyEndPoint=(SelectConnector.UpgradableEndPoint)endPoint;
        HttpExchange exchange=_queue.get(0);
        ConnectExchange connect=new ConnectExchange(getAddress(),proxyEndPoint,exchange);
        connect.setAddress(getProxy());
        send(connection,connect);
      }
 else {
        HttpExchange exchange=_queue.remove(0);
        send(connection,exchange);
      }
    }
  }
  if (q_connection != null) {
    try {
      _newQueue.put(q_connection);
    }
 catch (    InterruptedException e) {
      LOG.ignore(e);
    }
  }
}
