{
  Context ctx=(Context)_threadContext.get();
  if (ctx != null) {
    if (Log.isDebugEnabled())     Log.debug("Using the Context that is bound on the thread");
    return ctx;
  }
  ClassLoader loader=null;
  if (ContextHandler.getCurrentContext() != null) {
    loader=ContextHandler.getCurrentContext().getContextHandler().getClassLoader();
  }
  if (loader != null) {
    if (Log.isDebugEnabled())     Log.debug("Using classloader of current org.eclipse.jetty.server.handler.ContextHandler");
  }
 else {
    loader=Thread.currentThread().getContextClassLoader();
    if (Log.isDebugEnabled())     Log.debug("Using thread context classloader");
  }
  ctx=(Context)_contextMap.get(loader);
  if (ctx == null) {
    ctx=getParentClassLoaderContext(loader);
    if (ctx == null) {
      Reference ref=(Reference)obj;
      StringRefAddr parserAddr=(StringRefAddr)ref.get("parser");
      String parserClassName=(parserAddr == null ? null : (String)parserAddr.getContent());
      NameParser parser=(NameParser)(parserClassName == null ? null : loader.loadClass(parserClassName).newInstance());
      ctx=new NamingContext(env,name.get(0),nameCtx,parser);
      if (Log.isDebugEnabled())       Log.debug("No entry for classloader: " + loader);
      _contextMap.put(loader,ctx);
    }
  }
  return ctx;
}
