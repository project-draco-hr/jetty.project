{
  while (true) {
switch (state.get()) {
case OFFER:
      if (!state.compareAndSet(ReadState.OFFER,ReadState.SUCCESS))       continue;
    onClientRequestFailure(proxyRequest,request,x);
  break;
case PENDING:
if (!state.compareAndSet(ReadState.PENDING,ReadState.SUCCESS)) continue;
onClientRequestFailure(proxyRequest,request,x);
break;
default :
throw new IllegalStateException(x);
}
}
}
