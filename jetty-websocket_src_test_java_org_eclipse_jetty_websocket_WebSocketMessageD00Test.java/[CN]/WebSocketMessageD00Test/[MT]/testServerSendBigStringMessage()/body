{
  Socket socket=new Socket("localhost",_connector.getLocalPort());
  OutputStream output=socket.getOutputStream();
  output.write(("GET /test HTTP/1.1\r\n" + "Host: localhost\r\n" + "Upgrade: WebSocket\r\n"+ "Connection: Upgrade\r\n"+ "Sec-WebSocket-Key1: 4 @1  46546xW%0l 1 5\r\n"+ "Sec-WebSocket-Key2: 12998 5 Y3 1  .P00\r\n"+ "\r\n"+ "^n:ds[4U").getBytes("ISO-8859-1"));
  output.flush();
  socket.setSoTimeout(1000);
  InputStream input=socket.getInputStream();
  BufferedReader reader=new BufferedReader(new InputStreamReader(input,"ISO-8859-1"));
  String responseLine=reader.readLine();
  assertTrue(responseLine.startsWith("HTTP/1.1 101 WebSocket Protocol Handshake"));
  String line;
  while ((line=reader.readLine()) != null)   if (line.length() == 0)   break;
  assertTrue(_serverWebSocket.awaitConnected(1000));
  assertNotNull(_serverWebSocket.outbound);
  char[] hixie=new char[16];
  int h=16;
  int o=0;
  do {
    int l=reader.read(hixie,o,h);
    if (l < 0)     break;
    h-=l;
    o+=l;
  }
 while (h > 0);
  assertEquals("8jKS'y:G*Co,Wxa-",new String(hixie,0,16));
  StringBuilder message=new StringBuilder();
  String text="0123456789ABCDEF";
  for (int i=0; i < 64 * 1024 / text.length(); ++i)   message.append(text);
  _serverWebSocket.outbound.sendMessage(message.toString());
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  while (true) {
    int read=input.read();
    baos.write(read);
    if (read == 0xFF)     break;
  }
  baos.close();
  byte[] bytes=baos.toByteArray();
  String result=StringUtil.printable(bytes);
  assertTrue(result.startsWith("0x00"));
  assertTrue(result.endsWith("0xFF"));
  assertEquals(message.length() + "0x00".length() + "0xFF".length(),result.length());
}
