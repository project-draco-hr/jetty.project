{
  if (streamId < 0)   throw new IllegalArgumentException("Invalid stream id: " + streamId);
  int maxFrameSize=getMaxFrameSize();
  ByteBuffer hpacked=lease.acquire(maxFrameSize,false);
  BufferUtil.clearToFill(hpacked);
  encoder.encode(hpacked,metaData);
  int hpackedLength=hpacked.position();
  BufferUtil.flipToFlush(hpacked,0);
  if (maxHeaderBlockFragment > 0 && hpackedLength > maxHeaderBlockFragment) {
    int flags=contentFollows ? Flags.NONE : Flags.END_STREAM;
    ByteBuffer header=generateHeader(lease,FrameType.HEADERS,maxHeaderBlockFragment,flags,streamId);
    BufferUtil.flipToFlush(header,0);
    lease.append(header,true);
    hpacked.limit(maxHeaderBlockFragment);
    lease.append(hpacked.slice(),false);
    int position=maxHeaderBlockFragment;
    int limit=position + maxHeaderBlockFragment;
    while (limit < hpackedLength) {
      hpacked.position(position).limit(limit);
      header=generateHeader(lease,FrameType.CONTINUATION,maxHeaderBlockFragment,Flags.NONE,streamId);
      BufferUtil.flipToFlush(header,0);
      lease.append(header,true);
      lease.append(hpacked.slice(),false);
      position+=maxHeaderBlockFragment;
      limit+=maxHeaderBlockFragment;
    }
    hpacked.position(position).limit(hpackedLength);
    header=generateHeader(lease,FrameType.CONTINUATION,hpacked.remaining(),Flags.END_HEADERS,streamId);
    BufferUtil.flipToFlush(header,0);
    lease.append(header,true);
    lease.append(hpacked,true);
  }
 else {
    int flags=Flags.END_HEADERS;
    if (!contentFollows)     flags|=Flags.END_STREAM;
    ByteBuffer header=generateHeader(lease,FrameType.HEADERS,hpackedLength,flags,streamId);
    BufferUtil.flipToFlush(header,0);
    lease.append(header,true);
    lease.append(hpacked,true);
  }
}
