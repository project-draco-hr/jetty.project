{
  StringBuilder response=new StringBuilder();
  response.append("HTTP/1.1 101 Switching Protocols\r\n");
  response.append("Connection: upgrade\r\n");
  response.append("\r\n");
  EventDriver websocket=this.eventDriverFactory.wrap(echo);
  WebSocketSession session=new WebSocketSession(request.getRequestURI(),websocket,channel);
  UpgradeResponse uresponse=new UpgradeResponse();
  uresponse.setAcceptedSubProtocol("echo");
  session.setUpgradeResponse(uresponse);
  channel.setSession(session);
  channel.setSubProtocol("echo");
  channel.onOpen();
  session.open();
  MuxAddChannelResponse addChannelResponse=new MuxAddChannelResponse();
  addChannelResponse.setChannelId(channel.getChannelId());
  addChannelResponse.setEncoding(MuxAddChannelResponse.IDENTITY_ENCODING);
  addChannelResponse.setFailed(false);
  addChannelResponse.setHandshake(response.toString());
  muxer.output(addChannelResponse);
}
