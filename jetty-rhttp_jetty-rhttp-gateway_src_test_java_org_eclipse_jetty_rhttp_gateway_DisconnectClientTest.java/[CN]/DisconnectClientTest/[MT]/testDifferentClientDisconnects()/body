{
  GatewayServer server=new GatewayServer();
  Connector connector=new SelectChannelConnector();
  server.addConnector(connector);
  server.start();
  try {
    Address address=new Address("localhost",connector.getLocalPort());
    HttpClient httpClient=new HttpClient();
    httpClient.setConnectorType(HttpClient.CONNECTOR_SELECT_CHANNEL);
    httpClient.start();
    try {
      final CountDownLatch latch=new CountDownLatch(1);
      String targetId="1";
      final RHTTPClient client1=new JettyClient(httpClient,address,server.getContext().getContextPath() + GatewayServer.DFT_CONNECT_PATH,targetId){
        @Override protected void connectComplete(        byte[] responseContent) throws IOException {
          latch.countDown();
          super.connectComplete(responseContent);
        }
      }
;
      client1.connect();
      try {
        final RHTTPClient client2=new JettyClient(httpClient,address,server.getContext().getContextPath() + GatewayServer.DFT_CONNECT_PATH,targetId);
        client2.disconnect();
        assertFalse(latch.await(1000,TimeUnit.MILLISECONDS));
      }
  finally {
        client1.disconnect();
      }
    }
  finally {
      httpClient.stop();
    }
  }
  finally {
    server.stop();
  }
}
