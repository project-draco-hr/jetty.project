{
  TrackingSocket wsocket=new TrackingSocket();
  URI wsUri=server.getWsUri();
  client.setMaxIdleTimeout(1000);
  Future<Session> future=client.connect(wsocket,wsUri);
  ServerConnection ssocket=server.accept();
  ssocket.upgrade();
  try {
    ssocket.startEcho();
    future.get(500,TimeUnit.MILLISECONDS);
    wsocket.waitForConnected(500,TimeUnit.MILLISECONDS);
    long start=System.currentTimeMillis();
    wsocket.waitForClose(10,TimeUnit.SECONDS);
    long end=System.currentTimeMillis();
    long dur=(end - start);
    Assert.assertThat("Idle Timeout",dur,lessThanOrEqualTo(5000L));
    wsocket.assertCloseCode(StatusCode.SHUTDOWN);
  }
  finally {
    ssocket.stopEcho();
  }
}
