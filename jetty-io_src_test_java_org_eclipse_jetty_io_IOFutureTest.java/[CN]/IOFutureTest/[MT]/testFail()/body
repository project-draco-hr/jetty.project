{
  DispatchedIOFuture future=new DispatchedIOFuture();
  final Exception ex=new Exception("failed");
  assertFalse(future.isDone());
  assertFalse(future.isComplete());
  final AtomicBoolean ready=new AtomicBoolean(false);
  final AtomicReference<Throwable> fail=new AtomicReference<>();
  future.setCallback(new Callback<Object>(){
    @Override public void completed(    Object context){
      ready.set(true);
    }
    @Override public void failed(    Object context,    Throwable cause){
      fail.set(cause);
    }
  }
,null);
  long start=System.currentTimeMillis();
  assertFalse(future.block(100,TimeUnit.MILLISECONDS));
  assertThat(System.currentTimeMillis() - start,greaterThan(10L));
  assertFalse(ready.get());
  assertNull(fail.get());
  start=System.currentTimeMillis();
  final DispatchedIOFuture f0=future;
  new Thread(){
    @Override public void run(){
      try {
        TimeUnit.MILLISECONDS.sleep(100);
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
      f0.fail(ex);
    }
  }
.start();
  try {
    future.block(1000,TimeUnit.MILLISECONDS);
    Assert.fail();
  }
 catch (  ExecutionException e) {
    Assert.assertEquals(ex,e.getCause());
  }
  Assert.assertThat(System.currentTimeMillis() - start,greaterThan(10L));
  Assert.assertThat(System.currentTimeMillis() - start,lessThan(1000L));
  assertTrue(future.isDone());
  try {
    future.isComplete();
    Assert.fail();
  }
 catch (  ExecutionException e) {
    Assert.assertEquals(ex,e.getCause());
  }
  assertFalse(ready.get());
  assertEquals(ex,fail.get());
  future=new DispatchedIOFuture();
  ready.set(false);
  fail.set(null);
  assertFalse(future.isDone());
  assertFalse(future.isComplete());
  start=System.currentTimeMillis();
  final DispatchedIOFuture f1=future;
  new Thread(){
    @Override public void run(){
      try {
        TimeUnit.MILLISECONDS.sleep(100);
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
      f1.fail(ex);
    }
  }
.start();
  try {
    future.block();
    Assert.fail();
  }
 catch (  ExecutionException e) {
    Assert.assertEquals(ex,e.getCause());
  }
  Assert.assertThat(System.currentTimeMillis() - start,greaterThan(10L));
  assertTrue(future.isDone());
  try {
    future.isComplete();
    Assert.fail();
  }
 catch (  ExecutionException e) {
    Assert.assertEquals(ex,e.getCause());
  }
  assertFalse(ready.get());
  assertNull(fail.get());
}
