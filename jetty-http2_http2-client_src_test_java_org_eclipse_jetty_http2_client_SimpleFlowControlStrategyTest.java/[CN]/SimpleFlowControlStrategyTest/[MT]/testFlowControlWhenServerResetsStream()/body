{
  start(new ServerSessionListener.Adapter(){
    @Override public Stream.Listener onNewStream(    Stream stream,    HeadersFrame frame){
      stream.reset(new ResetFrame(stream.getId(),ErrorCode.CANCEL_STREAM_ERROR.code),Callback.Adapter.INSTANCE);
      return null;
    }
  }
);
  Session session=newClient(new Session.Listener.Adapter());
  MetaData.Request metaData=newRequest("POST",new HttpFields());
  HeadersFrame frame=new HeadersFrame(0,metaData,null,false);
  FuturePromise<Stream> streamPromise=new FuturePromise<>();
  final CountDownLatch resetLatch=new CountDownLatch(1);
  session.newStream(frame,streamPromise,new Stream.Listener.Adapter(){
    @Override public void onReset(    Stream stream,    ResetFrame frame){
      resetLatch.countDown();
    }
  }
);
  Stream stream=streamPromise.get(5,TimeUnit.SECONDS);
  ByteBuffer data=ByteBuffer.allocate(5 * FlowControlStrategy.DEFAULT_WINDOW_SIZE);
  final CountDownLatch dataLatch=new CountDownLatch(1);
  stream.data(new DataFrame(stream.getId(),data,true),new Callback.Adapter(){
    @Override public void failed(    Throwable x){
      dataLatch.countDown();
    }
  }
);
  Assert.assertTrue(resetLatch.await(5,TimeUnit.SECONDS));
  Assert.assertTrue(dataLatch.await(555,TimeUnit.SECONDS));
  Thread.sleep(1000);
  HTTP2Session http2Session=(HTTP2Session)session;
  Assert.assertEquals(FlowControlStrategy.DEFAULT_WINDOW_SIZE,http2Session.getSendWindow());
}
