{
  ServerSocket serverSocket=new ServerSocket();
  serverSocket.bind(null);
  int port=serverSocket.getLocalPort();
  HttpClient httpClient=new HttpClient();
  httpClient.setMaxConnectionsPerAddress(1);
  httpClient.start();
  try {
    CountDownLatch latch=new CountDownLatch(1);
    HttpExchange exchange=new ConnectionExchange(latch);
    exchange.setAddress(new Address("localhost",port));
    exchange.setURI("/");
    httpClient.send(exchange);
    Socket remote=serverSocket.accept();
    OutputStream output=remote.getOutputStream();
    output.write("HTTP/1.1 200 OK\r\n".getBytes("UTF-8"));
    output.write("Content-Length: 0\r\n".getBytes("UTF-8"));
    output.write("\r\n".getBytes("UTF-8"));
    output.flush();
    assertEquals(HttpExchange.STATUS_COMPLETED,exchange.waitForDone());
    remote.close();
    Thread.sleep(500);
    exchange.reset();
    httpClient.send(exchange);
    remote=serverSocket.accept();
    output=remote.getOutputStream();
    output.write("HTTP/1.1 200 OK\r\n".getBytes("UTF-8"));
    output.write("Content-Length: 0\r\n".getBytes("UTF-8"));
    output.write("\r\n".getBytes("UTF-8"));
    output.flush();
    assertEquals(HttpExchange.STATUS_COMPLETED,exchange.waitForDone());
  }
  finally {
    httpClient.stop();
  }
}
