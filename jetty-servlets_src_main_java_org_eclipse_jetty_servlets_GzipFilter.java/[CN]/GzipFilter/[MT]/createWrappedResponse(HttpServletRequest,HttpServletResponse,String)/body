{
  CompressedResponseWrapper wrappedResponse=null;
  wrappedResponse=new CompressedResponseWrapper(request,response){
    @Override protected AbstractCompressedStream newCompressedStream(    HttpServletRequest request,    HttpServletResponse response) throws IOException {
      return new AbstractCompressedStream(compressionType,request,this,_vary){
        private Deflater _allocatedDeflater;
        private byte[] _allocatedBuffer;
        @Override protected OutputStream createStream() throws IOException {
          if (compressionType == null) {
            return null;
          }
          _allocatedDeflater=_deflater.get();
          if (_allocatedDeflater == null)           _allocatedDeflater=new Deflater(_deflateCompressionLevel,_deflateNoWrap);
 else {
            _deflater.remove();
            _allocatedDeflater.reset();
          }
          _allocatedBuffer=_buffer.get();
          if (_allocatedBuffer == null)           _allocatedBuffer=new byte[_bufferSize];
 else {
            _buffer.remove();
          }
switch (compressionType) {
case GZIP:
            return new GzipOutputStream(_response.getOutputStream(),_allocatedDeflater,_allocatedBuffer);
case DEFLATE:
          return new DeflatedOutputStream(_response.getOutputStream(),_allocatedDeflater,_allocatedBuffer);
      }
      throw new IllegalStateException(compressionType + " not supported");
    }
    @Override public void finish() throws IOException {
      super.finish();
      if (_allocatedDeflater != null && _deflater.get() == null) {
        _deflater.set(_allocatedDeflater);
      }
      if (_allocatedBuffer != null && _buffer.get() == null) {
        _buffer.set(_allocatedBuffer);
      }
    }
  }
;
}
}
;
configureWrappedResponse(wrappedResponse);
return wrappedResponse;
}
