{
  HttpServletRequest request=(HttpServletRequest)req;
  HttpServletResponse response=(HttpServletResponse)res;
  if (_mimeTypes != null && _mimeTypes.size() > 0) {
    String mimeType=_context.getMimeType(request.getRequestURI());
    if (mimeType != null && !_mimeTypes.contains(mimeType)) {
      super.doFilter(request,response,chain);
      return;
    }
  }
  response.setHeader("Vary","Accept-Encoding");
  String compressionType=selectCompression(request.getHeader("accept-encoding"));
  if (compressionType != null && !response.containsHeader("Content-Encoding") && !HttpMethod.HEAD.is(request.getMethod())) {
    String ua=getUserAgent(request);
    if (isExcludedAgent(ua)) {
      super.doFilter(request,response,chain);
      return;
    }
    String requestURI=request.getRequestURI();
    if (isExcludedPath(requestURI)) {
      super.doFilter(request,response,chain);
      return;
    }
    String etag=request.getHeader("If-None-Match");
    if (etag != null) {
      if (etag.endsWith(ETAG_GZIP))       request.setAttribute(ETAG,etag.substring(0,etag.length() - ETAG_GZIP.length()) + '"');
 else       if (etag.endsWith(ETAG_DEFLATE))       request.setAttribute(ETAG,etag.substring(0,etag.length() - ETAG_DEFLATE.length()) + '"');
    }
    CompressedResponseWrapper wrappedResponse=createWrappedResponse(request,response,compressionType);
    boolean exceptional=true;
    try {
      super.doFilter(request,wrappedResponse,chain);
      exceptional=false;
    }
  finally {
      Continuation continuation=ContinuationSupport.getContinuation(request);
      if (continuation.isSuspended() && continuation.isResponseWrapped()) {
        continuation.addContinuationListener(new ContinuationListenerWaitingForWrappedResponseToFinish(wrappedResponse));
      }
 else       if (exceptional && !response.isCommitted()) {
        wrappedResponse.resetBuffer();
        wrappedResponse.noCompression();
      }
 else       wrappedResponse.finish();
    }
  }
 else {
    super.doFilter(request,response,chain);
  }
}
