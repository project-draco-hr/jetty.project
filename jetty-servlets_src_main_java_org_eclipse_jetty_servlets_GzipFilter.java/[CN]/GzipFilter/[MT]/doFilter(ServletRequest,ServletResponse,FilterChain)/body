{
  HttpServletRequest request=(HttpServletRequest)req;
  HttpServletResponse response=(HttpServletResponse)res;
  String ae=request.getHeader("accept-encoding");
  CompressionType compressionType=CompressionType.getByEncodingHeader(ae);
  if (ae != null && !compressionType.equals(CompressionType.UNSUPPORTED) && !response.containsHeader("Content-Encoding") && !HttpMethods.HEAD.equalsIgnoreCase(request.getMethod())) {
    String ua=getUserAgent(request);
    if (isExcludedAgent(ua)) {
      super.doFilter(request,response,chain);
      return;
    }
    String requestURI=request.getRequestURI();
    if (isExcludedPath(requestURI)) {
      super.doFilter(request,response,chain);
      return;
    }
    CompressedResponseWrapper wrappedResponse=createWrappedResponse(request,response,compressionType);
    boolean exceptional=true;
    try {
      super.doFilter(request,wrappedResponse,chain);
      exceptional=false;
    }
  finally {
      Continuation continuation=ContinuationSupport.getContinuation(request);
      if (continuation.isSuspended() && continuation.isResponseWrapped()) {
        continuation.addContinuationListener(new ContinuationListenerWaitingForWrappedResponseToFinish(wrappedResponse));
      }
 else       if (exceptional && !response.isCommitted()) {
        wrappedResponse.resetBuffer();
        wrappedResponse.noCompression();
      }
 else       wrappedResponse.finish();
    }
  }
 else {
    super.doFilter(request,response,chain);
  }
}
