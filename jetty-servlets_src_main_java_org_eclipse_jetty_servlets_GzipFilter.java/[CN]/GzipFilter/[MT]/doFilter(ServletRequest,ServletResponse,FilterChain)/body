{
  HttpServletRequest request=(HttpServletRequest)req;
  HttpServletResponse response=(HttpServletResponse)res;
  String requestURI=request.getRequestURI();
  if (!_methods.contains(request.getMethod()) || isExcludedPath(requestURI)) {
    super.doFilter(request,response,chain);
    return;
  }
  if (_mimeTypes.size() > 0 && _excludeMimeTypes) {
    String mimeType=_context.getMimeType(request.getRequestURI());
    if (mimeType != null && _mimeTypes.contains(mimeType)) {
      super.doFilter(request,response,chain);
      return;
    }
  }
  if (response.getHeader("Content-Encoding") != null) {
    super.doFilter(request,response,chain);
    return;
  }
  if (_checkGzExists && request.getServletContext() != null) {
    String path=request.getServletContext().getRealPath(URIUtil.addPaths(request.getServletPath(),request.getPathInfo()));
    if (path != null) {
      File gz=new File(path + ".gz");
      if (gz.exists()) {
        super.doFilter(request,response,chain);
        return;
      }
    }
  }
  String ua=getUserAgent(request);
  boolean ua_excluded=ua != null && isExcludedAgent(ua);
  String compressionType=ua_excluded ? null : selectCompression(request.getHeader("accept-encoding"));
  String etag=request.getHeader("If-None-Match");
  if (etag != null) {
    int dd=etag.indexOf("--");
    if (dd > 0)     request.setAttribute(ETAG,etag.substring(0,dd) + (etag.endsWith("\"") ? "\"" : ""));
  }
  CompressedResponseWrapper wrappedResponse=createWrappedResponse(request,response,compressionType);
  boolean exceptional=true;
  try {
    super.doFilter(request,wrappedResponse,chain);
    exceptional=false;
  }
  finally {
    if (request.isAsyncStarted()) {
      request.getAsyncContext().addListener(new FinishOnCompleteListener(wrappedResponse));
    }
 else     if (exceptional && !response.isCommitted()) {
      wrappedResponse.resetBuffer();
      wrappedResponse.noCompression();
    }
 else     wrappedResponse.finish();
  }
}
