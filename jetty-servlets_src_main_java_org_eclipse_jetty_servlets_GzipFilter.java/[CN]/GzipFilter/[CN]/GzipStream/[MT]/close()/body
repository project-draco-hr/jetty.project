{
  if (_closed)   return;
  if (_request.getAttribute("javax.servlet.include.request_uri") != null)   flush();
 else {
    if (_bOut != null) {
      if (_contentLength < 0)       _contentLength=_bOut.getCount();
      if (_contentLength < _minGzipSize)       doNotGzip();
 else       doGzip();
    }
 else     if (_out == null) {
      doNotGzip();
    }
    if (_gzOut != null)     _gzOut.finish();
    _out.close();
    _closed=true;
  }
}
