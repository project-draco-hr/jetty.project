{
  if (isDumpBeforeStop())   dumpStdErr();
  MultiException mex=new MultiException();
  for (  Connector connector : _connectors) {
    if (connector instanceof NetworkConnector)     ((NetworkConnector)connector).close();
  }
  Handler[] contexts=getChildHandlersByClass(Graceful.class);
  for (  Handler context : contexts) {
    Graceful graceful=(Graceful)context;
    graceful.shutdown();
  }
  long stopTimeout=getStopTimeout();
  if (stopTimeout > 0 && LOG.isDebugEnabled()) {
    long stop_by=System.currentTimeMillis() + stopTimeout;
    LOG.info("Graceful shutdown {} by ",this,new Date(stop_by));
    for (    Connector connector : _connectors) {
      if (connector instanceof AbstractConnector)       ((AbstractConnector)connector).setIdleTimeout(1);
    }
    for (    Connector connector : _connectors) {
      if (connector.getStatistics().isRunning() && connector.getStatistics().getConnectionsOpen() > 0 && System.currentTimeMillis() < stop_by) {
        if (LOG.isDebugEnabled())         System.err.println(((Dumpable)connector).dump());
        LOG.info("Waiting for connections to close on {}...",connector);
        while (connector.getStatistics().isRunning() && connector.getStatistics().getConnectionsOpen() > 0 && System.currentTimeMillis() < stop_by)         Thread.sleep(100);
      }
    }
  }
  for (  Connector connector : _connectors) {
    try {
      connector.stop();
    }
 catch (    Throwable e) {
      mex.add(e);
    }
  }
  try {
    super.doStop();
  }
 catch (  Throwable e) {
    mex.add(e);
  }
  mex.ifExceptionThrow();
  if (getStopAtShutdown())   ShutdownThread.deregister(this);
}
