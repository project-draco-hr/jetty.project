{
  final Charset iso1=StandardCharsets.ISO_8859_1;
  ByteArrayOutputStream buffer=new ByteArrayOutputStream(headers.getSize() * 64);
  writeCount(version,buffer,headers.getSize());
  for (  Fields.Field header : headers) {
    String name=header.getName().toLowerCase(Locale.ENGLISH);
    byte[] nameBytes=name.getBytes(iso1);
    writeNameLength(version,buffer,nameBytes.length);
    buffer.write(nameBytes,0,nameBytes.length);
    String value=header.getValue();
    byte[] valueBytes=value.getBytes(iso1);
    if (header.hasMultipleValues()) {
      List<String> values=header.getValues();
      for (int i=1; i < values.size(); ++i) {
        byte[] moreValueBytes=values.get(i).getBytes(iso1);
        byte[] newValueBytes=Arrays.copyOf(valueBytes,valueBytes.length + 1 + moreValueBytes.length);
        newValueBytes[valueBytes.length]=0;
        System.arraycopy(moreValueBytes,0,newValueBytes,valueBytes.length + 1,moreValueBytes.length);
        valueBytes=newValueBytes;
      }
    }
    writeValueLength(version,buffer,valueBytes.length);
    buffer.write(valueBytes,0,valueBytes.length);
  }
  return compress(version,buffer.toByteArray());
}
