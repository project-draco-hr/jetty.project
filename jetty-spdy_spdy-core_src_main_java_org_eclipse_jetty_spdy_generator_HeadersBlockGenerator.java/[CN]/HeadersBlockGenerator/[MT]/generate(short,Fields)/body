{
  ByteArrayOutputStream buffer=new ByteArrayOutputStream(headers.size() * 64);
  writeCount(version,buffer,headers.size());
  for (  Fields.Field header : headers) {
    String name=header.name().toLowerCase(Locale.ENGLISH);
    byte[] nameBytes=name.getBytes(StandardCharsets.ISO_8859_1);
    writeNameLength(version,buffer,nameBytes.length);
    buffer.write(nameBytes,0,nameBytes.length);
    String value=header.value();
    byte[] valueBytes=value.getBytes(StandardCharsets.ISO_8859_1);
    if (header.hasMultipleValues()) {
      String[] values=header.values();
      for (int i=1; i < values.length; ++i) {
        byte[] moreValueBytes=values[i].getBytes(StandardCharsets.ISO_8859_1);
        byte[] newValueBytes=new byte[valueBytes.length + 1 + moreValueBytes.length];
        System.arraycopy(valueBytes,0,newValueBytes,0,valueBytes.length);
        newValueBytes[valueBytes.length]=0;
        System.arraycopy(moreValueBytes,0,newValueBytes,valueBytes.length + 1,moreValueBytes.length);
        valueBytes=newValueBytes;
      }
    }
    writeValueLength(version,buffer,valueBytes.length);
    buffer.write(valueBytes,0,valueBytes.length);
  }
  return compress(version,buffer.toByteArray());
}
