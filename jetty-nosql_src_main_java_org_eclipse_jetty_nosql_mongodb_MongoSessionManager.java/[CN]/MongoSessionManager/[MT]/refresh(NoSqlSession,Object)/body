{
  __log.debug("MongoSessionManager:refresh session {}",session.getId());
  if (version != null) {
    DBObject o=_dbSessions.findOne(new BasicDBObject(__ID,session.getClusterId()),_version_1);
    if (o != null) {
      Object saved=getNestedValue(o,getContextAttributeKey(__VERSION));
      if (saved != null && saved.equals(version)) {
        __log.debug("MongoSessionManager:refresh not needed session {}",session.getId());
        return version;
      }
      version=saved;
    }
  }
  DBObject o=_dbSessions.findOne(new BasicDBObject(__ID,session.getClusterId()));
  if (o == null) {
    __log.debug("MongoSessionManager:refresh:marking session {} invalid, no object",session.getClusterId());
    session.invalidate();
    return null;
  }
  Boolean valid=(Boolean)o.get(__VALID);
  if (valid == null || !valid) {
    __log.debug("MongoSessionManager:refresh:marking session {} invalid, valid flag {}",session.getClusterId(),valid);
    session.invalidate();
    return null;
  }
  session.willPassivate();
  try {
    session.clearAttributes();
    DBObject attrs=(DBObject)getNestedValue(o,getContextKey());
    if (attrs != null) {
      for (      String name : attrs.keySet()) {
        if (__METADATA.equals(name))         continue;
        String attr=decodeName(name);
        Object value=decodeValue(attrs.get(name));
        if (attrs.keySet().contains(name)) {
          session.doPutOrRemove(attr,value);
          session.bindValue(attr,value);
        }
 else {
          session.doPutOrRemove(attr,value);
        }
      }
      for (      String name : session.getNames()) {
        if (!attrs.keySet().contains(name)) {
          session.doPutOrRemove(name,null);
          session.unbindValue(name,session.getAttribute(name));
        }
      }
    }
    BasicDBObject key=new BasicDBObject(__ID,session.getClusterId());
    BasicDBObject sets=new BasicDBObject();
    BasicDBObject update=new BasicDBObject();
    sets.put(__ACCESSED,System.currentTimeMillis());
    if (!sets.isEmpty()) {
      update.put("$set",sets);
    }
    _dbSessions.update(key,update,false,false);
    session.didActivate();
    return version;
  }
 catch (  Exception e) {
    LOG.warn(e);
  }
  return null;
}
