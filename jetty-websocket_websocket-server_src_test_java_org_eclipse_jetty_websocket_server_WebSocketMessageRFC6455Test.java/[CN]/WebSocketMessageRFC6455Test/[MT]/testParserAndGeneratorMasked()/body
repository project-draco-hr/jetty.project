{
  String message="0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF";
  final AtomicReference<String> received=new AtomicReference<String>();
  ByteArrayEndPoint endp=new ByteArrayEndPoint(new byte[0],4096);
  Masker maskGen=new RandomMasker();
  WebSocketGeneratorRFC6455 gen=new WebSocketGeneratorRFC6455(new WebSocketBuffers(8096),endp,maskGen);
  byte[] data=message.getBytes(StringUtil.__UTF8);
  gen.addFrame((byte)0x8,(byte)0x1,data,0,data.length);
  endp=new ByteArrayEndPoint(endp.getOut().asArray(),4096);
  WebSocketParserRFC6455 parser=new WebSocketParserRFC6455(new WebSocketBuffers(8096),endp,new WebSocketParser.FrameHandler(){
    public void onFrame(    byte flags,    byte opcode,    ByteBuffer buffer){
      received.set(buffer.toString());
    }
    public void close(    int code,    String message){
    }
  }
,true);
  parser.parseNext();
  assertEquals(message,received.get());
}
