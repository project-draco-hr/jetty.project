{
  ServerSocket socket=new ServerSocket();
  socket.bind(null);
  int port=socket.getLocalPort();
  socket.close();
  HttpClient httpClient=new HttpClient();
  httpClient.start();
  CountDownLatch latch=new CountDownLatch(1);
  HttpExchange exchange=new ConnectionFailedExchange(latch);
  exchange.setAddress(new Address("localhost",port));
  exchange.setURI("/");
  httpClient.send(exchange);
  boolean passed=latch.await(1000,TimeUnit.MILLISECONDS);
  assertTrue(passed);
  long wait=100;
  long maxWait=10 * wait;
  long curWait=wait;
  while (curWait < maxWait && !exchange.isDone()) {
    Thread.sleep(wait);
    curWait+=wait;
  }
  assertEquals(HttpExchange.STATUS_EXCEPTED,exchange.getStatus());
}
