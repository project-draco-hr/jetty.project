{
  HttpExchange exchange=connection.getExchange();
  if (exchange == null)   return false;
  AtomicMarkableReference<Result> completion=exchange.requestComplete(failure);
  if (!completion.isMarked())   return false;
  generator.abort();
  State current;
  while (true) {
    current=state.get();
    if (updateState(current,State.FAILURE))     break;
  }
  shutdownOutput();
  exchange.terminateRequest();
  HttpDestination destination=connection.getDestination();
  Request request=exchange.getRequest();
  destination.getRequestNotifier().notifyFailure(request,failure);
  LOG.debug("Failed {} {}",request,failure);
  Result result=completion.getReference();
  boolean notCommitted=isBeforeCommit(current);
  if (result == null && notCommitted && request.getAbortCause() == null) {
    result=exchange.responseComplete(failure).getReference();
    exchange.terminateResponse();
    LOG.debug("Failed on behalf {}",exchange);
  }
  if (result != null) {
    connection.complete(exchange,false);
    HttpConversation conversation=exchange.getConversation();
    destination.getResponseNotifier().notifyComplete(conversation.getResponseListeners(),result);
  }
  return true;
}
