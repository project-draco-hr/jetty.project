{
  while (true) {
    State current=state.get();
switch (current) {
case HEADERS:
      if (!updateState(current,State.COMMIT))       continue;
    LOG.debug("Committed {}",request);
  requestNotifier.notifyCommit(request);
return true;
case COMMIT:
if (!updateState(current,State.COMMIT)) continue;
return true;
case FAILURE:
return false;
default :
throw new IllegalStateException();
}
}
}
