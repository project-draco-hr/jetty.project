{
  int maxLength=32;
  int requestCount=iterations(maxLength);
  final CountDownLatch latch=new CountDownLatch(requestCount);
  configureServer(new HelloWorldHandler());
  Socket client=newSocket(HOST,_connector.getLocalPort());
  try {
    OutputStream os=client.getOutputStream();
    ResponseReader reader=new ResponseReader(client){
      private int _index=0;
      @Override protected int doRead() throws IOException, InterruptedException {
        int count=super.doRead();
        if (count > 0) {
          int idx;
          while ((idx=_response.indexOf("HTTP/1.1 200 OK",_index)) >= 0) {
            latch.countDown();
            _index=idx + 15;
          }
        }
        return count;
      }
    }
;
    Thread runner=new Thread(reader);
    runner.start();
    for (int pipeline=1; pipeline < maxLength; pipeline++) {
      if (pipeline == maxLength / 2)       _connector.close();
      String request="";
      for (int i=0; i < pipeline; i++) {
        request+="GET /data?writes=1&block=16&id=" + i + " HTTP/1.1\r\n"+ "host: "+ HOST+ ":"+ _connector.getLocalPort()+ "\r\n"+ "user-agent: testharness/1.0 (blah foo/bar)\r\n"+ "accept-encoding: nothing\r\n"+ "cookie: aaa=1234567890\r\n"+ "\r\n";
      }
      os.write(request.getBytes());
      os.flush();
      Thread.sleep(25);
    }
    latch.await(30,TimeUnit.SECONDS);
    reader.setDone();
    runner.join();
  }
  finally {
    client.close();
    assertEquals(requestCount,requestCount - latch.getCount());
  }
}
