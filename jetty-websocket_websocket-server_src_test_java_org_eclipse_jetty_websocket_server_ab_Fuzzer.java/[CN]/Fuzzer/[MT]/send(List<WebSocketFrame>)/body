{
  Assert.assertThat("Client connected",client.isConnected(),is(true));
  LOG.debug("[{}] Sending {} frames (mode {})",testname,send.size(),sendMode);
  if ((sendMode == SendMode.BULK) || (sendMode == SendMode.SLOW)) {
    int buflen=0;
    for (    Frame f : send) {
      buflen+=f.getPayloadLength() + Generator.OVERHEAD;
    }
    ByteBuffer buf=ByteBuffer.allocateDirect(buflen);
    BufferUtil.clearToFill(buf);
    for (    WebSocketFrame f : send) {
      setClientMask(f);
      ByteBuffer rawbytes=generator.generate(f);
      if (LOG.isDebugEnabled()) {
        LOG.debug("frame: {}",f);
        LOG.debug("bytes: {}",BufferUtil.toDetailString(rawbytes));
      }
      BufferUtil.put(rawbytes,buf);
    }
    BufferUtil.flipToFlush(buf,0);
switch (sendMode) {
case BULK:
      client.writeRaw(buf);
    break;
case SLOW:
  client.writeRawSlowly(buf,slowSendSegmentSize);
break;
default :
throw new RuntimeException("Whoops, unsupported sendMode: " + sendMode);
}
}
 else if (sendMode == SendMode.PER_FRAME) {
for (WebSocketFrame f : send) {
f.setMask(MASK);
client.writeRaw(generator.generate(f));
client.flush();
}
}
}
