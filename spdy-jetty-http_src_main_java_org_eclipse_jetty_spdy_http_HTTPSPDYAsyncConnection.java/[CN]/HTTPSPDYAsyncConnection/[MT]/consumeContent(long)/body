{
  boolean filled=false;
  while (true) {
    State state=this.state;
    if (state != State.HEADERS_COMPLETE && state != State.CONTENT && state != State.FINAL)     throw new IllegalStateException();
    Buffer buffer=this.buffer;
    logger.debug("Consuming {} content bytes",buffer.length());
    if (buffer.length() > 0)     return buffer;
    if (complete)     return null;
    if (filled) {
      logger.debug("Waiting at most {} ms for content bytes",maxIdleTime);
      long begin=System.nanoTime();
      boolean expired=!connection.getEndPoint().blockReadable(maxIdleTime);
      if (expired) {
        stream.getSession().goAway(stream.getVersion());
        throw new EOFException("read timeout");
      }
      logger.debug("Waited {} ms for content bytes",TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - begin));
    }
    connection.fill();
    filled=true;
  }
}
