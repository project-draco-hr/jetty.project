{
  Headers headers=new Headers();
  StringBuilder status=new StringBuilder().append(_status);
  if (_reason != null)   status.append(" ").append(_reason.toString("UTF-8"));
  headers.put("status",status.toString());
  headers.put("version","HTTP/1.1");
  if (fields != null) {
    for (int i=0; i < fields.size(); ++i) {
      HttpFields.Field field=fields.getField(i);
      headers.put(field.getName(),field.getValue());
    }
  }
  boolean close=_buffer == null || _buffer.length() == 0;
  stream.reply(new ReplyInfo(headers,close));
  if (!close) {
    ByteBuffer buffer=((NIOBuffer)_buffer).getByteBuffer();
    buffer.limit(_buffer.putIndex());
    buffer.position(_buffer.getIndex());
    _buffer.clear();
    _state=HttpGenerator.STATE_CONTENT;
    stream.data(new ByteBufferDataInfo(buffer,allContentAdded));
  }
}
