{
  if ("WebSocket".equals(request.getHeader("Upgrade"))) {
    boolean hixie=request.getHeader("Sec-WebSocket-Key1") != null;
    String protocol=request.getHeader(hixie ? "Sec-WebSocket-Protocol" : "WebSocket-Protocol");
    if (protocol == null)     protocol=request.getHeader("Sec-WebSocket-Protocol");
    WebSocket websocket=doWebSocketConnect(request,protocol);
    String host=request.getHeader("Host");
    String origin=request.getHeader("Origin");
    origin=checkOrigin(request,host,origin);
    if (websocket != null)     _websocket.upgrade(request,response,websocket,origin,protocol);
 else {
      if (hixie)       response.setHeader("Connection","close");
      response.sendError(503);
    }
  }
 else   super.service(request,response);
}
