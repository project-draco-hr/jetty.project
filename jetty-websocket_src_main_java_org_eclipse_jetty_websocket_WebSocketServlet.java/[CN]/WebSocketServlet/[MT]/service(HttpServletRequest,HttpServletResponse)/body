{
  if ("WebSocket".equals(request.getHeader("Upgrade")) && "HTTP/1.1".equals(request.getProtocol())) {
    String protocol=request.getHeader("WebSocket-Protocol");
    WebSocket websocket=doWebSocketConnect(request,protocol);
    if (websocket != null) {
      HttpConnection http=HttpConnection.getCurrentConnection();
      ConnectedEndPoint endp=(ConnectedEndPoint)http.getEndPoint();
      WebSocketConnection connection=new WebSocketConnection(_buffers,endp,http.getTimeStamp(),websocket);
      String uri=request.getRequestURI();
      String host=request.getHeader("Host");
      String origin=request.getHeader("Origin");
      origin=checkOrigin(request,host,origin);
      response.setHeader("Upgrade","WebSocket");
      response.addHeader("Connection","Upgrade");
      response.addHeader("WebSocket-Origin",origin);
      response.addHeader("WebSocket-Location","ws://" + host + uri);
      if (protocol != null)       response.addHeader("WebSocket-Protocol",protocol);
      response.sendError(101,"Web Socket Protocol Handshake");
      response.flushBuffer();
      connection.fill(((HttpParser)http.getParser()).getHeaderBuffer());
      connection.fill(((HttpParser)http.getParser()).getBodyBuffer());
      websocket.onConnect(connection);
      throw new UpgradeConnectionException(connection);
    }
 else {
      response.sendError(503);
    }
  }
 else   super.service(request,response);
}
