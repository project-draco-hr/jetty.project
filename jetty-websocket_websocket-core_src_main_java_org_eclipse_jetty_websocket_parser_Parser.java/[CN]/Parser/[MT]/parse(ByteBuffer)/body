{
  try {
    LOG.debug("Parsing {} bytes",buffer.remaining());
    while (buffer.hasRemaining()) {
switch (state) {
case FINOP:
{
          byte b=buffer.get();
          boolean fin=((b & 0x80) != 0);
          boolean rsv1=((b & 0x40) != 0);
          boolean rsv2=((b & 0x20) != 0);
          boolean rsv3=((b & 0x10) != 0);
          OpCode opcode=OpCode.from((byte)(b & 0x0F));
          if (opcode.isControlFrame() && !fin) {
            throw new WebSocketException("Fragmented Control Frame [" + opcode.name() + "]");
          }
          if (parser == null) {
            parser=parsers.get(opcode);
            parser.reset();
            parser.initFrame(fin,rsv1,rsv2,rsv3,opcode);
          }
          state=State.BASE_FRAMING;
          break;
        }
case BASE_FRAMING:
{
        if (parser.parseBaseFraming(buffer)) {
          state=State.PAYLOAD;
        }
        break;
      }
case PAYLOAD:
{
      if (parser.parsePayload(buffer)) {
        notifyFrame(parser.getFrame());
        reset();
        state=State.FINOP;
      }
      break;
    }
}
}
}
 catch (WebSocketException e) {
notifyWebSocketException(e);
}
catch (Throwable t) {
notifyWebSocketException(new WebSocketException(t));
}
 finally {
buffer.position(buffer.limit());
}
}
