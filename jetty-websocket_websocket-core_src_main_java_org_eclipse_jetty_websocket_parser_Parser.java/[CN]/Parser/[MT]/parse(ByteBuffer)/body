{
  try {
    LOG.debug("Parsing {} bytes",buffer.remaining());
    while (buffer.hasRemaining()) {
switch (state) {
case FINOP:
{
          byte b=buffer.get();
          boolean fin=((b & 0x80) != 0);
          boolean rsv1=((b & 0x40) != 0);
          boolean rsv2=((b & 0x20) != 0);
          boolean rsv3=((b & 0x10) != 0);
          byte opc=(byte)(b & 0x0F);
          OpCode opcode=OpCode.from(opc);
          if (opcode == null) {
            throw new WebSocketException("Unknown opcode: " + opc);
          }
          if (opcode.isControlFrame() && !fin) {
            throw new WebSocketException("Fragmented Control Frame [" + opcode.name() + "]");
          }
          if (opcode == OpCode.CONTINUATION) {
            if (parser == null) {
              throw new WebSocketException("Fragment continuation frame without prior !FIN");
            }
            currentContinuationIndex++;
          }
          if (parser == null) {
            parser=parsers.get(opcode);
          }
          parser.reset();
          parser.initFrame(fin,rsv1,rsv2,rsv3,opcode);
          if (parser.getFrame() instanceof DataFrame) {
            ((DataFrame)parser.getFrame()).setContinuationIndex(currentContinuationIndex);
          }
          state=State.BASE_FRAMING;
          break;
        }
case BASE_FRAMING:
{
        if (parser.parseBaseFraming(buffer)) {
          state=State.PAYLOAD;
        }
        break;
      }
case PAYLOAD:
{
      if (parser.parsePayload(buffer)) {
        notifyFrame(parser.getFrame());
        parser.reset();
        if (parser.getFrame().isFin()) {
          currentContinuationIndex=0;
          reset();
        }
        state=State.FINOP;
      }
      break;
    }
}
}
}
 catch (WebSocketException e) {
notifyWebSocketException(e);
}
catch (Throwable t) {
notifyWebSocketException(new WebSocketException(t));
}
 finally {
buffer.position(buffer.limit());
}
}
