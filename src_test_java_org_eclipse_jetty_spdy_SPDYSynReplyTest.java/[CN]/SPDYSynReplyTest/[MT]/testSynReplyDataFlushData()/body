{
  final String data1="foo";
  final String data2="bar";
  ServerSessionFrameListener serverSessionFrameListener=new ServerSessionFrameListener.Adapter(){
    @Override public Stream.FrameListener onSyn(    Stream stream,    SynInfo synInfo){
      Assert.assertTrue(stream.isHalfClosed());
      stream.reply(new ReplyInfo(false));
      stream.data(new StringDataInfo(data1,false));
      stream.getSession().flush();
      stream.data(new StringDataInfo(data2,true));
      return null;
    }
  }
;
  Session session=startClient(startServer(serverSessionFrameListener),null);
  final CountDownLatch replyLatch=new CountDownLatch(1);
  final CountDownLatch dataLatch1=new CountDownLatch(1);
  final CountDownLatch dataLatch2=new CountDownLatch(1);
  session.syn((short)2,new SynInfo(true),new Stream.FrameListener.Adapter(){
    private AtomicInteger dataCount=new AtomicInteger();
    @Override public void onReply(    Stream stream,    ReplyInfo replyInfo){
      Assert.assertFalse(replyInfo.isClose());
      replyLatch.countDown();
    }
    @Override public void onData(    Stream stream,    DataInfo dataInfo){
      final ByteBuffer buffer=ByteBuffer.allocate(dataInfo.getBytesCount());
      dataInfo.getBytes(buffer);
      buffer.flip();
      int dataCount=this.dataCount.incrementAndGet();
      if (dataCount == 1) {
        String chunk1=Charset.forName("UTF-8").decode(buffer).toString();
        Assert.assertEquals(data1,chunk1);
        dataLatch1.countDown();
      }
 else       if (dataCount == 2) {
        String chunk2=Charset.forName("UTF-8").decode(buffer).toString();
        Assert.assertEquals(data2,chunk2);
        dataLatch2.countDown();
      }
    }
  }
);
  Assert.assertTrue(replyLatch.await(5,TimeUnit.SECONDS));
  Assert.assertTrue(dataLatch1.await(5,TimeUnit.SECONDS));
  Assert.assertTrue(dataLatch2.await(5,TimeUnit.SECONDS));
}
