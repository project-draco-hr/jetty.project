{
  if (payloadLength == 0) {
    return true;
  }
  while (buffer.hasRemaining()) {
    if (payload == null) {
      getPolicy().assertValidPayloadLength(payloadLength);
      frame.assertValid();
      payload=ByteBuffer.allocate(payloadLength);
      BufferUtil.clearToFill(payload);
    }
    BufferUtil.put(buffer,payload);
    if (payload.position() >= payloadLength) {
      BufferUtil.flipToFlush(payload,0);
      LOG.debug("PreMask: {}",BufferUtil.toDetailString(payload));
      if (frame.isMasked()) {
        byte mask[]=frame.getMask();
        int offset;
        int start=payload.position();
        int end=payload.limit();
        for (int i=start; i < end; i++) {
          offset=(i - start);
          payload.put(i,(byte)(payload.get(i) ^ mask[offset % 4]));
        }
      }
      frame.setPayload(payload);
      this.payload=null;
      return true;
    }
  }
  return false;
}
