{
  if (updateState(State.IDLE,State.RECEIVE)) {
    HttpExchange exchange=connection.getExchange();
    if (exchange != null) {
      HttpConversation conversation=exchange.getConversation();
      HttpResponse response=exchange.getResponse();
      response.version(version).status(status).reason(reason);
      HttpExchange initialExchange=conversation.getExchanges().peekFirst();
      HttpClient client=connection.getHttpClient();
      ProtocolHandler protocolHandler=client.findProtocolHandler(exchange.getRequest(),response);
      Response.Listener handlerListener=protocolHandler == null ? null : protocolHandler.getResponseListener();
      if (handlerListener == null) {
        exchange.setLast(true);
        if (initialExchange == exchange) {
          conversation.setResponseListeners(exchange.getResponseListeners());
        }
 else {
          List<Response.ResponseListener> listeners=new ArrayList<>(exchange.getResponseListeners());
          listeners.addAll(initialExchange.getResponseListeners());
          conversation.setResponseListeners(listeners);
        }
      }
 else {
        LOG.debug("Found protocol handler {}",protocolHandler);
        if (initialExchange == exchange) {
          conversation.setResponseListeners(Collections.<Response.ResponseListener>singletonList(handlerListener));
        }
 else {
          List<Response.ResponseListener> listeners=new ArrayList<>(exchange.getResponseListeners());
          listeners.add(handlerListener);
          conversation.setResponseListeners(listeners);
        }
      }
      LOG.debug("Receiving {}",response);
      responseNotifier.notifyBegin(conversation.getResponseListeners(),response);
    }
  }
  return false;
}
