{
  try {
    allocateBuffers();
    boolean progress=true;
    while (progress) {
      progress=false;
      int filled=0, flushed=0;
      if (_inbound.space() > 0 && (filled=_endp.fill(_inbound)) > 0)       progress=true;
      if (_outbound.hasContent() && (flushed=_endp.flush(_outbound)) > 0)       progress=true;
      LOG.debug("{} filled={} flushed={}",_session,filled,flushed);
      if (_engine.getHandshakeStatus() == HandshakeStatus.NOT_HANDSHAKING) {
        AsyncConnection next=(AsyncConnection)_delegate.handle();
        if (next != _delegate && next == null) {
          _delegate=next;
          progress=true;
        }
      }
 else {
        process(null,null);
      }
    }
  }
  finally {
    releaseBuffers();
  }
  return this;
}
