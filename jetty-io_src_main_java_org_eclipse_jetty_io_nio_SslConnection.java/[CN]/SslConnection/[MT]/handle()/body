{
  try {
    allocateBuffers();
    boolean progress=true;
    while (progress) {
      progress=false;
      int filled=0, flushed=0;
      if (_inbound.space() > 0 && (filled=_endp.fill(_inbound)) > 0)       progress=true;
      if (_outbound.hasContent() && (flushed=_endp.flush(_outbound)) > 0)       progress=true;
      LOG.debug("{} filled={} flushed={}",_session,filled,flushed);
      if (_engine.getHandshakeStatus() != HandshakeStatus.NOT_HANDSHAKING)       process(null,null);
 else {
        AsyncConnection next=(AsyncConnection)_connection.handle();
        if (next != _connection && next == null) {
          _connection=next;
          progress=true;
        }
      }
      if (!_inbound.hasContent() && _endp.isInputShutdown())       _engine.closeInbound();
      if (!_outbound.hasContent() && _engine.isOutboundDone())       _endp.shutdownOutput();
    }
  }
  finally {
    releaseBuffers();
  }
  return this;
}
