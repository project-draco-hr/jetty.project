{
  _server=new Server();
  SslSocketConnector connector=new SslSocketConnector();
  String keystore=MavenTestingUtils.getTestResourceFile("keystore").getAbsolutePath();
  connector.setPort(0);
  SslContextFactory cf=connector.getSslContextFactory();
  cf.setKeyStorePath(keystore);
  cf.setKeyStorePassword("storepwd");
  cf.setKeyManagerPassword("keypwd");
  _server.setConnectors(new Connector[]{connector});
  Constraint constraint=new Constraint();
  constraint.setName("Need User or Admin");
  constraint.setRoles(new String[]{"user","admin"});
  constraint.setAuthenticate(true);
  ConstraintMapping cm=new ConstraintMapping();
  cm.setConstraint(constraint);
  cm.setPathSpec("/*");
  File realmPropFile=MavenTestingUtils.getTestResourceFile("realm.properties");
  LoginService loginService=new HashLoginService("MyRealm",realmPropFile.getAbsolutePath());
  _server.addBean(loginService);
  BasicAuthenticator authenticator=new BasicAuthenticator();
  ConstraintSecurityHandler sh=new ConstraintSecurityHandler();
  sh.setAuthenticator(authenticator);
  Set<String> roles=new HashSet<String>(Arrays.asList(new String[]{"user","admin"}));
  sh.setConstraintMappings(Collections.singletonList(cm),roles);
  _server.setHandler(sh);
  Handler testHandler=new AbstractHandler(){
    public void handle(    String target,    Request baseRequest,    HttpServletRequest request,    HttpServletResponse response) throws IOException, ServletException {
      baseRequest.setHandled(true);
      response.setStatus(200);
      response.setContentType("text/plain");
      if (request.getServerName().equals("jetty.eclipse.org")) {
        response.getOutputStream().println("Proxy request: " + request.getRequestURL());
      }
 else       if (request.getMethod().equalsIgnoreCase("GET")) {
        response.getOutputStream().println("<hello>");
        for (int i=0; i < 100; i++) {
          response.getOutputStream().println("  <world>" + i + "</world>");
          if (i % 20 == 0)           response.getOutputStream().flush();
        }
        response.getOutputStream().println("</hello>");
      }
 else {
        copyStream(request.getInputStream(),response.getOutputStream());
      }
    }
  }
;
  sh.setHandler(testHandler);
  _server.start();
  _port=connector.getLocalPort();
}
