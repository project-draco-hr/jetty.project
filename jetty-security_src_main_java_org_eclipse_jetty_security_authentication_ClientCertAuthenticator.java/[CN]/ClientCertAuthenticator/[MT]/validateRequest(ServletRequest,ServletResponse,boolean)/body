{
  HttpServletRequest request=(HttpServletRequest)req;
  HttpServletResponse response=(HttpServletResponse)res;
  java.security.cert.X509Certificate[] certs=(java.security.cert.X509Certificate[])request.getAttribute("javax.servlet.request.X509Certificate");
  try {
    if (certs == null || certs.length == 0 || certs[0] == null) {
      response.sendError(HttpServletResponse.SC_FORBIDDEN,"!certificate");
      return Authentication.FAILED;
    }
    Principal principal=certs[0].getSubjectDN();
    if (principal == null)     principal=certs[0].getIssuerDN();
    final String username=principal == null ? "clientcert" : principal.getName();
    final char[] credential=B64Code.encode(certs[0].getSignature());
    UserIdentity user=_loginService.login(username,credential);
    if (user != null)     return new DefaultAuthentication(this,user);
    if (!mandatory)     return Authentication.NOT_CHECKED;
    response.sendError(HttpServletResponse.SC_FORBIDDEN);
    return Authentication.FAILED;
  }
 catch (  IOException e) {
    throw new ServerAuthException(e.getMessage());
  }
}
