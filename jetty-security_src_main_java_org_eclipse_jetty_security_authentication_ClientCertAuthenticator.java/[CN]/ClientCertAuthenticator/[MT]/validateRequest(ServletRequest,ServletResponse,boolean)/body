{
  if (!mandatory)   return _deferred;
  HttpServletRequest request=(HttpServletRequest)req;
  HttpServletResponse response=(HttpServletResponse)res;
  X509Certificate[] certs=(X509Certificate[])request.getAttribute("javax.servlet.request.X509Certificate");
  try {
    if (certs != null && certs.length > 0) {
      for (      X509Certificate cert : certs) {
        if (cert == null)         continue;
        Principal principal=cert.getSubjectDN();
        if (principal == null)         principal=cert.getIssuerDN();
        final String username=principal == null ? "clientcert" : principal.getName();
        final char[] credential=B64Code.encode(cert.getSignature());
        UserIdentity user=_loginService.login(username,credential);
        if (user != null) {
          renewSessionOnAuthentication(request,response);
          return new UserAuthentication(getAuthMethod(),user);
        }
      }
    }
    if (!_deferred.isDeferred(response)) {
      response.sendError(HttpServletResponse.SC_FORBIDDEN);
      return Authentication.SEND_FAILURE;
    }
    return Authentication.UNAUTHENTICATED;
  }
 catch (  IOException e) {
    throw new ServerAuthException(e.getMessage());
  }
}
