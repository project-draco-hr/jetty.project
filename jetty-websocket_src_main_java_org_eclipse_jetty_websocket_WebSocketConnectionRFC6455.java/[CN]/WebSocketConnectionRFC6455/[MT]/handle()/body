{
  Thread current=Thread.currentThread();
  ClassLoader oldcontext=current.getContextClassLoader();
  current.setContextClassLoader(_context);
  try {
    boolean progress=true;
    while (progress) {
      int flushed=_generator.flushBuffer();
      int filled=_parser.parseNext();
      progress=flushed > 0 || filled > 0;
      _endp.flush();
      if (_endp instanceof AsyncEndPoint && ((AsyncEndPoint)_endp).hasProgressed())       progress=true;
    }
  }
 catch (  IOException e) {
    try {
      if (_endp.isOpen())       _endp.close();
    }
 catch (    IOException e2) {
      LOG.ignore(e2);
    }
    throw e;
  }
 finally {
    current.setContextClassLoader(oldcontext);
    _parser.returnBuffer();
    _generator.returnBuffer();
    if (_endp.isOpen()) {
      if (_closedIn && _closedOut && _outbound.isBufferEmpty())       _endp.close();
 else       if (_endp.isInputShutdown() && !_closedIn)       closeIn(CLOSE_NO_CLOSE,null);
 else       checkWriteable();
    }
  }
  return this;
}
