{
  BlockheadClient client=new BlockheadClient(server.getServerUri());
  client.clearExtensions();
  client.addExtensions("x-deflate-frame;minLength=8");
  client.setProtocols("echo");
  try {
    client.setTimeout(TimeUnit.SECONDS,1);
    client.connect();
    client.sendStandardRequest();
    String resp=client.expectUpgradeResponse();
    Assert.assertThat("Response",resp,containsString("x-deflate"));
    StringBuilder msg=new StringBuilder();
    for (int i=0; i < 400; i++) {
      msg.append("0123456789ABCDEF ");
    }
    msg.append('X');
    client.write(WebSocketFrame.text(msg.toString()));
    IncomingFramesCapture capture=client.readFrames(1,TimeUnit.MILLISECONDS,1000);
    WebSocketFrame frame=capture.getFrames().get(0);
    Assert.assertThat("TEXT.payload",frame.getPayloadAsUTF8(),is(msg.toString()));
  }
  finally {
    client.close();
  }
}
