{
  try {
    _client.getFactory().addConnection(connection);
    connection.getConnection().setMaxTextMessageSize(_client.getMaxTextMessageSize());
    connection.getConnection().setMaxBinaryMessageSize(_client.getMaxBinaryMessageSize());
    WebSocketConnection con;
synchronized (this) {
      if (_channel != null)       _connection=connection;
      con=_connection;
    }
    if (con != null) {
      if (_websocket instanceof WebSocket.OnFrame)       ((WebSocket.OnFrame)_websocket).onHandshake((WebSocket.FrameConnection)con.getConnection());
      _websocket.onOpen(con.getConnection());
    }
  }
  finally {
    _done.countDown();
  }
}
