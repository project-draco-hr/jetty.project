{
  Connection connection=this;
  try {
    setCurrentConnection(this);
    while (_endp.isOpen() && connection == this) {
      try {
        if (!_parser.isComplete() && !_endp.isInputShutdown())         _parser.parseAvailable();
        if (_generator.isCommitted() && !_generator.isComplete() && !_endp.isOutputShutdown())         _generator.flushBuffer();
        _endp.flush();
      }
 catch (      HttpException e) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("uri=" + _uri);
          LOG.debug("fields=" + _requestFields);
          LOG.debug(e);
        }
        _generator.sendError(e.getStatus(),e.getReason(),null,true);
        _parser.reset();
        _endp.shutdownOutput();
      }
 finally {
        if (_parser.isComplete() && _generator.isComplete()) {
          reset();
          if (_response.getStatus() == HttpStatus.SWITCHING_PROTOCOLS_101) {
            Connection switched=(Connection)_request.getAttribute("org.eclipse.jetty.io.Connection");
            if (switched != null)             connection=switched;
          }
          if (!_generator.isPersistent() && !_endp.isOutputShutdown()) {
            LOG.warn("Safety net oshut!!! Please open a bugzilla");
            _endp.shutdownOutput();
          }
        }
        if (_endp.isInputShutdown() && _generator.isIdle() && !_request.getAsyncContinuation().isSuspended()) {
          _endp.close();
        }
      }
    }
    return connection;
  }
  finally {
    setCurrentConnection(null);
    _parser.returnBuffers();
    _generator.returnBuffers();
  }
}
