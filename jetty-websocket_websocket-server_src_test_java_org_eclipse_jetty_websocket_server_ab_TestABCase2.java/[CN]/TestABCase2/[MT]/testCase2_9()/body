{
  BlockheadClient client=new BlockheadClient(server.getServerUri());
  try {
    client.connect();
    client.sendStandardRequest();
    client.expectUpgradeResponse();
    byte pongPayload[]=StringUtil.getUtf8Bytes("unsolicited");
    ByteBuffer buf=ByteBuffer.allocate(512);
    BufferUtil.clearToFill(buf);
    buf.put((byte)(0x00 | FIN | OpCode.PONG.getCode()));
    putPayloadLength(buf,pongPayload.length);
    putMask(buf);
    buf.put(masked(pongPayload));
    byte pingPayload[]=StringUtil.getUtf8Bytes("ping me");
    buf.put((byte)(0x00 | FIN | OpCode.PING.getCode()));
    putPayloadLength(buf,pingPayload.length);
    putMask(buf);
    buf.put(masked(pingPayload));
    buf.put((byte)(0x00 | FIN | OpCode.CLOSE.getCode()));
    putPayloadLength(buf,2);
    putMask(buf);
    buf.put(masked(new byte[]{0x03,(byte)0xE8}));
    BufferUtil.flipToFlush(buf,0);
    client.writeRaw(buf);
    client.flush();
    IncomingFramesCapture capture=client.readFrames(2,TimeUnit.MILLISECONDS,500);
    WebSocketFrame frame=capture.getFrames().pop();
    Assert.assertThat("frame should be PONG frame",frame.getOpCode(),is(OpCode.PONG));
    Assert.assertThat("PONG.payloadLength",frame.getPayloadLength(),is(pingPayload.length));
    ByteBufferAssert.assertEquals("PONG.payload",pingPayload,frame.getPayload());
    frame=capture.getFrames().pop();
    Assert.assertThat("CLOSE.frame.opcode",frame.getOpCode(),is(OpCode.CLOSE));
    CloseInfo close=new CloseInfo(frame);
    Assert.assertThat("CLOSE.statusCode",close.getStatusCode(),is(StatusCode.NORMAL));
  }
  finally {
    client.disconnect();
  }
}
