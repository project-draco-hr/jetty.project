{
  try {
    if (!HttpMethod.HEAD.is(request.getMethod())) {
      if (_etags) {
        String ifm=request.getHeader(HttpHeader.IF_MATCH.asString());
        if (ifm != null) {
          boolean match=false;
          if (content != null && content.getETag() != null) {
            QuotedStringTokenizer quoted=new QuotedStringTokenizer(ifm,", ",false,true);
            while (!match && quoted.hasMoreTokens()) {
              String tag=quoted.nextToken();
              if (content.getETag().toString().equals(tag))               match=true;
            }
          }
          if (!match) {
            Response r=Response.getResponse(response);
            r.reset(true);
            r.setStatus(HttpServletResponse.SC_PRECONDITION_FAILED);
            return false;
          }
        }
        String ifnm=request.getHeader(HttpHeader.IF_NONE_MATCH.asString());
        if (ifnm != null && content != null && content.getETag() != null) {
          if (content.getETag().toString().equals(request.getAttribute("o.e.j.s.GzipFilter.ETag"))) {
            Response r=Response.getResponse(response);
            r.reset(true);
            r.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
            r.getHttpFields().put(HttpHeader.ETAG,ifnm);
            return false;
          }
          if (content.getETag().toString().equals(ifnm)) {
            Response r=Response.getResponse(response);
            r.reset(true);
            r.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
            r.getHttpFields().put(HttpHeader.ETAG,content.getETag());
            return false;
          }
          QuotedStringTokenizer quoted=new QuotedStringTokenizer(ifnm,", ",false,true);
          while (quoted.hasMoreTokens()) {
            String tag=quoted.nextToken();
            if (content.getETag().toString().equals(tag)) {
              Response r=Response.getResponse(response);
              r.reset(true);
              r.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
              r.getHttpFields().put(HttpHeader.ETAG,content.getETag());
              return false;
            }
          }
          return true;
        }
      }
      String ifms=request.getHeader(HttpHeader.IF_MODIFIED_SINCE.asString());
      if (ifms != null) {
        Response r=Response.getResponse(response);
        if (content != null) {
          String mdlm=content.getLastModified();
          if (mdlm != null) {
            if (ifms.equals(mdlm)) {
              r.reset(true);
              r.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
              if (_etags)               r.getHttpFields().add(HttpHeaders.ETAG_BUFFER,content.getETag());
              r.flushBuffer();
              return false;
            }
          }
        }
        long ifmsl=request.getDateHeader(HttpHeader.IF_MODIFIED_SINCE.asString());
        if (ifmsl != -1) {
          if (resource.lastModified() / 1000 <= ifmsl / 1000) {
            r.reset(true);
            r.setStatus(HttpServletResponse.SC_NOT_MODIFIED);
            if (_etags)             r.getHttpFields().add(HttpHeaders.ETAG_BUFFER,content.getETag());
            r.flushBuffer();
            return false;
          }
        }
      }
      long date=request.getDateHeader(HttpHeader.IF_UNMODIFIED_SINCE.asString());
      if (date != -1) {
        if (resource.lastModified() / 1000 > date / 1000) {
          response.sendError(HttpServletResponse.SC_PRECONDITION_FAILED);
          return false;
        }
      }
    }
  }
 catch (  IllegalArgumentException iae) {
    if (!response.isCommitted())     response.sendError(400,iae.getMessage());
    throw iae;
  }
  return true;
}
