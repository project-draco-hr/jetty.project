{
  String body="";
  ByteBuffer header=BufferUtil.allocate(4096);
  ByteBuffer buffer=BufferUtil.allocate(8096);
  ByteBuffer content=BufferUtil.toBuffer("Hello World");
  ByteBuffer content1=BufferUtil.toBuffer(". The quick brown fox jumped over the lazy dog.");
  HttpGenerator gen=new HttpGenerator();
  HttpGenerator.Result result=gen.generate(HttpGenerator.CONTINUE_100_INFO,null,null,null,null,Action.COMPLETE);
  assertEquals(HttpGenerator.Result.NEED_HEADER,result);
  assertEquals(HttpGenerator.State.COMMITTING_COMPLETING,gen.getState());
  result=gen.generate(HttpGenerator.CONTINUE_100_INFO,header,null,null,null,Action.COMPLETE);
  assertEquals(HttpGenerator.Result.FLUSH,result);
  assertEquals(HttpGenerator.State.COMPLETING_1XX,gen.getState());
  assertThat(BufferUtil.toString(header),Matchers.startsWith("HTTP/1.1 100 Continue"));
  BufferUtil.clear(header);
  result=gen.generate(null,null,null,null,null,null);
  assertEquals(HttpGenerator.Result.OK,result);
  assertEquals(HttpGenerator.State.START,gen.getState());
  result=gen.generate(null,null,null,null,content,null);
  assertEquals(HttpGenerator.Result.NEED_BUFFER,result);
  assertEquals(HttpGenerator.State.START,gen.getState());
  result=gen.generate(null,null,null,buffer,content,null);
  assertEquals(HttpGenerator.Result.OK,result);
  assertEquals(HttpGenerator.State.START,gen.getState());
  assertEquals("Hello World",BufferUtil.toString(buffer));
  assertTrue(BufferUtil.isEmpty(content));
  result=gen.generate(null,null,null,buffer,content1,null);
  assertEquals(HttpGenerator.Result.OK,result);
  assertEquals(HttpGenerator.State.START,gen.getState());
  assertEquals("Hello World. The quick brown fox jumped over the lazy dog.",BufferUtil.toString(buffer));
  assertTrue(BufferUtil.isEmpty(content1));
  result=gen.generate(null,null,null,buffer,null,Action.COMPLETE);
  assertEquals(HttpGenerator.Result.NEED_INFO,result);
  assertEquals(HttpGenerator.State.COMMITTING_COMPLETING,gen.getState());
  ResponseInfo info=new ResponseInfo(HttpVersion.HTTP_1_1,new HttpFields(),-1,200,null,false);
  info.getHttpFields().add("Last-Modified",HttpFields.__01Jan1970);
  result=gen.generate(info,header,null,buffer,null,null);
  assertEquals(HttpGenerator.Result.FLUSH,result);
  assertEquals(HttpGenerator.State.COMPLETING,gen.getState());
  String head=BufferUtil.toString(header);
  BufferUtil.clear(header);
  body+=BufferUtil.toString(buffer);
  BufferUtil.clear(buffer);
  result=gen.generate(info,null,null,buffer,null,null);
  assertEquals(HttpGenerator.Result.OK,result);
  assertEquals(HttpGenerator.State.END,gen.getState());
  assertThat(head,containsString("HTTP/1.1 200 OK"));
  assertThat(head,containsString("Last-Modified: Thu, 01 Jan 1970 00:00:00 GMT"));
  assertThat(head,containsString("Content-Length: 58"));
  assertTrue(head.endsWith("\r\n\r\n"));
  assertEquals("Hello World. The quick brown fox jumped over the lazy dog.",body);
  assertEquals(58,gen.getContentPrepared());
}
