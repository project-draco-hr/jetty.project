{
  final Request base_request=(request instanceof Request) ? (Request)request : HttpConnection.getCurrentConnection().getRequest();
  final Response base_response=(response instanceof Response) ? (Response)response : HttpConnection.getCurrentConnection().getResponse();
  final Handler handler=getHandler();
  if (handler == null)   return;
  if (_authenticator != null && checkSecurity(base_request)) {
    Object constraintInfo=prepareConstraintInfo(pathInContext,base_request);
    if (!checkUserDataPermissions(pathInContext,base_request,base_response,constraintInfo)) {
      if (!base_request.isHandled()) {
        response.sendError(Response.SC_FORBIDDEN);
        base_request.setHandled(true);
      }
      return;
    }
    boolean isAuthMandatory=isAuthMandatory(base_request,base_response,constraintInfo);
    try {
      final Authenticator authenticator=_authenticator;
      Authentication authentication=base_request.getAuthentication();
      if (authentication == null || authentication == Authentication.NOT_CHECKED)       authentication=authenticator.validateRequest(request,response,isAuthMandatory);
      if (authentication instanceof Authentication.ResponseSent) {
        base_request.setHandled(true);
      }
 else       if (authentication instanceof Authentication.User) {
        Authentication.User userAuth=(Authentication.User)authentication;
        base_request.setAuthentication(authentication);
        _identityService.associate(userAuth.getUserIdentity());
        boolean authorized=checkWebResourcePermissions(pathInContext,base_request,base_response,constraintInfo,userAuth.getUserIdentity());
        if (isAuthMandatory && !authorized) {
          response.sendError(Response.SC_FORBIDDEN,"!role");
          base_request.setHandled(true);
          return;
        }
        handler.handle(pathInContext,request,response);
        authenticator.secureResponse(request,response,isAuthMandatory,userAuth);
      }
 else       if (authentication instanceof Authentication.Deferred) {
        DeferredAuthentication lazy=(DeferredAuthentication)authentication;
        lazy.setIdentityService(_identityService);
        base_request.setAuthentication(authentication);
        try {
          handler.handle(pathInContext,request,response);
        }
  finally {
          lazy.setIdentityService(null);
        }
        Authentication auth=base_request.getAuthentication();
        if (auth instanceof Authentication.User) {
          Authentication.User userAuth=(Authentication.User)auth;
          authenticator.secureResponse(request,response,isAuthMandatory,userAuth);
        }
 else         authenticator.secureResponse(request,response,isAuthMandatory,null);
      }
 else {
        base_request.setAuthentication(authentication);
        handler.handle(pathInContext,request,response);
        authenticator.secureResponse(request,response,isAuthMandatory,null);
      }
    }
 catch (    ServerAuthException e) {
      response.sendError(Response.SC_INTERNAL_SERVER_ERROR,e.getMessage());
    }
 finally {
      _identityService.associate(null);
    }
  }
 else   handler.handle(pathInContext,request,response);
}
