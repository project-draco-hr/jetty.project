{
  Socket client=newClient();
  client.setSoTimeout(30000);
  SocketChannel server=_connector.accept();
  server.configureBlocking(false);
  _manager.register(server);
  int writes=100000;
  final byte[] bytes="HelloWorld".getBytes("UTF-8");
  final CountDownLatch latch=new CountDownLatch(writes);
  final InputStream in=new BufferedInputStream(client.getInputStream());
  final long start=System.currentTimeMillis();
  client.getOutputStream().write(bytes);
  client.getOutputStream().flush();
  new Thread(){
    public void run(){
      try {
        while (latch.getCount() > 0) {
          for (          byte b0 : bytes) {
            int b=in.read();
            assertTrue(b > 0);
            assertEquals(0xff & b0,b);
          }
          latch.countDown();
        }
      }
 catch (      Throwable e) {
        System.err.println("latch=" + latch.getCount());
        System.err.println("time=" + (System.currentTimeMillis() - start));
        e.printStackTrace();
      }
    }
  }
.start();
  for (int i=1; i < writes; i++) {
    client.getOutputStream().write(bytes);
    Thread.yield();
  }
  client.getOutputStream().flush();
  assertTrue(latch.await(100,TimeUnit.SECONDS));
}
