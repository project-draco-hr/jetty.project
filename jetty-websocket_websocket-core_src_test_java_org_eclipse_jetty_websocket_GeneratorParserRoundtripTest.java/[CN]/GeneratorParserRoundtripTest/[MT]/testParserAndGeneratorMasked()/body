{
  WebSocketPolicy policy=WebSocketPolicy.newServerPolicy();
  policy.setMasker(new RandomMasker());
  StandardByteBufferPool bufferPool=new StandardByteBufferPool();
  Generator gen=new Generator(policy,bufferPool);
  Parser parser=new Parser(policy);
  FrameParseCapture capture=new FrameParseCapture();
  parser.addListener(capture);
  String message="0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF";
  ByteBuffer out=bufferPool.acquire(policy.getBufferSize(),false);
  try {
    WebSocketFrame frame=WebSocketFrame.text(message);
    byte mask[]=new byte[4];
    new FixedMasker().genMask(mask);
    frame.setMask(mask);
    out=gen.generate(policy.getBufferSize(),frame);
    BufferUtil.flipToFlush(out,0);
    parser.parse(out);
  }
  finally {
    bufferPool.release(out);
  }
  capture.assertNoErrors();
  capture.assertHasFrame(OpCode.TEXT,1);
  WebSocketFrame txt=capture.getFrames().get(0);
  Assert.assertTrue("Text.isMasked",txt.isMasked());
  Assert.assertThat("Text parsed",txt.getPayloadAsUTF8(),is(message));
}
