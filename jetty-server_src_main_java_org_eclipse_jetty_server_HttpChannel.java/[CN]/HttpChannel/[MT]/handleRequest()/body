{
  LOG.debug("{} handleRequest",this);
  String threadName=null;
  if (LOG.isDebugEnabled()) {
    threadName=Thread.currentThread().getName();
    Thread.currentThread().setName(threadName + " - " + _uri);
  }
  Throwable async_exception=null;
  __currentChannel.set(this);
  try {
    boolean handling=_state.handling();
    while (handling && getServer().isRunning()) {
      try {
        _request.setHandled(false);
        _out.reopen();
        if (_state.isInitial()) {
          _request.setDispatcherType(DispatcherType.REQUEST);
          getHttpConnector().customize(_request);
          getServer().handle(this);
        }
 else {
          _request.setDispatcherType(DispatcherType.ASYNC);
          getServer().handleAsync(this);
        }
      }
 catch (      ContinuationThrowable e) {
        LOG.ignore(e);
      }
catch (      ServletException e) {
      }
catch (      EofException e) {
        LOG.debug(e);
        async_exception=e;
        _request.setHandled(true);
      }
catch (      Throwable e) {
        LOG.warn(String.valueOf(_uri),e);
        async_exception=e;
        _request.setHandled(true);
        sendError(500,null,e.toString(),true);
      }
 finally {
        handling=!_state.unhandle();
      }
    }
  }
  finally {
    __currentChannel.set(null);
    if (threadName != null)     Thread.currentThread().setName(threadName);
    if (_state.isUncompleted()) {
      _state.doComplete(async_exception);
      if (_expect100Continue) {
        LOG.debug("100 continues not sent");
        _expect100Continue=false;
        if (!_response.isCommitted())         _response.addHeader(HttpHeader.CONNECTION,HttpHeaderValue.CLOSE.toString());
      }
      if (!_response.isCommitted() && !_request.isHandled())       _response.sendError(HttpServletResponse.SC_NOT_FOUND);
      _response.complete();
      _request.setHandled(true);
      completed();
    }
  }
}
