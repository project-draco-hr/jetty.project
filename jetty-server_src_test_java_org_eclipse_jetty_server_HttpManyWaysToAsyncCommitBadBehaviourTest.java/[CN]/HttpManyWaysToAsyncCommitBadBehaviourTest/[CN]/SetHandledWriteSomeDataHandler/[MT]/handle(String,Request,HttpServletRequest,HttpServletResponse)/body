{
  final CyclicBarrier resumeBarrier=new CyclicBarrier(1);
  if (request.getAttribute(CONTEXT_ATTRIBUTE) == null) {
    final AsyncContext asyncContext=baseRequest.startAsync();
    new Thread(new Runnable(){
      @Override public void run(){
        try {
          asyncContext.getResponse().getWriter().write("foobar");
          if (dispatch)           asyncContext.dispatch();
 else           asyncContext.complete();
          resumeBarrier.await(5,TimeUnit.SECONDS);
        }
 catch (        IOException|TimeoutException|InterruptedException|BrokenBarrierException e) {
          e.printStackTrace();
        }
      }
    }
).run();
  }
  try {
    resumeBarrier.await(5,TimeUnit.SECONDS);
  }
 catch (  InterruptedException|BrokenBarrierException|TimeoutException e) {
    e.printStackTrace();
  }
  throw new TestCommitException();
}
