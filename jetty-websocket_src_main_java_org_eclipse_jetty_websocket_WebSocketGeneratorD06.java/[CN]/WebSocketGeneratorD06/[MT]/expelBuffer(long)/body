{
  if (_buffer == null)   return 0;
  int result=flushBuffer();
  _buffer.compact();
  if (!_endp.isBlocking()) {
    while (_buffer.space() == 0) {
      boolean ready=_endp.blockWritable(blockFor);
      if (!ready)       throw new IOException("Write timeout");
      result+=flushBuffer();
      _buffer.compact();
    }
  }
  return result;
}
