{
  System.err.println("testBlockingWhileWritingResponseContent");
  configureServer(new DataHandler());
  long start=System.currentTimeMillis();
  Socket client=newSocket(HOST,_connector.getLocalPort());
  int total=0;
  try {
    OutputStream os=client.getOutputStream();
    InputStream is=client.getInputStream();
    os.write(("GET /data?writes=512&block=1024 HTTP/1.1\r\n" + "host: " + HOST + ":"+ _connector.getLocalPort()+ "\r\n"+ "connection: close\r\n"+ "content-type: unknown\r\n"+ "\r\n").getBytes());
    os.flush();
    int len=0;
    byte[] buf=new byte[1024 * 32];
    int i=0;
    while (len >= 0) {
      if (i++ % 10 == 0)       Thread.sleep(1000);
      len=is.read(buf);
      if (len > 0)       total+=len;
    }
    assertTrue(total > (512 * 1024));
    assertTrue(30000L > (System.currentTimeMillis() - start));
  }
  finally {
    System.err.println("Got " + total + " of "+ (512 * 1024));
    client.close();
  }
}
