{
  CommittedErrorHandler handler=new CommittedErrorHandler();
  configureServer(handler);
  Socket client=newSocket(HOST,_connector.getLocalPort());
  try {
    ((StdErrLog)Log.getLogger(HttpChannel.class)).setHideStacks(true);
    OutputStream os=client.getOutputStream();
    InputStream is=client.getInputStream();
    os.write(("GET / HTTP/1.1\r\n" + "Host: " + HOST + ":"+ _connector.getLocalPort()+ "\r\n"+ "\r\n").getBytes());
    os.flush();
    client.setSoTimeout(2000);
    String in=IO.toString(is);
    assertEquals(-1,is.read());
    assertTrue(in.contains("HTTP/1.1 200 OK"));
    assertTrue(in.indexOf("Transfer-Encoding: chunked") > 0);
    assertTrue(in.indexOf("Now is the time for all good men to come to the aid of the party") > 0);
    assertTrue(in.contains("\r\n0\r\n"));
    client.close();
    Thread.sleep(200);
    if (handler._endp.isOpen()) {
      System.err.println(handler._endp);
      System.err.println(((SslConnection.DecryptedEndPoint)handler._endp).getEncryptedEndPoint());
      System.err.println(handler._endp.getConnection());
    }
    assertTrue(!handler._endp.isOpen());
  }
  finally {
    ((StdErrLog)Log.getLogger(HttpChannel.class)).setHideStacks(false);
    if (!client.isClosed())     client.close();
  }
}
