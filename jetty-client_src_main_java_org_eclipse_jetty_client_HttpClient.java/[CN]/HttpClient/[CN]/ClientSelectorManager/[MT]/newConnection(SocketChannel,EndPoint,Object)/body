{
  ConnectionCallback callback=(ConnectionCallback)attachment;
  HttpDestination destination=callback.destination;
  SslContextFactory sslContextFactory=getSslContextFactory();
  if (HttpScheme.HTTPS.is(destination.getScheme())) {
    if (sslContextFactory == null) {
      IOException failure=new ConnectException("Missing " + SslContextFactory.class.getSimpleName() + " for "+ destination.getScheme()+ " requests");
      callback.failed(failure);
      throw failure;
    }
 else {
      SSLEngine engine=sslContextFactory.newSSLEngine(destination.getHost(),destination.getPort());
      engine.setUseClientMode(true);
      SslConnection sslConnection=newSslConnection(HttpClient.this,endPoint,engine);
      EndPoint appEndPoint=sslConnection.getDecryptedEndPoint();
      HttpConnection connection=newHttpConnection(HttpClient.this,appEndPoint,destination);
      appEndPoint.setConnection(connection);
      callback.succeeded(connection);
      return sslConnection;
    }
  }
 else {
    HttpConnection connection=newHttpConnection(HttpClient.this,endPoint,destination);
    callback.succeeded(connection);
    return connection;
  }
}
