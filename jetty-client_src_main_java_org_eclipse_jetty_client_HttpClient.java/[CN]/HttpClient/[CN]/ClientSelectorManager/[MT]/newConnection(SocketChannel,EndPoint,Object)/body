{
  ConnectionCallback callback=(ConnectionCallback)attachment;
  HttpDestination destination=callback.destination;
  SslContextFactory sslContextFactory=getSslContextFactory();
  if (!destination.isProxied() && HttpScheme.HTTPS.is(destination.getScheme())) {
    if (sslContextFactory == null) {
      IOException failure=new ConnectException("Missing " + SslContextFactory.class.getSimpleName() + " for "+ destination.getScheme()+ " requests");
      callback.failed(failure);
      throw failure;
    }
 else {
      SslConnection sslConnection=createSslConnection(destination,endPoint);
      callback.succeeded((Connection)sslConnection.getDecryptedEndPoint().getConnection());
      return sslConnection;
    }
  }
 else {
    HttpConnection connection=newHttpConnection(HttpClient.this,endPoint,destination);
    callback.succeeded(connection);
    return connection;
  }
}
