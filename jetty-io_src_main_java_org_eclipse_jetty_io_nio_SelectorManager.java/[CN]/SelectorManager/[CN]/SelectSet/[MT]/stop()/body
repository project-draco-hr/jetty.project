{
  boolean selecting=true;
  while (selecting) {
    wakeup();
    selecting=_selecting != null;
  }
  ArrayList<SelectionKey> keys=new ArrayList<SelectionKey>(_selector.keys());
  Iterator<SelectionKey> iter=keys.iterator();
  while (iter.hasNext()) {
    SelectionKey key=(SelectionKey)iter.next();
    if (key == null)     continue;
    Object att=key.attachment();
    if (att instanceof EndPoint) {
      EndPoint endpoint=(EndPoint)att;
      try {
        endpoint.close();
      }
 catch (      IOException e) {
        Log.ignore(e);
      }
    }
  }
synchronized (this) {
    selecting=_selecting != null;
    while (selecting) {
      wakeup();
      selecting=_selecting != null;
    }
    _idleTimeout.cancelAll();
    _timeout.cancelAll();
    try {
      if (_selector != null)       _selector.close();
    }
 catch (    IOException e) {
      Log.ignore(e);
    }
    _selector=null;
  }
}
