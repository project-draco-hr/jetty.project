{
  String body="";
  ByteBuffer header=BufferUtil.allocate(4096);
  ByteBuffer content0=BufferUtil.toBuffer("Hello World! ");
  ByteBuffer content1=BufferUtil.toBuffer("The quick brown fox jumped over the lazy dog. ");
  Info info=new Info(200);
  HttpGenerator gen=new HttpGenerator(info);
  gen.setLargeContent(8);
  info.getHttpFields().add("Last-Modified",HttpFields.__01Jan1970);
  info.getHttpFields().add("Content-Length","59");
  info.setContentLength(59);
  HttpGenerator.Result result=gen.generate(null,null,null,content0,null);
  assertEquals(HttpGenerator.Result.NEED_HEADER,result);
  assertEquals(HttpGenerator.State.COMMITTING,gen.getState());
  result=gen.generate(header,null,null,content0,null);
  assertEquals(HttpGenerator.Result.FLUSH_CONTENT,result);
  assertEquals(HttpGenerator.State.COMMITTED,gen.getState());
  assertTrue(!gen.isChunking());
  String head=BufferUtil.toString(header);
  BufferUtil.clear(header);
  body+=BufferUtil.toString(content0);
  BufferUtil.clear(content0);
  result=gen.generate(header,null,null,null,null);
  assertEquals(HttpGenerator.Result.OK,result);
  assertEquals(HttpGenerator.State.COMMITTED,gen.getState());
  result=gen.generate(null,null,null,content1,null);
  assertEquals(HttpGenerator.Result.FLUSH_CONTENT,result);
  assertEquals(HttpGenerator.State.COMMITTED,gen.getState());
  body+=BufferUtil.toString(content1);
  BufferUtil.clear(content1);
  result=gen.generate(null,null,null,null,Action.COMPLETE);
  assertEquals(HttpGenerator.Result.OK,result);
  assertEquals(HttpGenerator.State.END,gen.getState());
  assertEquals(59,gen.getContentWritten());
  assertThat(head,containsString("HTTP/1.1 200 OK"));
  assertThat(head,containsString("Last-Modified: Thu, 01 Jan 1970 00?00?00 GMT"));
  assertThat(head,containsString("Content-Length: 59"));
  assertThat(head,not(containsString("chunked")));
  assertTrue(head.endsWith("\r\n\r\n"));
}
