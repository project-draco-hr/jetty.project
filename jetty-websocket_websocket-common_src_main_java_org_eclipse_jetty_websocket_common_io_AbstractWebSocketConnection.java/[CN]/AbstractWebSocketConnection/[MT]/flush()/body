{
  FrameBytes frameBytes=null;
  ByteBuffer buffer=null;
synchronized (queue) {
    if (queue.isFailed()) {
      LOG.debug(".flush() - queue is in failed state");
      return;
    }
    if (flushing || queue.isEmpty()) {
      return;
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug(".flush() - flushing={} - queue.size = {}",flushing,queue.size());
    }
    frameBytes=queue.pop();
    if (!isOpen()) {
      queue.fail(new WebSocketException("Connection closed"));
      return;
    }
    LOG.debug("Next FrameBytes: {}",frameBytes);
    buffer=frameBytes.getByteBuffer();
    if (buffer == null) {
      return;
    }
    flushing=true;
    if (LOG.isDebugEnabled()) {
      LOG.debug("Flushing {}, {} frame(s) in queue",frameBytes,queue.size());
    }
  }
  write(buffer,frameBytes);
}
