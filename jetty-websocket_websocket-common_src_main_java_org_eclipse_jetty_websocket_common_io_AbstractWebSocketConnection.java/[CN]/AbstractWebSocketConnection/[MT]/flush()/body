{
  ByteBuffer buffer=null;
synchronized (writeBytes) {
    if (writeBytes.isFailed()) {
      LOG.debug(".flush() - queue is in failed state");
      return;
    }
    if (flushing) {
      return;
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug(".flush() - flushing={} - writeBytes={}",flushing,writeBytes);
    }
    if (!isOpen()) {
      writeBytes.failAll(new WebSocketException("Connection closed"));
      return;
    }
    buffer=writeBytes.getByteBuffer();
    if (buffer == null) {
      return;
    }
    flushing=true;
    if (LOG.isDebugEnabled()) {
      LOG.debug("Flushing {} - {}",BufferUtil.toDetailString(buffer),writeBytes);
    }
  }
  write(buffer);
}
