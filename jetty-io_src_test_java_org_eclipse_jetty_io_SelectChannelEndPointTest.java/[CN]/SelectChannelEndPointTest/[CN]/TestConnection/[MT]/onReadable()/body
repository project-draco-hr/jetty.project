{
  AsyncEndPoint _endp=getEndPoint();
  try {
    _last=System.currentTimeMillis();
    _endp.setCheckForIdle(false);
    boolean progress=true;
    while (progress) {
      progress=false;
      if (BufferUtil.isFull(_in))       throw new IllegalStateException("FULL " + BufferUtil.toDetailString(_in));
      int filled=_endp.fill(_in);
      if (filled > 0)       progress=true;
      System.err.println("filled " + filled);
      while (_blockAt > 0 && _endp.isOpen() && _in.remaining() < _blockAt) {
        FutureCallback<Void> blockingRead=new FutureCallback<>();
        System.err.println("blocking read on " + blockingRead);
        _endp.readable(null,blockingRead);
        blockingRead.get();
        filled=_endp.fill(_in);
        System.err.println("FILLED " + filled);
        progress|=filled > 0;
      }
      if (BufferUtil.hasContent(_in) && BufferUtil.append(_in,_out) > 0)       progress=true;
      if (BufferUtil.hasContent(_out)) {
        ByteBuffer out=_out.duplicate();
        BufferUtil.clear(_out);
        for (int i=0; i < _writeCount; i++) {
          FutureCallback<Void> blockingWrite=new FutureCallback<>();
          _endp.write(null,blockingWrite,out.asReadOnlyBuffer());
          blockingWrite.get();
        }
        progress=true;
      }
      if (_endp.isInputShutdown())       _endp.shutdownOutput();
    }
  }
 catch (  ExecutionException e) {
    try {
      FutureCallback<Void> blockingWrite=new FutureCallback<>();
      _endp.write(null,blockingWrite,BufferUtil.toBuffer("EE: " + BufferUtil.toString(_in)));
      blockingWrite.get();
      _endp.shutdownOutput();
    }
 catch (    Exception e2) {
      e2.printStackTrace();
    }
  }
catch (  InterruptedException e) {
  }
catch (  Exception e) {
    e.printStackTrace();
  }
 finally {
    if (_endp.isOpen()) {
      _endp.setCheckForIdle(true);
      scheduleOnReadable();
    }
  }
}
