{
  try (ServerSocket connector=new ServerSocket(0);Socket client=new Socket("127.0.0.1",connector.getLocalPort());Socket server=connector.accept()){
    client.setTcpNoDelay(true);
    client.setSoLinger(true,0);
    server.setTcpNoDelay(true);
    server.setSoLinger(true,0);
    client.getOutputStream().write(1);
    assertEquals(1,server.getInputStream().read());
    server.getOutputStream().write(1);
    assertEquals(1,client.getInputStream().read());
    server.shutdownOutput();
    assertEquals(-1,client.getInputStream().read());
    client.shutdownInput();
    client.shutdownOutput();
    client.close();
    assertEquals(-1,server.getInputStream().read());
    server.shutdownInput();
    server.close();
  }
 }
