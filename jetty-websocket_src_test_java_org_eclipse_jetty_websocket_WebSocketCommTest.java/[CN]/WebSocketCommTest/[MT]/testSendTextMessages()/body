{
  WebSocketClientFactory clientFactory=new WebSocketClientFactory();
  clientFactory.start();
  WebSocketClient wsc=clientFactory.newWebSocketClient();
  MessageSender sender=new MessageSender();
  wsc.open(serverUri,sender);
  try {
    sender.awaitConnect();
    for (int i=0; i < 5; i++) {
      System.out.printf("Sending msg-%d%n",i);
      sender.sendMessage("msg-%d",i);
    }
    Assert.assertThat("Servlet.captureSockets.size",servlet.captures.size(),is(1));
    CaptureSocket socket=servlet.captures.get(0);
    Assert.assertThat("CaptureSocket",socket,notNullValue());
    Assert.assertThat("CaptureSocket.isConnected",socket.awaitConnected(1000),is(true));
    TimeUnit.MILLISECONDS.sleep(500);
    Assert.assertThat("CaptureSocket.messages.size",socket.messages.size(),is(5));
  }
  finally {
    System.out.println("Closing client socket");
    sender.close();
  }
}
