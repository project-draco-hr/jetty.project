{
  WebSocketClient client=new WebSocketClient();
  client.setConnectTimeout(500);
  client.setBlockingConnect(true);
  client.start();
  ServerSocket server=new ServerSocket();
  server.bind(null);
  int port=server.getLocalPort();
  boolean bad=false;
  final AtomicReference<String> error=new AtomicReference<String>(null);
  final CountDownLatch latch=new CountDownLatch(1);
  try {
    client.open(new URI("ws://127.0.0.1:" + port),new WebSocket(){
      public void onOpen(      Connection connection){
        latch.countDown();
      }
      public void onError(      String message,      Throwable ex){
        error.set(message);
        latch.countDown();
      }
      public void onClose(      int closeCode,      String message){
        latch.countDown();
      }
    }
);
  }
 catch (  IOException e) {
    e.printStackTrace();
    bad=true;
  }
  Assert.assertNotNull(server.accept());
  Assert.assertTrue(latch.await(1,TimeUnit.SECONDS));
  Assert.assertTrue(bad || error.get() != null);
}
