{
  WebSocketClient client=new WebSocketClient();
  client.start();
  final AtomicBoolean open=new AtomicBoolean();
  final AtomicInteger close=new AtomicInteger();
  Future<WebSocket.Connection> future=client.open(new URI("ws://127.0.0.1:" + _serverPort + "/"),new WebSocket(){
    public void onOpen(    Connection connection){
      open.set(true);
    }
    public void onClose(    int closeCode,    String message){
      close.set(closeCode);
    }
  }
);
  Socket connection=_server.accept();
  respondToClient(connection,"HTTP/1.1 404 NOT FOUND\r\n\r\n");
  Throwable error=null;
  try {
    future.get(250,TimeUnit.MILLISECONDS);
    Assert.fail();
  }
 catch (  ExecutionException e) {
    error=e.getCause();
  }
  Assert.assertFalse(open.get());
  Assert.assertEquals(WebSocketConnectionD11.CLOSE_PROTOCOL,close.get());
  Assert.assertTrue(error instanceof IOException);
  Assert.assertTrue(error.getMessage().indexOf("404 NOT FOUND") > 0);
}
