{
  HttpServletRequest request=(HttpServletRequest)req;
  HttpServletResponse response=(HttpServletResponse)res;
  String credentials=request.getHeader(HttpHeaders.AUTHORIZATION);
  try {
    if (!mandatory)     return _deferred;
    if (credentials != null) {
      credentials=credentials.substring(credentials.indexOf(' ') + 1);
      credentials=B64Code.decode(credentials,StringUtil.__ISO_8859_1);
      int i=credentials.indexOf(':');
      if (i > 0) {
        String username=credentials.substring(0,i);
        String password=credentials.substring(i + 1);
        UserIdentity user=_loginService.login(username,password);
        if (user != null) {
          renewSessionOnAuthentication(request,response);
          return new UserAuthentication(getAuthMethod(),user);
        }
      }
    }
    if (_deferred.isDeferred(response))     return Authentication.UNAUTHENTICATED;
    response.setHeader(HttpHeaders.WWW_AUTHENTICATE,"basic realm=\"" + _loginService.getName() + '"');
    response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
    return Authentication.SEND_CONTINUE;
  }
 catch (  IOException e) {
    throw new ServerAuthException(e);
  }
}
