{
  Server server=new Server();
  SelectChannelConnector connector=new SelectChannelConnector();
  server.addConnector(connector);
  server.setHandler(new EmptyHandler());
  server.start();
  try {
    _total=0;
    final Socket socket=new Socket("localhost",connector.getLocalPort());
    byte[] content=new byte[16 * 4096];
    Arrays.fill(content,(byte)120);
    long start=System.nanoTime();
    OutputStream out=socket.getOutputStream();
    out.write("POST / HTTP/1.1\r\n".getBytes());
    out.write("Host: localhost\r\n".getBytes());
    out.write(("Content-Length: " + content.length + "\r\n").getBytes());
    out.write("Content-Type: bytes\r\n".getBytes());
    out.write("Connection: close\r\n".getBytes());
    out.write("\r\n".getBytes());
    out.flush();
    out.write(content,0,4 * 4096);
    Thread.sleep(100);
    out.write(content,8192,4 * 4096);
    Thread.sleep(100);
    out.write(content,8 * 4096,content.length - 8 * 4096);
    out.flush();
    InputStream in=socket.getInputStream();
    String response=IO.toString(in);
    assertTrue(response.indexOf("200 OK") > 0);
    long end=System.nanoTime();
    System.err.println("upload time: " + TimeUnit.NANOSECONDS.toMillis(end - start));
    assertEquals(content.length,_total);
  }
  finally {
    server.stop();
  }
}
