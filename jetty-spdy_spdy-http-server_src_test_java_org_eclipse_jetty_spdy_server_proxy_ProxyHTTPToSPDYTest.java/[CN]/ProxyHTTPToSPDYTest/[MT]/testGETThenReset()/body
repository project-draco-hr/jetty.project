{
  InetSocketAddress proxyAddress=startProxy(startServer(new ServerSessionFrameListener.Adapter(){
    @Override public StreamFrameListener onSyn(    Stream stream,    SynInfo synInfo){
      Assert.assertTrue(synInfo.isClose());
      Fields requestHeaders=synInfo.getHeaders();
      Assert.assertNotNull(requestHeaders.get("via"));
      stream.getSession().rst(new RstInfo(stream.getId(),StreamStatus.REFUSED_STREAM),new Callback.Adapter());
      return null;
    }
  }
));
  ContentResponse response=httpClient.newRequest("localhost",proxyAddress.getPort()).method(HttpMethod.GET).send();
  assertThat("response code is 502 Gateway Error",response.getStatus(),is(502));
}
