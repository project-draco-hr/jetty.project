{
  State currentState=_state.get();
  boolean updated=false;
  while (!updated) {
    if (!isTransitionAllowed(currentState,newState))     return null;
    updated=_state.compareAndSet(currentState,newState);
    logger.debug("StateType update: {} -> {} {}",currentState,newState,updated ? "" : "failed");
    if (!updated)     currentState=_state.get();
  }
  return currentState;
}
