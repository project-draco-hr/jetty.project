{
  String text="XYZ";
  final byte[] data=text.getBytes(StandardCharsets.ISO_8859_1);
  final AtomicBoolean allDataRead=new AtomicBoolean(false);
  startServer(new HttpServlet(){
    @Override protected void service(    HttpServletRequest request,    final HttpServletResponse response) throws ServletException, IOException {
      response.flushBuffer();
      final AsyncContext async=request.startAsync();
      final ServletInputStream in=request.getInputStream();
      final ServletOutputStream out=response.getOutputStream();
      in.setReadListener(new ReadListener(){
        @Override public void onError(        Throwable t){
          t.printStackTrace();
        }
        @Override public void onDataAvailable() throws IOException {
          while (in.isReady()) {
            int b=in.read();
            if (b < 0) {
              out.write("OK\n".getBytes(StandardCharsets.ISO_8859_1));
              async.complete();
              return;
            }
          }
        }
        @Override public void onAllDataRead() throws IOException {
          out.write("BAD!!!\n".getBytes(StandardCharsets.ISO_8859_1));
          allDataRead.set(true);
          throw new IllegalStateException();
        }
      }
);
    }
  }
);
  String request="GET " + path + " HTTP/1.1\r\n"+ "Host: localhost:"+ connector.getLocalPort()+ "\r\n"+ "Content-Type: text/plain\r\n"+ "Content-Length: "+ data.length+ "\r\n"+ "Connection: close\r\n"+ "\r\n";
  try (Socket client=new Socket("localhost",connector.getLocalPort())){
    OutputStream output=client.getOutputStream();
    output.write(request.getBytes("UTF-8"));
    output.flush();
    Thread.sleep(100);
    output.write(data);
    output.flush();
    BufferedReader in=new BufferedReader(new InputStreamReader(client.getInputStream()));
    String line=in.readLine();
    assertThat(line,containsString("200 OK"));
    while (line.length() > 0) {
      line=in.readLine();
    }
    line=in.readLine();
    assertThat(line,containsString("OK"));
    Assert.assertFalse(allDataRead.get());
  }
 }
