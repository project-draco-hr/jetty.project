{
  byte[] utf8_bytes="/%D0%A1%D1%82%D1%80%D0%BE%D0%BD%D0%B3-%D1%84%D0%B8%D0%BB%D1%8C%D1%82%D1%80/%D0%BA%D0%B0%D1%82%D0%B0%D0%BB%D0%BE%D0%B3?".getBytes("UTF-8");
  byte[] cp1251_bytes=TypeUtil.fromHexString("e2fbe1f0e0edee3dd2e5ecefe5f0e0f2f3f0e0");
  String expectedCP1251String=new String(cp1251_bytes,"cp1251");
  String expectedCP1251Key=new String(cp1251_bytes,0,7,"cp1251");
  String expectedCP1251Value=new String(cp1251_bytes,8,cp1251_bytes.length - 8,"cp1251");
  byte[] allbytes=new byte[utf8_bytes.length + cp1251_bytes.length];
  int i=0;
  for (; i < utf8_bytes.length; i++) {
    allbytes[i]=utf8_bytes[i];
  }
  for (int j=0; j < cp1251_bytes.length; j++)   allbytes[i + j]=cp1251_bytes[j];
  HttpURI uri=new HttpURI(Charset.forName("cp1251"));
  uri.parse(allbytes,0,allbytes.length);
  assertEquals(expectedCP1251String,uri.getQuery("cp1251"));
  MultiMap params=new MultiMap();
  uri.decodeQueryTo(params);
  String val=params.getString(expectedCP1251Key);
  assertNotNull(val);
  assertEquals(expectedCP1251Value,val);
  HttpURI httpuri=new HttpURI();
  httpuri.parse(allbytes,0,allbytes.length);
  assertNotNull(httpuri.getQuery("UTF-8"));
  assertEquals(expectedCP1251String,httpuri.getQuery("cp1251"));
  params.clear();
  httpuri.decodeQueryTo(params,"cp1251");
  val=params.getString(expectedCP1251Key);
  assertNotNull(val);
  assertEquals(expectedCP1251Value,val);
  Request request=new Request(null,null);
  request.setUri(httpuri);
  request.setAttribute("org.eclipse.jetty.server.Request.queryEncoding","ISO-8859-1");
  assertNotNull(request.getQueryString());
  request.setAttribute("org.eclipse.jetty.server.Request.queryEncoding","cp1251");
  assertEquals(expectedCP1251String,request.getQueryString());
}
