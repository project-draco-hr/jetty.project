{
  TrackingSocket wsocket=new TrackingSocket();
  WebSocketClient client=factory.newWebSocketClient(wsocket);
  client.getPolicy().setIdleTimeout(500);
  URI wsUri=server.getWsUri();
  Future<UpgradeResponse> future=client.connect(wsUri);
  ServerConnection ssocket=server.accept();
  ssocket.upgrade();
  future.get(250,TimeUnit.MILLISECONDS);
  wsocket.assertIsOpen();
  byte[] recv=new byte[1024];
  int len=-1;
  for (int i=0; i < 10; i++) {
    Thread.sleep(250);
    wsocket.getConnection().write(null,new FutureCallback<Void>(),"Hello");
    len=ssocket.getInputStream().read(recv,0,recv.length);
    Assert.assertTrue(len > 0);
  }
  byte[] send=new byte[]{(byte)0x81,(byte)0x02,(byte)'H',(byte)'i'};
  for (int i=0; i < 10; i++) {
    Thread.sleep(250);
    ssocket.write(send,0,send.length);
    ssocket.flush();
    Assert.assertEquals("Hi",wsocket.messageQueue.poll(1,TimeUnit.SECONDS));
  }
  long start=System.currentTimeMillis();
  ssocket.write(new byte[]{(byte)0x88,(byte)0x02,(byte)4,(byte)87},0,4);
  ssocket.flush();
  wsocket.closeLatch.await(10,TimeUnit.SECONDS);
  long dur=(System.currentTimeMillis() - start);
  Assert.assertThat("Overall duration",dur,lessThanOrEqualTo(5000L));
  wsocket.assertClose(StatusCode.PROTOCOL,"Invalid close code 1111");
}
