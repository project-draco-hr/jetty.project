{
  int bufferSize=512;
  factory.getPolicy().setBufferSize(512);
  WebSocketClient client=factory.newWebSocketClient();
  TrackingSocket wsocket=new TrackingSocket();
  URI wsUri=server.getWsUri();
  Future<WebSocketConnection> future=client.connect(wsUri,wsocket);
  ServerConnection ssocket=server.accept();
  ssocket.upgrade();
  Assert.assertTrue(wsocket.openLatch.await(1,TimeUnit.SECONDS));
  int length=bufferSize + (bufferSize / 2);
  ssocket.write(0x80 | 0x01);
  ssocket.write(0x7E);
  ssocket.write(length >> 8);
  ssocket.write(length & 0xFF);
  for (int i=0; i < length; ++i) {
    ssocket.write('x');
  }
  ssocket.flush();
  Assert.assertTrue(wsocket.dataLatch.await(1000,TimeUnit.SECONDS));
}
