{
  WebSocketClient client=new WebSocketClient();
  client.start();
  try {
    TrackingSocket wsocket=new TrackingSocket();
    Future<Session> future=client.connect(wsocket,server.getWsUri());
    final ServerConnection srvSock=server.accept();
    srvSock.upgrade();
    Session sess=future.get(500,TimeUnit.MILLISECONDS);
    Assert.assertThat("Session",sess,notNullValue());
    Assert.assertThat("Session.open",sess.isOpen(),is(true));
    Assert.assertThat("Session.upgradeRequest",sess.getUpgradeRequest(),notNullValue());
    Assert.assertThat("Session.upgradeResponse",sess.getUpgradeResponse(),notNullValue());
    srvSock.write(WebSocketFrame.text("Hello World"));
    future.get(500,TimeUnit.MILLISECONDS);
    wsocket.assertWasOpened();
    wsocket.awaitMessage(1,TimeUnit.SECONDS,2);
    wsocket.assertMessage("Hello World");
  }
  finally {
    client.stop();
  }
}
