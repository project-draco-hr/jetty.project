{
  WebSocketClientFactory factory=new WebSocketClientFactory();
  WebSocketClient client=factory.newWebSocketClient();
  client.getPolicy().setIdleTimeout(500);
  TrackingSocket wsocket=new TrackingSocket();
  URI wsUri=new URI("ws://127.0.0.1:" + server.getPort() + "/");
  Future<WebSocketConnection> future=client.connect(wsUri,wsocket);
  ServerConnection ssocket=server.accept();
  ssocket.upgrade();
  WebSocketConnection connection=future.get(250,TimeUnit.MILLISECONDS);
  Assert.assertNotNull(connection);
  wsocket.assertWasOpened();
  wsocket.assertNotClosed();
  long start=System.currentTimeMillis();
  wsocket.closeLatch.await(10,TimeUnit.SECONDS);
  Assert.assertTrue((System.currentTimeMillis() - start) < 5000);
  wsocket.assertCloseCode(StatusCode.NORMAL);
}
