{
  if (policy.getBehavior() == WebSocketBehavior.CLIENT) {
    throw new MuxPhysicalConnectionException(MuxDropChannel.Reason.UNKNOWN_MUX_CONTROL_BLOCK,"AddChannelRequest not allowed per spec");
  }
  if (request.getRsv() != 0) {
    throw new MuxPhysicalConnectionException(MuxDropChannel.Reason.UNKNOWN_REQUEST_ENCODING,"RSV Not allowed to be set");
  }
  if (request.getChannelId() == CONTROL_CHANNEL_ID) {
    throw new MuxPhysicalConnectionException(MuxDropChannel.Reason.UNKNOWN_MUX_CONTROL_BLOCK,"Invalid Channel ID");
  }
  long channelId=request.getChannelId();
  MuxChannel channel=new MuxChannel(channelId,this);
  this.channels.put(channelId,channel);
  try {
    MuxAddChannelResponse response=addServer.handshake(physicalConnection,request);
    if (response == null) {
      LOG.warn("AddChannelResponse is null");
      response=new MuxAddChannelResponse();
      response.setChannelId(request.getChannelId());
      response.setFailed(true);
    }
    this.generator.generate(response);
  }
 catch (  Throwable t) {
    throw new MuxPhysicalConnectionException(MuxDropChannel.Reason.BAD_REQUEST,"Unable to parse request",t);
  }
}
