{
  ByteBuffer chunk=_chunk;
  while (true) {
    HttpGenerator.Result result=_generator.generateResponse(_info,_header,chunk,_content,_lastContent);
    if (LOG.isDebugEnabled())     LOG.debug("{} generate: {} ({},{},{})@{}",this,result,BufferUtil.toSummaryString(_header),BufferUtil.toSummaryString(_content),_lastContent,_generator.getState());
switch (result) {
case NEED_HEADER:
{
        if (_lastContent && _content != null && !_content.isReadOnly() && _content.hasArray() && BufferUtil.space(_content) > _config.getResponseHeaderSize()) {
          int p=_content.position();
          int l=_content.limit();
          _content.position(l);
          _content.limit(l + _config.getResponseHeaderSize());
          _header=_content.slice();
          _header.limit(0);
          _content.position(p);
          _content.limit(l);
        }
 else         _header=_bufferPool.acquire(_config.getResponseHeaderSize(),HEADER_BUFFER_DIRECT);
        continue;
      }
case NEED_CHUNK:
{
      chunk=_chunk=_bufferPool.acquire(HttpGenerator.CHUNK_SIZE,CHUNK_BUFFER_DIRECT);
      continue;
    }
case FLUSH:
{
    if (_channel.getRequest().isHead()) {
      BufferUtil.clear(chunk);
      BufferUtil.clear(_content);
    }
    if (BufferUtil.hasContent(_header)) {
      if (BufferUtil.hasContent(_content)) {
        if (BufferUtil.hasContent(chunk))         getEndPoint().write(this,_header,chunk,_content);
 else         getEndPoint().write(this,_header,_content);
      }
 else       getEndPoint().write(this,_header);
    }
 else     if (BufferUtil.hasContent(chunk)) {
      if (BufferUtil.hasContent(_content))       getEndPoint().write(this,chunk,_content);
 else       getEndPoint().write(this,chunk);
    }
 else     if (BufferUtil.hasContent(_content)) {
      getEndPoint().write(this,_content);
    }
 else     continue;
    return State.SCHEDULED;
  }
case SHUTDOWN_OUT:
{
  getEndPoint().shutdownOutput();
  continue;
}
case DONE:
{
if (_header != null) {
  if (!_lastContent || _content == null || !_content.hasArray() || !_header.hasArray() || _content.array() != _header.array())   _bufferPool.release(_header);
}
return State.SUCCEEDED;
}
case CONTINUE:
{
break;
}
default :
{
throw new IllegalStateException("generateResponse=" + result);
}
}
}
}
