{
  HttpSession httpSession=request.getSession(false);
  if (_renewSession && httpSession != null && httpSession.getAttribute(SESSION_SECURED) == null) {
synchronized (this) {
      Map<String,Object> attributes=new HashMap<String,Object>();
      for (Enumeration<String> e=httpSession.getAttributeNames(); e.hasMoreElements(); ) {
        String name=e.nextElement();
        attributes.put(name,httpSession.getAttribute(name));
        httpSession.removeAttribute(name);
      }
      httpSession.invalidate();
      httpSession=request.getSession(true);
      httpSession.setAttribute(SESSION_SECURED,Boolean.TRUE);
      for (      Map.Entry<String,Object> entry : attributes.entrySet())       httpSession.setAttribute(entry.getKey(),entry.getValue());
    }
  }
  return httpSession;
}
