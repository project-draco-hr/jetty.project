{
  ByteBuffer header=BufferUtil.allocate(4096);
  ByteBuffer content0=BufferUtil.toBuffer("Hello Cruel World! ");
  ByteBuffer content1=BufferUtil.toBuffer("The quick brown fox jumped over the lazy dog. ");
  HttpFields fields=new HttpFields();
  HttpGenerator gen=new HttpGenerator();
  gen.setLargeContent(8);
  gen.setVersion(HttpVersion.HTTP_1_1);
  gen.setRequest("POST","/index.html");
  fields.add("Host","something");
  fields.add("User-Agent","test");
  HttpGenerator.Result result=gen.prepareContent(null,null,content0);
  assertEquals(HttpGenerator.Result.NEED_COMMIT,result);
  assertEquals(HttpGenerator.State.START,gen.getState());
  result=gen.commit(fields,header,null,content0,false);
  assertEquals(HttpGenerator.Result.FLUSH_CONTENT,result);
  assertEquals(HttpGenerator.State.COMMITTED,gen.getState());
  assertTrue(gen.isChunking());
  String head=BufferUtil.toString(header);
  BufferUtil.clear(header);
  String body=BufferUtil.toString(content0);
  BufferUtil.clear(content0);
  result=gen.commit(fields,header,null,content0,false);
  assertEquals(HttpGenerator.Result.OK,result);
  assertEquals(HttpGenerator.State.COMMITTED,gen.getState());
  result=gen.prepareContent(null,null,content1);
  assertEquals(HttpGenerator.Result.NEED_CHUNK,result);
  assertEquals(HttpGenerator.State.COMMITTED,gen.getState());
  ByteBuffer chunk=BufferUtil.allocate(HttpGenerator.CHUNK_SIZE);
  result=gen.prepareContent(chunk,null,content1);
  assertEquals(HttpGenerator.Result.FLUSH_CONTENT,result);
  assertEquals(HttpGenerator.State.COMMITTED,gen.getState());
  assertEquals("\r\n2E\r\n",BufferUtil.toString(chunk));
  body+=BufferUtil.toString(chunk) + BufferUtil.toString(content1);
  BufferUtil.clear(content1);
  result=gen.complete(chunk,null);
  assertEquals(HttpGenerator.Result.FLUSH,result);
  assertEquals(HttpGenerator.State.END,gen.getState());
  assertEquals("\r\n0\r\n\r\n",BufferUtil.toString(chunk));
  body+=BufferUtil.toString(chunk);
  result=gen.complete(chunk,null);
  assertEquals(HttpGenerator.Result.OK,result);
  assertEquals(HttpGenerator.State.END,gen.getState());
  assertEquals(65,gen.getContentWritten());
  assertThat(head,containsString("POST /index.html HTTP/1.1"));
  assertThat(head,containsString("Host: something"));
  assertThat(head,not(containsString("Content-Length")));
  assertThat(head,containsString("Transfer-Encoding: chunked"));
  assertTrue(head.endsWith("\r\n\r\n13\r\n"));
}
