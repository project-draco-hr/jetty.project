{
  Resource resource=Resource.newResource(app.getArchivePath().toURI());
  if (!resource.exists())   throw new IllegalStateException("App resouce does not exist " + resource);
  if (_acceptContextXmlFiles && FileID.isXmlFile(app.getArchivePath())) {
    XmlConfiguration xmlc=new XmlConfiguration(resource.getURL());
    Map props=new HashMap();
    props.put("Server",_deploymentManager.getServer());
    if (getConfigurationManager() != null)     props.putAll(getConfigurationManager().getProperties());
    xmlc.setProperties(props);
    return (ContextHandler)xmlc.configure();
  }
  String context=app.getArchivePath().getName();
  if (_acceptWarFiles && FileID.isWebArchiveFile(app.getArchivePath())) {
    context=context.substring(0,context.length() - 4);
  }
 else   if (_acceptDirectories && app.getArchivePath().isDirectory()) {
  }
 else   throw new IllegalStateException("unable to create ContextHandler for " + app);
  if (context.equalsIgnoreCase("root") || context.equalsIgnoreCase("root/"))   context=URIUtil.SLASH;
  if (context.charAt(0) != '/')   context="/" + context;
  if (context.endsWith("/") && context.length() > 0)   context=context.substring(0,context.length() - 1);
  WebAppContext wah=new WebAppContext();
  wah.setContextPath(context);
  wah.setWar(app.getArchivePath().getAbsolutePath());
  if (_defaultsDescriptor != null)   wah.setDefaultsDescriptor(_defaultsDescriptor);
  wah.setExtractWAR(_extractWars);
  wah.setParentLoaderPriority(_parentLoaderPriority);
  return wah;
}
