{
  Map<ProtectionDomain,PolicyBlock> policies=new HashMap<ProtectionDomain,PolicyBlock>();
  KeyStore keystore=null;
  try {
    PolicyFileScanner loader=new PolicyFileScanner();
    Collection<GrantEntry> grantEntries=new ArrayList<GrantEntry>();
    List<KeystoreEntry> keystoreEntries=new ArrayList<KeystoreEntry>();
    loader.scanStream(new InputStreamReader(policyStream),grantEntries,keystoreEntries);
    for (Iterator<KeystoreEntry> i=keystoreEntries.iterator(); i.hasNext(); ) {
      KeystoreEntry node=i.next();
      node.expand(context);
      keystore=node.toKeyStore();
      if (keystore != null) {
        context.setKeystore(keystore);
        break;
      }
    }
    for (Iterator<GrantEntry> i=grantEntries.iterator(); i.hasNext(); ) {
      GrantEntry grant=i.next();
      grant.expand(context);
      PolicyBlock policy=new PolicyBlock();
      policy.setCodeSource(grant.getCodeSource());
      policy.setPrincipals(grant.getPrincipals());
      policy.setPermissions(grant.getPermissions());
      policies.put(policy.toProtectionDomain(),policy);
    }
    return policies;
  }
 catch (  Exception e) {
    throw new PolicyException(e);
  }
}
