{
  Map<ProtectionDomain,PermissionCollection> pdMappings=new HashMap<ProtectionDomain,PermissionCollection>();
  KeyStore keystore=null;
  try {
    PolicyFileScanner loader=new PolicyFileScanner();
    Collection<GrantEntry> grantEntries=new ArrayList<GrantEntry>();
    List<KeystoreEntry> keystoreEntries=new ArrayList<KeystoreEntry>();
    loader.scanStream(new InputStreamReader(policyStream),grantEntries,keystoreEntries);
    for (Iterator<KeystoreEntry> i=keystoreEntries.iterator(); i.hasNext(); ) {
      keystore=resolveKeyStore(i.next(),evaluator);
      if (keystore != null) {
        break;
      }
    }
    for (Iterator<GrantEntry> i=grantEntries.iterator(); i.hasNext(); ) {
      GrantEntry grant=i.next();
      Permissions permissions=processPermissions(grant,keystore,evaluator);
      ProtectionDomain pd;
      if (grant.codebase == null) {
        pd=new ProtectionDomain(null,permissions);
      }
 else {
        Certificate[] certs=resolveToCertificates(keystore,grant.signers);
        Principal[] principals=resolvePrincipals(keystore,grant.principals);
        CodeSource codeSource=resolveToCodeSource(grant.codebase,certs,evaluator);
        pd=new ProtectionDomain(codeSource,permissions,Thread.currentThread().getContextClassLoader(),principals);
      }
      pdMappings.put(pd,null);
    }
    return pdMappings;
  }
 catch (  Exception e) {
    throw new PolicyException(e);
  }
}
