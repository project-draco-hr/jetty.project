{
  String from=request.getRemoteHost();
  String to=request.getServerName();
  String path=((HttpServletRequest)request).getServletPath();
  if (!_remote && !_allowed.contains(path) && (!from.equals("localhost") && !from.startsWith("127.") || !to.equals("localhost") && !to.startsWith("127.0.0."))) {
    if ("/".equals(path))     _context.getRequestDispatcher("/remote.html").forward(request,response);
 else     ((HttpServletResponse)response).sendRedirect("/remote.html");
    return;
  }
  Integer old_value=null;
  ServletRequest r=request;
  while (r instanceof ServletRequestWrapper)   r=((ServletRequestWrapper)r).getRequest();
  try {
    old_value=(Integer)request.getAttribute("testFilter");
    Integer value=(old_value == null) ? new Integer(1) : new Integer(old_value.intValue() + 1);
    request.setAttribute("testFilter",value);
    String qString=((HttpServletRequest)request).getQueryString();
    if (qString != null && qString.indexOf("wrap") >= 0) {
      request=new HttpServletRequestWrapper((HttpServletRequest)request);
    }
    _context.setAttribute("request" + r.hashCode(),value);
    chain.doFilter(request,response);
  }
  finally {
    request.setAttribute("testFilter",old_value);
    _context.setAttribute("request" + r.hashCode(),old_value);
  }
}
