{
  if (serverSocket == null) {
    return;
  }
  while (serverSocket != null) {
    Socket socket=null;
    try {
      socket=serverSocket.accept();
      LineNumberReader lin=new LineNumberReader(new InputStreamReader(socket.getInputStream()));
      String receivedKey=lin.readLine();
      if (!key.equals(receivedKey)) {
        System.err.println("Ignoring command with incorrect key");
        continue;
      }
      OutputStream out=socket.getOutputStream();
      String cmd=lin.readLine();
      debug("command=%s",cmd);
      if ("stop".equalsIgnoreCase(cmd)) {
        debug("Issuing stop...");
        for (        LifeCycle l : _lifeCycles) {
          try {
            if (l.isStarted() && ShutdownThread.isRegistered(l)) {
              l.stop();
            }
            if ((l instanceof Destroyable) && exitVm)             ((Destroyable)l).destroy();
          }
 catch (          Exception e) {
            debug(e);
          }
        }
        stopInput(socket);
        debug("Informing client that we are stopped.");
        informClient(out,"Stopped\r\n");
        stopOutput(socket);
        if (exitVm) {
          debug("Killing JVM");
          System.exit(0);
        }
      }
 else       if ("forcestop".equalsIgnoreCase(cmd)) {
        debug("Issuing force stop...");
        stopLifeCycles(exitVm);
        stopInput(socket);
        debug("Informing client that we are stopped.");
        informClient(out,"Stopped\r\n");
        stopOutput(socket);
        if (exitVm) {
          debug("Killing JVM");
          System.exit(0);
        }
      }
 else       if ("stopexit".equalsIgnoreCase(cmd)) {
        debug("Issuing stop and exit...");
        stopLifeCycles(true);
        stopInput(socket);
        debug("Informing client that we are stopped.");
        informClient(out,"Stopped\r\n");
        stopOutput(socket);
        debug("Killing JVM");
        System.exit(0);
      }
 else       if ("exit".equalsIgnoreCase(cmd)) {
        debug("Killing JVM");
        System.exit(0);
      }
 else       if ("status".equalsIgnoreCase(cmd)) {
        informClient(out,"OK\r\n");
      }
    }
 catch (    Exception e) {
      debug(e);
      System.err.println(e.toString());
    }
 finally {
      close(socket);
      socket=null;
    }
  }
}
