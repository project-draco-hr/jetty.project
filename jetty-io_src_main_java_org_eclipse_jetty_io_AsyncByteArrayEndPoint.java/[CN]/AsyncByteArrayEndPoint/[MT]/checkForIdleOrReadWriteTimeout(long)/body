{
  if (_idlecheck || !_readFuture.isComplete() || !_writeFuture.isComplete()) {
    long idleTimestamp=getIdleTimestamp();
    long max_idle_time=getMaxIdleTime();
    if (idleTimestamp != 0 && max_idle_time > 0) {
      long idleForMs=now - idleTimestamp;
      if (idleForMs > max_idle_time) {
        _lock.lock();
        try {
          if (_idlecheck)           _connection.onIdleExpired(idleForMs);
          if (!_readFuture.isComplete())           _readFuture.fail(new TimeoutException());
          if (!_writeFuture.isComplete())           _writeFuture.fail(new TimeoutException());
        }
  finally {
          notIdle();
          _lock.unlock();
        }
      }
    }
  }
}
