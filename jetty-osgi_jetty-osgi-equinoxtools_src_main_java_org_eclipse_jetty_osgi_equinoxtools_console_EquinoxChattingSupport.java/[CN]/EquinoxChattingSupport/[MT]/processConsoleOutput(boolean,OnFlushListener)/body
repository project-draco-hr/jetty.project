{
  Queue<String> result=new LinkedList<String>();
  String toDisplay=_consoleSession.getOutputAsWriter().getBuffer().toString();
  boolean clearConsole=_consoleSession.getOnFlushListeners().indexOf(onflush) == _consoleSession.getOnFlushListeners().size();
  if (clearConsole) {
    _consoleSession.clearOutput();
  }
  boolean lastLineIsComplete=toDisplay.endsWith("\n") || toDisplay.endsWith("\r");
  String[] lines=toDisplay.split("\n");
  String lastLine=lastLineIsComplete ? null : lines[lines.length - 1];
  if (clearConsole) {
    _consoleSession.getOutputAsWriter().append(lastLine);
  }
  for (int lnNb=0; lnNb < (lastLineIsComplete ? lines.length : lines.length - 1); lnNb++) {
    String line=lines[lnNb];
    while (line.trim().startsWith("null")) {
      line=line.trim().substring("null".length()).trim();
    }
    if (line.startsWith("osgi>")) {
      result.add("osgi>");
      result.add(escape ? jsonEscapeString(line.substring("osgi>".length())) : line.substring("osgi>".length()));
    }
 else {
      result.add("&#10;");
      result.add(escape ? jsonEscapeString(line) : line);
    }
  }
  return result;
}
