{
  final SSLSocket client=newClient();
  final CountDownLatch latch=new CountDownLatch(1);
  SimpleProxy.AutomaticFlow automaticProxyFlow=proxy.startAutomaticFlow();
  client.startHandshake();
  Assert.assertTrue(automaticProxyFlow.stop(5,TimeUnit.SECONDS));
  Assert.assertTrue(latch.await(idleTimeout * 2,TimeUnit.MILLISECONDS));
  TLSRecord record=proxy.readFromServer();
  Assert.assertNotNull(record);
  Assert.assertEquals(TLSRecord.Type.ALERT,record.getType());
  record=proxy.readFromClient();
  Assert.assertEquals(TLSRecord.Type.APPLICATION,record.getType());
  proxy.flushToServer(record,0);
  TimeUnit.MILLISECONDS.sleep(500);
  Assert.assertThat(sslHandles.get(),Matchers.lessThan(20));
  Assert.assertThat(sslFlushes.get(),Matchers.lessThan(20));
  Assert.assertThat(httpParses.get(),Matchers.lessThan(50));
  Assert.assertThat(((Dumpable)server.getConnectors()[0]).dump(),Matchers.containsString("SCEP@"));
  completeClose(client);
  TimeUnit.MILLISECONDS.sleep(200);
  Assert.assertThat(((Dumpable)server.getConnectors()[0]).dump(),Matchers.not(Matchers.containsString("SCEP@")));
}
