{
  _handled=false;
  boolean original_set=_originalPathAttribute == null;
  for (  Rule rule : _rules) {
    String applied=rule.matchAndApply(target,request,response);
    if (applied != null) {
      Log.debug("applied {}",rule);
      if (!target.equals(applied)) {
        Log.debug("rewrote {} to {}",target,applied);
        if (!original_set) {
          original_set=true;
          request.setAttribute(_originalPathAttribute,target);
        }
        if (_rewriteRequestURI)         ((Request)request).setRequestURI(applied);
        if (_rewritePathInfo)         ((Request)request).setPathInfo(applied);
        target=applied;
      }
      if (rule.isHandling()) {
        Log.debug("handling {}",rule);
        _handled=true;
        (request instanceof Request ? (Request)request : HttpConnection.getCurrentConnection().getRequest()).setHandled(true);
      }
      if (rule.isTerminating()) {
        Log.debug("terminating {}",rule);
        break;
      }
    }
  }
  return target;
}
