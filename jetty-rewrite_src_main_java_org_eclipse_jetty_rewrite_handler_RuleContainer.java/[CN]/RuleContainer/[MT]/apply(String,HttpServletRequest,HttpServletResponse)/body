{
  boolean original_set=_originalPathAttribute == null;
  for (  Rule rule : _rules) {
    String applied=rule.matchAndApply(target,request,response);
    if (applied != null) {
      LOG.debug("applied {}",rule);
      if (!target.equals(applied)) {
        LOG.debug("rewrote {} to {}",target,applied);
        if (!original_set) {
          original_set=true;
          request.setAttribute(_originalPathAttribute,target);
        }
        if (_rewriteRequestURI) {
          if (rule instanceof Rule.ApplyURI && !target.equals(request.getRequestURI()))           ((Rule.ApplyURI)rule).applyURI((Request)request,target,applied);
 else           ((Request)request).setRequestURI(applied);
        }
        if (_rewritePathInfo)         ((Request)request).setPathInfo(applied);
        target=applied;
      }
      if (rule.isHandling()) {
        LOG.debug("handling {}",rule);
        (request instanceof Request ? (Request)request : HttpConnection.getCurrentConnection().getRequest()).setHandled(true);
      }
      if (rule.isTerminating()) {
        LOG.debug("terminating {}",rule);
        break;
      }
    }
  }
  return target;
}
