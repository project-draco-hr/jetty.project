{
  try {
    connection.getIOState().assertOutputOpen();
    OutgoingFrames.FlushMode flushMode=OutgoingFrames.FlushMode.FLUSH;
    WebSocketSession session=connection.getSession();
    if (session != null && session.isBatching())     flushMode=OutgoingFrames.FlushMode.AUTO;
    outgoing.outgoingFrame(frame,callback,flushMode);
  }
 catch (  IOException e) {
    callback.writeFailed(e);
  }
}
