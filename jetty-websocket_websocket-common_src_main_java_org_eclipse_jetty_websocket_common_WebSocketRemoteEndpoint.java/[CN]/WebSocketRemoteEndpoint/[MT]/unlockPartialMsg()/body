{
  MsgType was=msgType.get();
switch (was) {
case NONE:
    throw new IllegalStateException("not locked");
case PARTIAL_BINARY:
case PARTIAL_TEXT:
  throw new IllegalStateException("in partial");
case BINARY:
if (!msgType.compareAndSet(was,MsgType.PARTIAL_BINARY)) throw new IllegalStateException("concurrent unlock");
return;
case TEXT:
if (!msgType.compareAndSet(was,MsgType.PARTIAL_TEXT)) throw new IllegalStateException("concurrent unlock");
return;
}
}
