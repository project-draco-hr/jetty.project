{
  MsgType was=msgType.get();
switch (was) {
case NONE:
    throw new IllegalStateException("not locked");
case PARTIAL_BINARY:
case PARTIAL_TEXT:
  throw new IllegalStateException("in partial");
default :
if (!msgType.compareAndSet(was,MsgType.NONE)) throw new IllegalStateException("concurrent unlock");
}
}
