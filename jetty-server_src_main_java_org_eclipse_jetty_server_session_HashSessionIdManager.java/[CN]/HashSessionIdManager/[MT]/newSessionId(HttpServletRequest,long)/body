{
synchronized (this) {
    String requested_id=request.getRequestedSessionId();
    if (requested_id != null) {
      String cluster_id=getClusterId(requested_id);
      if (idInUse(cluster_id))       return cluster_id;
    }
    String new_id=(String)request.getAttribute(__NEW_SESSION_ID);
    if (new_id != null && idInUse(new_id))     return new_id;
    String id=null;
    while (id == null || id.length() == 0 || idInUse(id)) {
      long r=_weakRandom ? (hashCode() ^ Runtime.getRuntime().freeMemory() ^ _random.nextInt()^ (((long)request.hashCode()) << 32)) : _random.nextLong();
      r^=created;
      if (request.getRemoteAddr() != null)       r^=request.getRemoteAddr().hashCode();
      if (r < 0)       r=-r;
      id=Long.toString(r,36);
    }
    request.setAttribute(__NEW_SESSION_ID,id);
    return id;
  }
}
