{
  ByteArrayEndPoint endPoint=new ByteArrayEndPoint(requestsBuffer.asArray(),1024){
    @Override public void setConnection(    Connection connection){
      connectionUpgraded(getConnection(),connection);
      super.setConnection(connection);
    }
  }
;
  endPoint.setGrowOutput(true);
  HttpConnection connection=new HttpConnection(LocalConnector.this,endPoint,getServer());
  endPoint.setConnection(connection);
  connectionOpened(connection);
  boolean leaveOpen=keepOpen;
  try {
    while (endPoint.getIn().length() > 0) {
      while (true) {
        try {
          endPoint.getConnection().handle();
          break;
        }
 catch (        UpgradeConnectionException e) {
          Log.debug(e.toString());
          Log.ignore(e);
          endPoint.setConnection(e.getConnection());
        }
      }
    }
  }
 catch (  Exception x) {
    leaveOpen=false;
  }
 finally {
    if (!leaveOpen)     connectionClosed(connection);
    responsesBuffer=endPoint.getOut();
    if (latch != null)     latch.countDown();
  }
}
