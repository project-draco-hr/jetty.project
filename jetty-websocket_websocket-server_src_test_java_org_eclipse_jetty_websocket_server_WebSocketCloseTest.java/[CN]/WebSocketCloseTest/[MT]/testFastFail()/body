{
  BlockheadClient client=new BlockheadClient(server.getServerUri());
  client.setProtocols("fastfail");
  client.setTimeout(TimeUnit.SECONDS,1);
  try {
    try (StacklessLogging scope=new StacklessLogging(EventDriver.class)){
      client.connect();
      client.sendStandardRequest();
      client.expectUpgradeResponse();
      IncomingFramesCapture capture=client.readFrames(1,TimeUnit.SECONDS,1);
      WebSocketFrame frame=capture.getFrames().poll();
      Assert.assertThat("frames[0].opcode",frame.getOpCode(),is(OpCode.CLOSE));
      CloseInfo close=new CloseInfo(frame);
      Assert.assertThat("Close Status Code",close.getStatusCode(),is(StatusCode.SERVER_ERROR));
      client.write(close.asFrame());
      Assert.assertThat("Fast Fail Latch",closeSocket.closeLatch.await(1,TimeUnit.SECONDS),is(true));
      Assert.assertThat("Fast Fail.statusCode",closeSocket.closeStatusCode,is(StatusCode.SERVER_ERROR));
      Assert.assertThat("Fast Fail.errors",closeSocket.errors.size(),is(1));
    }
   }
  finally {
    client.close();
  }
}
