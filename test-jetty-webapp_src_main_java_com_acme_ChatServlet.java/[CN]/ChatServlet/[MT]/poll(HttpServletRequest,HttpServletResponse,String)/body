{
  Map<String,Member> room=_rooms.get(request.getPathInfo());
  if (room == null) {
    response.sendError(503);
    return;
  }
  final Member member=room.get(username);
  if (member == null) {
    response.sendError(503);
    return;
  }
synchronized (member) {
    if (member._queue.size() > 0) {
      response.setContentType("text/json;charset=utf-8");
      StringBuilder buf=new StringBuilder();
      buf.append("{\"action\":\"poll\",");
      buf.append("\"from\":\"");
      buf.append(member._queue.poll());
      buf.append("\",");
      String message=member._queue.poll();
      int quote=message.indexOf('"');
      while (quote >= 0) {
        message=message.substring(0,quote) + '\\' + message.substring(quote);
        quote=message.indexOf('"',quote + 2);
      }
      buf.append("\"chat\":\"");
      buf.append(message);
      buf.append("\"}");
      byte[] bytes=buf.toString().getBytes("utf-8");
      response.setContentLength(bytes.length);
      response.getOutputStream().write(bytes);
    }
 else     if (request.getDispatcherType() == DispatcherType.ASYNC) {
      response.setContentType("text/json;charset=utf-8");
      PrintWriter out=response.getWriter();
      out.print("{action:\"poll\"}");
    }
 else {
      AsyncContext async=request.startAsync();
      async.setTimeout(20000);
      async.addListener(new AsyncListener(){
        @Override public void onTimeout(        AsyncEvent event) throws IOException {
        }
        @Override public void onStartAsync(        AsyncEvent event) throws IOException {
          AsyncContext async=member._async.get();
          if (member._async.compareAndSet(async,null)) {
            HttpServletResponse response=(HttpServletResponse)async.getResponse();
            response.setContentType("text/json;charset=utf-8");
            PrintWriter out=response.getWriter();
            out.print("{action:\"poll\"}");
          }
        }
        @Override public void onError(        AsyncEvent event) throws IOException {
        }
        @Override public void onComplete(        AsyncEvent event) throws IOException {
        }
      }
);
      member._async.compareAndSet(null,async);
    }
  }
}
