{
  startSSLServer(new ServerHandler());
  startProxy(connectHandler);
  HttpClient httpClient=new HttpClient(sslContextFactory);
  httpClient.getProxyConfiguration().getProxies().add(new HttpProxy("localhost",proxyPort()));
  httpClient.getAuthenticationStore().addAuthentication(new BasicAuthentication(URI.create("http://localhost:" + proxyPort()),realm,"proxyUser","proxyPassword"));
  httpClient.start();
  try {
    String host="localhost";
    String body="BODY";
    ContentResponse response=httpClient.newRequest(host,serverConnector.getLocalPort()).scheme(HttpScheme.HTTPS.asString()).method(HttpMethod.GET).path("/echo?body=" + URLEncoder.encode(body,"UTF-8")).send();
    Assert.assertEquals(HttpStatus.OK_200,response.getStatus());
    String content=response.getContentAsString();
    Assert.assertEquals(body,content);
  }
  finally {
    httpClient.stop();
  }
}
