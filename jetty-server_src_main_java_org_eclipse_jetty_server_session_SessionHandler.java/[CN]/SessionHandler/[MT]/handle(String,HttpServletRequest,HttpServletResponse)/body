{
  setRequestedId(request);
  Request base_request=(request instanceof Request) ? (Request)request : HttpConnection.getCurrentConnection().getRequest();
  SessionManager old_session_manager=null;
  HttpSession old_session=null;
  try {
    old_session_manager=base_request.getSessionManager();
    old_session=base_request.getSession(false);
    if (old_session_manager != _sessionManager) {
      base_request.setSessionManager(_sessionManager);
      base_request.setSession(null);
    }
    HttpSession session=null;
    if (_sessionManager != null) {
      session=base_request.getSession(false);
      if (session != null) {
        if (session != old_session) {
          HttpCookie cookie=_sessionManager.access(session,request.isSecure());
          if (cookie != null)           base_request.getResponse().addCookie(cookie);
        }
      }
 else {
        session=base_request.recoverNewSession(_sessionManager);
        if (session != null)         base_request.setSession(session);
      }
    }
    if (Log.isDebugEnabled()) {
      Log.debug("sessionManager=" + _sessionManager);
      Log.debug("session=" + session);
    }
    getHandler().handle(target,request,response);
  }
 catch (  RetryRequest r) {
    HttpSession session=base_request.getSession(false);
    if (session != null && session.isNew())     base_request.saveNewSession(_sessionManager,session);
    throw r;
  }
 finally {
    HttpSession session=request.getSession(false);
    if (old_session_manager != _sessionManager) {
      if (session != null)       _sessionManager.complete(session);
      base_request.setSessionManager(old_session_manager);
      base_request.setSession(old_session);
    }
  }
}
