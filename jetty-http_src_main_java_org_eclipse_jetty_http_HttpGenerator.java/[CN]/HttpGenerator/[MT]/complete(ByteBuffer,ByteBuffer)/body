{
  if (_state == State.END)   return Result.OK;
switch (_state) {
case START:
case COMPLETING_UNCOMMITTED:
    _state=State.COMPLETING_UNCOMMITTED;
  return Result.NEED_COMMIT;
case COMPLETING:
case COMMITTED:
_state=State.COMPLETING;
if (isChunking()) {
if (BufferUtil.hasContent(buffer)) {
  if (chunk == null)   return Result.NEED_CHUNK;
  BufferUtil.clearToFill(chunk);
  prepareChunk(chunk,buffer.remaining());
  BufferUtil.flipToFlush(chunk,0);
  return Result.FLUSH;
}
_state=State.END;
BufferUtil.clearToFill(chunk);
prepareChunk(chunk,0);
BufferUtil.flipToFlush(chunk,0);
return Result.FLUSH;
}
 else if (BufferUtil.hasContent(buffer)) return Result.FLUSH;
}
_state=State.END;
return Result.OK;
}
