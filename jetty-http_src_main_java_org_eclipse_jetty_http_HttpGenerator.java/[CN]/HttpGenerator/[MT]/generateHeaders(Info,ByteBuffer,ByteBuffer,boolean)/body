{
  final RequestInfo _request=(_info instanceof RequestInfo) ? (RequestInfo)_info : null;
  final ResponseInfo _response=(_info instanceof ResponseInfo) ? (ResponseInfo)_info : null;
  boolean has_server=false;
  HttpField transfer_encoding=null;
  boolean keep_alive=false;
  boolean close=false;
  boolean content_type=false;
  StringBuilder connection=null;
  if (_info.getHttpFields() != null) {
    for (    HttpField field : _info.getHttpFields()) {
      HttpHeader h=field.getHeader();
switch (h == null ? HttpHeader.UNKNOWN : h) {
case CONTENT_LENGTH:
        if (_info.getContentLength() >= 0)         _endOfContent=EndOfContent.CONTENT_LENGTH;
      break;
case CONTENT_TYPE:
{
      if (field.getValue().startsWith(MimeTypes.Type.MULTIPART_BYTERANGES.toString()))       _endOfContent=EndOfContent.SELF_DEFINING_CONTENT;
      content_type=true;
      field.putTo(header);
      break;
    }
case TRANSFER_ENCODING:
{
    if (_info.getHttpVersion() == HttpVersion.HTTP_1_1)     transfer_encoding=field;
    break;
  }
case CONNECTION:
{
  if (_request != null)   field.putTo(header);
  HttpHeaderValue[] values=new HttpHeaderValue[]{HttpHeaderValue.CACHE.get(field.getValue())};
  String[] split=null;
  if (values[0] == null) {
    split=field.getValue().split("\\s*,\\s*");
    if (split.length > 0) {
      values=new HttpHeaderValue[split.length];
      for (int i=0; i < split.length; i++)       values[i]=HttpHeaderValue.CACHE.get(split[i]);
    }
  }
  for (int i=0; i < values.length; i++) {
    HttpHeaderValue value=values[i];
switch (value == null ? HttpHeaderValue.UNKNOWN : value) {
case UPGRADE:
{
        header.put(HttpHeader.CONNECTION.getBytesColonSpace()).put(HttpHeader.UPGRADE.getBytes());
        header.put(CRLF);
        break;
      }
case CLOSE:
{
      close=true;
      if (_response != null) {
        _persistent=false;
        if (_endOfContent == EndOfContent.UNKNOWN_CONTENT)         _endOfContent=EndOfContent.EOF_CONTENT;
      }
      break;
    }
case KEEP_ALIVE:
{
    if (_info.getHttpVersion() == HttpVersion.HTTP_1_0) {
      keep_alive=true;
      if (_response != null)       _persistent=true;
    }
    break;
  }
default :
{
  if (connection == null)   connection=new StringBuilder();
 else   connection.append(',');
  connection.append(split == null ? field.getValue() : split[i]);
}
}
}
break;
}
case SERVER:
{
if (getSendServerVersion()) {
has_server=true;
field.putTo(header);
}
break;
}
default :
if (h == null) field.putTo(header);
 else {
header.put(h.getBytesColonSpace());
field.putValueTo(header);
header.put(CRLF);
}
}
}
}
int status=_response != null ? _response.getStatus() : -1;
switch (_endOfContent) {
case UNKNOWN_CONTENT:
if (_contentPrepared == 0 && _response != null && (status < 200 || status == 204 || status == 304)) _endOfContent=EndOfContent.NO_CONTENT;
 else if (_info.getContentLength() > 0) {
_endOfContent=EndOfContent.CONTENT_LENGTH;
long content_length=_info.getContentLength();
if ((_response != null || content_length > 0 || content_type) && !_noContent) {
header.put(HttpHeader.CONTENT_LENGTH.getBytesColonSpace());
BufferUtil.putDecLong(header,content_length);
header.put(HttpTokens.CRLF);
}
}
 else if (last) {
_endOfContent=EndOfContent.CONTENT_LENGTH;
long content_length=_contentPrepared + BufferUtil.length(content);
if ((_response != null || content_length > 0 || content_type) && !_noContent) {
header.put(HttpHeader.CONTENT_LENGTH.getBytesColonSpace());
BufferUtil.putDecLong(header,content_length);
header.put(HttpTokens.CRLF);
}
}
 else {
_endOfContent=(!isPersistent() || _info.getHttpVersion().ordinal() < HttpVersion.HTTP_1_1.ordinal()) ? EndOfContent.EOF_CONTENT : EndOfContent.CHUNKED_CONTENT;
if (_response != null && _endOfContent == EndOfContent.EOF_CONTENT) {
_endOfContent=EndOfContent.NO_CONTENT;
_noContent=true;
}
}
break;
case CONTENT_LENGTH:
long content_length=_info.getContentLength();
if ((_response != null || content_length > 0 || content_type) && !_noContent) {
header.put(HttpHeader.CONTENT_LENGTH.getBytesColonSpace());
BufferUtil.putDecLong(header,content_length);
header.put(HttpTokens.CRLF);
}
break;
case NO_CONTENT:
if (_response != null && status >= 200 && status != 204 && status != 304) header.put(CONTENT_LENGTH_0);
break;
case EOF_CONTENT:
_persistent=_request != null;
break;
case CHUNKED_CONTENT:
break;
default :
break;
}
if (isChunking()) {
if (transfer_encoding != null && !HttpHeaderValue.CHUNKED.toString().equalsIgnoreCase(transfer_encoding.getValue())) {
String c=transfer_encoding.getValue();
if (c.endsWith(HttpHeaderValue.CHUNKED.toString())) transfer_encoding.putTo(header);
 else throw new IllegalArgumentException("BAD TE");
}
 else header.put(TRANSFER_ENCODING_CHUNKED);
}
if (_endOfContent == EndOfContent.EOF_CONTENT) {
keep_alive=false;
_persistent=false;
}
if (_response != null) {
if (!isPersistent() && (close || _info.getHttpVersion().ordinal() > HttpVersion.HTTP_1_0.ordinal())) {
if (connection == null) header.put(CONNECTION_CLOSE);
 else {
header.put(CONNECTION_CLOSE,0,CONNECTION_CLOSE.length - 2);
header.put((byte)',');
header.put(StringUtil.getBytes(connection.toString()));
header.put(CRLF);
}
}
 else if (keep_alive) {
if (connection == null) header.put(CONNECTION_KEEP_ALIVE);
 else {
header.put(CONNECTION_KEEP_ALIVE,0,CONNECTION_CLOSE.length - 2);
header.put((byte)',');
header.put(StringUtil.getBytes(connection.toString()));
header.put(CRLF);
}
}
 else if (connection != null) {
header.put(CONNECTION_);
header.put(StringUtil.getBytes(connection.toString()));
header.put(CRLF);
}
}
if (!has_server && status > 199 && getSendServerVersion()) header.put(SERVER);
header.put(HttpTokens.CRLF);
}
