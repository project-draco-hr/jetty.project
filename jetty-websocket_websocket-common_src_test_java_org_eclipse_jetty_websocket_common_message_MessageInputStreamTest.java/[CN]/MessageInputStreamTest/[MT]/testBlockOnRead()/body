{
  LocalWebSocketConnection conn=new LocalWebSocketConnection(testname);
  try (MessageInputStream stream=new MessageInputStream(conn)){
    final AtomicBoolean hadError=new AtomicBoolean(false);
    new Thread(new Runnable(){
      @Override public void run(){
        try {
          boolean fin=false;
          TimeUnit.MILLISECONDS.sleep(200);
          stream.appendMessage(BufferUtil.toBuffer("Saved",UTF8),fin);
          TimeUnit.MILLISECONDS.sleep(200);
          stream.appendMessage(BufferUtil.toBuffer(" by ",UTF8),fin);
          fin=true;
          TimeUnit.MILLISECONDS.sleep(200);
          stream.appendMessage(BufferUtil.toBuffer("Zero",UTF8),fin);
        }
 catch (        IOException|InterruptedException e) {
          hadError.set(true);
          e.printStackTrace(System.err);
        }
      }
    }
).start();
    byte buf[]=new byte[32];
    int len=stream.read(buf);
    String message=new String(buf,0,len,UTF8);
    Assert.assertThat("Error when appending",hadError.get(),is(false));
    Assert.assertThat("Message",message,is("Saved by Zero"));
  }
 }
