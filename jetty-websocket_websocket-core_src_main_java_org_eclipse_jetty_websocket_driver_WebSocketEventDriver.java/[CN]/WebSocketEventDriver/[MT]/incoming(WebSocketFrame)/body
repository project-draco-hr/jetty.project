{
  if (LOG.isDebugEnabled()) {
    LOG.debug("{}.onFrame({})",websocket.getClass().getSimpleName(),frame);
  }
  if ((frame instanceof Frame) && (events.onFrame != null)) {
    events.onFrame.call(websocket,session,frame);
  }
  try {
switch (frame.getOpCode()) {
case OpCode.CLOSE:
{
        boolean validate=true;
        CloseInfo close=new CloseInfo(frame,validate);
        if (events.onClose != null) {
          events.onClose.call(websocket,session,close.getStatusCode(),close.getReason());
        }
        throw new CloseException(close.getStatusCode(),close.getReason());
      }
case OpCode.PING:
{
      WebSocketFrame pong=new WebSocketFrame(OpCode.PONG);
      if (frame.getPayloadLength() > 0) {
        ByteBuffer pongBuf=ByteBuffer.allocate(frame.getPayloadLength());
        BufferUtil.clearToFill(pongBuf);
        BufferUtil.put(frame.getPayload(),pongBuf);
        BufferUtil.flipToFlush(pongBuf,0);
        pong.setPayload(pongBuf);
        if (LOG.isDebugEnabled()) {
          LOG.debug("Pong with {}",BufferUtil.toDetailString(pongBuf));
        }
      }
      session.output("pong",new FutureCallback<String>(),pong);
      break;
    }
case OpCode.BINARY:
{
    if (events.onBinary == null) {
      return;
    }
    if (activeMessage == null) {
      if (events.onBinary.isStreaming()) {
        activeMessage=new MessageInputStream(websocket,events.onBinary,session,bufferPool,policy);
      }
 else {
        activeMessage=new SimpleBinaryMessage(websocket,events.onBinary,session,bufferPool,policy);
      }
    }
    activeMessage.appendMessage(frame.getPayload());
    if (frame.isFin()) {
      activeMessage.messageComplete();
      activeMessage=null;
    }
    return;
  }
case OpCode.TEXT:
{
  if (events.onText == null) {
    return;
  }
  if (activeMessage == null) {
    if (events.onText.isStreaming()) {
      ByteBuffer buf=ByteBuffer.allocate(policy.getBufferSize());
      this.activeMessage=new MessageReader(buf);
    }
 else {
      activeMessage=new SimpleTextMessage(websocket,events.onText,session,policy);
    }
  }
  activeMessage.appendMessage(frame.getPayload());
  if (frame.isFin()) {
    activeMessage.messageComplete();
    activeMessage=null;
  }
  return;
}
}
}
 catch (NotUtf8Exception e) {
terminateConnection(StatusCode.BAD_PAYLOAD,e.getMessage());
}
catch (CloseException e) {
terminateConnection(e.getStatusCode(),e.getMessage());
}
catch (Throwable t) {
unhandled(t);
}
}
