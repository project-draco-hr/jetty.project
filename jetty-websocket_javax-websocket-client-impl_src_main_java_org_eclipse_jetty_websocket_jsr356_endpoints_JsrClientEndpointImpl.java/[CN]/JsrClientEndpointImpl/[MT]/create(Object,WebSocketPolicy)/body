{
  Object endpoint=websocket;
  if (websocket instanceof ConfiguredEndpoint) {
    ConfiguredEndpoint ce=(ConfiguredEndpoint)websocket;
    endpoint=ce.getEndpoint();
    if (ce.getConfig() != null) {
      throw new IllegalStateException("Cannot create @ClientEndpoint websocket with an external EndpointConfig");
    }
  }
  Class<?> endpointClass=endpoint.getClass();
  JsrClientMetadata basemetadata=cache.get(endpointClass);
  if (basemetadata == null) {
    basemetadata=new JsrClientMetadata(container,endpointClass);
    AnnotatedEndpointScanner scanner=new AnnotatedEndpointScanner(basemetadata);
    scanner.scan();
    cache.put(endpointClass,basemetadata);
  }
  JsrEvents events=new JsrEvents(basemetadata);
  ClientEndpointConfig config=basemetadata.getEndpointConfigCopy();
  return new JsrClientAnnotatedEventDriver(container,policy,endpoint,events,config);
}
