{
  ClassLoader currentClassLoader=Thread.currentThread().getContextClassLoader();
  List<URL> webAppUrls=setUpWebAppClassPath();
  String sysClassPath=setUpSysClassPath();
  List<URL> tldJarUrls=getSystemJarsWithTlds();
  for (  URL u : tldJarUrls) {
    if (getLog().isDebugEnabled())     getLog().debug(" sys jar with tlds: " + u);
    webAppUrls.add(u);
  }
  URLClassLoader webAppClassLoader=new URLClassLoader((URL[])webAppUrls.toArray(new URL[0]),currentClassLoader);
  StringBuffer webAppClassPath=new StringBuffer();
  for (int i=0; i < webAppUrls.size(); i++) {
    if (getLog().isDebugEnabled())     getLog().debug("webappclassloader contains: " + webAppUrls.get(i));
    webAppClassPath.append(new File(webAppUrls.get(i).toURI()).getCanonicalPath());
    if (getLog().isDebugEnabled())     getLog().debug("added to classpath: " + ((URL)webAppUrls.get(i)).getFile());
    if (i + 1 < webAppUrls.size())     webAppClassPath.append(System.getProperty("path.separator"));
  }
  URLClassLoader fakeWebAppClassLoader=new URLClassLoader(new URL[0],webAppClassLoader);
  Thread.currentThread().setContextClassLoader(fakeWebAppClassLoader);
  if (jspc == null)   jspc=new JettyJspC();
  jspc.setWebXmlFragment(webXmlFragment);
  jspc.setUriroot(webAppSourceDirectory);
  jspc.setOutputDir(generatedClasses);
  jspc.setClassPath(sysClassPath + System.getProperty("path.separator") + webAppClassPath.toString());
  jspc.setClassLoader(fakeWebAppClassLoader);
  jspc.setCompile(true);
  String jspFiles=getJspFiles(webAppSourceDirectory);
  getLog().info("Compiling " + jspFiles);
  getLog().info("Includes=" + includes);
  getLog().info("Excludes=" + excludes);
  jspc.setJspFiles(jspFiles);
  getLog().info("Files selected to precompile: " + jspFiles);
  jspc.execute();
  Thread.currentThread().setContextClassLoader(currentClassLoader);
}
