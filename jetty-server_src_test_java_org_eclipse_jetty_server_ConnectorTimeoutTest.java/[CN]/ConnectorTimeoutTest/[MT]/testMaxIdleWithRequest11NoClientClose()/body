{
  configureServer(new EchoHandler());
  Socket client=newSocket(HOST,_connector.getLocalPort());
  client.setSoTimeout(10000);
  assertFalse(client.isClosed());
  OutputStream os=client.getOutputStream();
  InputStream is=client.getInputStream();
  String content="Wibble";
  byte[] contentB=content.getBytes("utf-8");
  os.write(("POST /echo HTTP/1.1\r\n" + "host: " + HOST + ":"+ _connector.getLocalPort()+ "\r\n"+ "content-type: text/plain; charset=utf-8\r\n"+ "content-length: "+ contentB.length+ "\r\n"+ "connection: close\r\n"+ "\r\n").getBytes("utf-8"));
  os.write(contentB);
  os.flush();
  IO.toString(is);
  assertEquals(-1,is.read());
  TimeUnit.MILLISECONDS.sleep(MAX_IDLE_TIME);
  try {
    for (int i=0; i < 100; i++) {
      os.write(("GET / HTTP/1.0\r\n" + "host: " + HOST + ":"+ _connector.getLocalPort()+ "\r\n"+ "connection: keep-alive\r\n"+ "\r\n").getBytes("utf-8"));
      os.flush();
    }
    Assert.fail("half close should have timed out");
  }
 catch (  SocketException e) {
  }
}
