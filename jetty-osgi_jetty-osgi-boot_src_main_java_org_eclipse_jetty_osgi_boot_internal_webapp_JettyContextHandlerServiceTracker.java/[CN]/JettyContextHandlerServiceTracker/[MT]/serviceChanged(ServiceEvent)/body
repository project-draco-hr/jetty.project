{
  ServiceReference sr=ev.getServiceReference();
switch (ev.getType()) {
case ServiceEvent.MODIFIED:
case ServiceEvent.UNREGISTERING:
{
      BundleContext context=FrameworkUtil.getBundle(JettyBootstrapActivator.class).getBundleContext();
      ContextHandler contextHandler=(ContextHandler)context.getService(sr);
      String watermark=(String)sr.getProperty(OSGiWebappConstants.WATERMARK);
      if (watermark != null && !"".equals(watermark)) {
        String serverName=(String)sr.getProperty(OSGiServerConstants.MANAGED_JETTY_SERVER_NAME);
        Map<ServiceReference,ServiceProvider> candidates=getDeployers(serverName);
        if (candidates != null) {
          boolean removed=false;
          Iterator<Entry<ServiceReference,ServiceProvider>> itor=candidates.entrySet().iterator();
          while (!removed && itor.hasNext()) {
            Entry<ServiceReference,ServiceProvider> e=itor.next();
            try {
              removed=e.getValue().serviceRemoved(sr,contextHandler);
            }
 catch (            Exception x) {
              LOG.warn("Error undeploying service representing jetty context ",x);
            }
          }
        }
      }
    }
  if (ev.getType() == ServiceEvent.UNREGISTERING) {
    break;
  }
 else {
  }
case ServiceEvent.REGISTERED:
{
  Bundle contributor=sr.getBundle();
  BundleContext context=FrameworkUtil.getBundle(JettyBootstrapActivator.class).getBundleContext();
  ContextHandler contextHandler=(ContextHandler)context.getService(sr);
  if (contextHandler.getServer() != null) {
    return;
  }
  String watermark=(String)sr.getProperty(OSGiWebappConstants.WATERMARK);
  if (watermark != null && !"".equals(watermark))   return;
  String serverName=(String)sr.getProperty(OSGiServerConstants.MANAGED_JETTY_SERVER_NAME);
  Map<ServiceReference,ServiceProvider> candidates=getDeployers(serverName);
  if (candidates != null) {
    boolean added=false;
    Iterator<Entry<ServiceReference,ServiceProvider>> itor=candidates.entrySet().iterator();
    while (!added && itor.hasNext()) {
      Entry<ServiceReference,ServiceProvider> e=itor.next();
      try {
        added=e.getValue().serviceAdded(sr,contextHandler);
        if (added && LOG.isDebugEnabled())         LOG.debug("Provider " + e.getValue() + " deployed "+ contextHandler);
      }
 catch (      Exception x) {
        LOG.warn("Error deploying service representing jetty context",x);
      }
    }
  }
  break;
}
}
}
