{
  String key=request.getHeader("Sec-WebSocket-Key");
  if (key == null) {
    throw new IllegalStateException("Missing request header 'Sec-WebSocket-Key'");
  }
  response.setHeader("Upgrade","WebSocket");
  response.addHeader("Connection","Upgrade");
  response.addHeader("Sec-WebSocket-Accept",AcceptHash.hashKey(key));
  if (response.getAcceptedSubProtocol() != null) {
    response.addHeader("Sec-WebSocket-Protocol",response.getAcceptedSubProtocol());
  }
  if (response.getExtensions() != null) {
    response.setExtensions(response.getExtensions());
    for (    ExtensionConfig ext : response.getExtensions()) {
      response.addHeader("Sec-WebSocket-Extensions",ext.getParameterizedName());
    }
  }
  response.setStatus(HttpServletResponse.SC_SWITCHING_PROTOCOLS);
}
