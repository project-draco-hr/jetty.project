{
  StringBuilder request=new StringBuilder(512);
  request.append("GET ");
  if (StringUtil.isBlank(uri.getPath())) {
    request.append("/");
  }
 else {
    request.append(uri.getPath());
  }
  if (StringUtil.isNotBlank(uri.getRawQuery())) {
    request.append("?").append(uri.getRawQuery());
  }
  request.append(" HTTP/1.1\r\n");
  request.append("Host: ").append(uri.getHost());
  if (uri.getPort() > 0) {
    request.append(':').append(uri.getPort());
  }
  request.append("\r\n");
  request.append("Upgrade: websocket\r\n");
  request.append("Connection: Upgrade\r\n");
  request.append("Sec-WebSocket-Key: ").append(key).append("\r\n");
  if (StringUtil.isNotBlank(getOrigin())) {
    request.append("Origin: ").append(getOrigin()).append("\r\n");
  }
  request.append("Sec-WebSocket-Version: 13\r\n");
  Map<String,String> cookies=getCookieMap();
  if ((cookies != null) && (cookies.size() > 0)) {
    for (    String cookie : cookies.keySet()) {
      request.append("Cookie: ");
      request.append(QuotedStringTokenizer.quoteIfNeeded(cookie,COOKIE_DELIM));
      request.append("=");
      request.append(QuotedStringTokenizer.quoteIfNeeded(cookies.get(cookie),COOKIE_DELIM));
      request.append("\r\n");
    }
  }
  request.append("\r\n");
  return request.toString();
}
