{
  if (sslContextFactory != null) {
    SSLEngine engine=newSSLEngine(sslContextFactory,channel);
    final AtomicReference<AsyncEndPoint> sslEndPointRef=new AtomicReference<>();
    SslConnection sslConnection=new SslConnection(engine,endPoint){
      @Override public void onClose(){
        sslEndPointRef.set(null);
        super.onClose();
      }
    }
;
    endPoint.setAsyncConnection(sslConnection);
    AsyncEndPoint sslEndPoint=sslConnection.getAppEndPoint();
    sslEndPointRef.set(sslEndPoint);
    NextProtoNego.put(engine,new NextProtoNego.ServerProvider(){
      @Override public void unsupported(){
        AsyncConnectionFactory connectionFactory=getDefaultAsyncConnectionFactory();
        AsyncEndPoint sslEndPoint=sslEndPointRef.get();
        AsyncConnection connection=connectionFactory.newAsyncConnection(channel,sslEndPoint,SPDYServerConnector.this);
        sslEndPoint.setAsyncConnection(connection);
      }
      @Override public List<String> protocols(){
        return provideProtocols();
      }
      @Override public void protocolSelected(      String protocol){
        AsyncConnectionFactory connectionFactory=getAsyncConnectionFactory(protocol);
        AsyncEndPoint sslEndPoint=sslEndPointRef.get();
        AsyncConnection connection=connectionFactory.newAsyncConnection(channel,sslEndPoint,SPDYServerConnector.this);
        sslEndPoint.setAsyncConnection(connection);
      }
    }
);
    AsyncConnection connection=new EmptyAsyncConnection(sslEndPoint);
    sslEndPoint.setAsyncConnection(connection);
    startHandshake(engine);
    return sslConnection;
  }
 else {
    AsyncConnectionFactory connectionFactory=getDefaultAsyncConnectionFactory();
    AsyncConnection connection=connectionFactory.newAsyncConnection(channel,endPoint,this);
    endPoint.setAsyncConnection(connection);
    return connection;
  }
}
