{
synchronized (_inputQ.lock()) {
    ByteBuffer content=null;
    long start=-1;
    long timeout=-1;
    while (content == null) {
      content=_inputQ.peekUnsafe();
      while (content != null && !content.hasRemaining()) {
        _inputQ.pollUnsafe();
        content=_inputQ.peekUnsafe();
      }
      if (content == null) {
        if (_inputEOF)         return -1;
        if (start < 0) {
          start=System.currentTimeMillis();
          timeout=getMaxIdleTime();
        }
 else {
          long now=System.currentTimeMillis();
          timeout=timeout - (now - start);
          start=now;
        }
        if (timeout <= 0)         throw new SocketTimeoutException(">" + getMaxIdleTime() + "ms");
        try {
          setReadInterested(true);
          _inputQ.wait(timeout);
        }
 catch (        InterruptedException e) {
          LOG.ignore(e);
        }
 finally {
          setReadInterested(false);
        }
        content=_inputQ.peekUnsafe();
      }
    }
    int l=Math.min(len,content.remaining());
    content.get(b,off,l);
    return l;
  }
}
