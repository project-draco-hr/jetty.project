{
  String uri=request.getRequestURI();
  String query=request.getQueryString();
  if (query != null && query.length() > 0)   uri+="?" + query;
  String key=request.getHeader("Sec-WebSocket-Key");
  response.setHeader("Upgrade","WebSocket");
  response.addHeader("Connection","Upgrade");
  response.addHeader("Sec-WebSocket-Accept",hashKey(key));
  if (subprotocol != null)   response.addHeader("Sec-WebSocket-Protocol",subprotocol);
  for (  Extension ext : _extensions)   response.addHeader("Sec-WebSocket-Extensions",ext.getParameterizedName());
  response.sendError(101);
  if (_onFrame != null)   _onFrame.onHandshake(_connection);
  _webSocket.onOpen(_connection);
}
