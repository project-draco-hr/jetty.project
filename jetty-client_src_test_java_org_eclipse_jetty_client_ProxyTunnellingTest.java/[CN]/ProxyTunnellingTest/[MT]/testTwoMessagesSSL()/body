{
  startSSLServer(new ServerHandler());
  startProxy();
  HttpClient httpClient=new HttpClient();
  httpClient.setProxy(new Address("localhost",proxyPort()));
  httpClient.start();
  try {
    ContentExchange exchange=new ContentExchange(true);
    exchange.setMethod(HttpMethod.GET);
    String body="BODY";
    exchange.setURL("https://localhost:" + serverConnector.getLocalPort() + "/echo?body="+ URLEncoder.encode(body,"UTF-8"));
    httpClient.send(exchange);
    assertEquals(HttpExchange.STATUS_COMPLETED,exchange.waitForDone());
    String content=exchange.getResponseContent();
    assertEquals(body,content);
    exchange=new ContentExchange(true);
    exchange.setMethod(HttpMethod.POST);
    exchange.setURL("https://localhost:" + serverConnector.getLocalPort() + "/echo");
    exchange.setRequestHeader(HttpHeader.CONTENT_TYPE,MimeTypes.FORM_ENCODED);
    content="body=" + body;
    exchange.setRequestHeader(HttpHeader.CONTENT_LENGTH,String.valueOf(content.length()));
    exchange.setRequestContent(new ByteArrayBuffer(content,"UTF-8"));
    httpClient.send(exchange);
    assertEquals(HttpExchange.STATUS_COMPLETED,exchange.waitForDone());
    content=exchange.getResponseContent();
    assertEquals(body,content);
  }
  finally {
    httpClient.stop();
  }
}
