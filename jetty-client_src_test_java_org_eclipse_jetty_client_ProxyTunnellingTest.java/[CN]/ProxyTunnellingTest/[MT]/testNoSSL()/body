{
  startServer(new SelectChannelConnector(),new ServerHandler());
  startProxy();
  HttpClient httpClient=new HttpClient();
  httpClient.setProxy(new Address("localhost",proxyConnector.getLocalPort()));
  httpClient.start();
  try {
    ContentExchange exchange=new ContentExchange(true);
    String body="BODY";
    exchange.setURL("http://localhost:" + serverConnector.getLocalPort() + "/echo?body="+ URLEncoder.encode(body,"UTF-8"));
    exchange.setMethod(HttpMethods.GET);
    httpClient.send(exchange);
    assertEquals(HttpExchange.STATUS_COMPLETED,exchange.waitForDone());
    String content=exchange.getResponseContent();
    assertEquals(body,content);
  }
  finally {
    httpClient.stop();
  }
}
