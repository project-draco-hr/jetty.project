{
  String targetId=targetIdRetriever.retrieveTargetId(request);
  String uri=request.getRequestURI();
  String path=uri.substring(request.getServletPath().length());
  String[] segments=path.split("/");
  if (segments.length < 3)   throw new ServletException("Invalid request to " + getClass().getSimpleName() + ": "+ uri);
  String action=segments[2];
  if ("handshake".equals(action))   serviceHandshake(targetId,request,response);
 else   if ("connect".equals(action))   serviceConnect(targetId,request,response);
 else   if ("deliver".equals(action))   serviceDeliver(targetId,request,response);
 else   if ("disconnect".equals(action))   serviceDisconnect(targetId,request,response);
 else   throw new ServletException("Invalid request to " + getClass().getSimpleName() + ": "+ uri);
}
