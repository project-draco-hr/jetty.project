{
  while (_endp.isOpen() && !_parser.isComplete()) {
switch (_parser.parseAvailable()) {
case -1:
      _future.handshakeFailed(new IOException("Incomplete handshake response"));
    return this;
case 0:
  return this;
default :
break;
}
}
if (_error == null) {
if (_accept == null) _error="No Sec-WebSocket-Accept";
 else if (!WebSocketConnectionD13.hashKey(_key).equals(_accept)) _error="Bad Sec-WebSocket-Accept";
 else {
Buffer header=_parser.getHeaderBuffer();
MaskGen maskGen=_future.getMaskGen();
WebSocketConnectionD13 connection=new WebSocketConnectionD13(_future.getWebSocket(),_endp,_buffers,System.currentTimeMillis(),_future.getMaxIdleTime(),_future.getProtocol(),null,10,maskGen);
if (header.hasContent()) connection.fillBuffersFrom(header);
_buffers.returnBuffer(header);
_future.onConnection(connection);
return connection;
}
}
_endp.close();
return this;
}
