{
  _log.debug(getRequestId(request) + " proxying failed",failure);
  if (response.isCommitted()) {
    request.setAttribute("org.eclipse.jetty.server.Response.failure",failure);
    AsyncContext asyncContext=request.getAsyncContext();
    asyncContext.complete();
  }
 else {
    response.resetBuffer();
    if (failure instanceof TimeoutException)     response.setStatus(HttpServletResponse.SC_GATEWAY_TIMEOUT);
 else     response.setStatus(HttpServletResponse.SC_BAD_GATEWAY);
    response.setHeader(HttpHeader.CONNECTION.asString(),HttpHeaderValue.CLOSE.asString());
    AsyncContext asyncContext=request.getAsyncContext();
    asyncContext.complete();
  }
}
